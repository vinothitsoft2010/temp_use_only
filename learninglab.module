<?php

// $Id$
/**
 * @file learninglab.module
 * Learning Lab custom module.
 */
/* * `
 * Implements hook_boot().
 */
function learninglab_boot() {

    // Temporary Fix for memory issue on stage environment.

    ini_set('memory_limit', '512M');
    require_once DRUPAL_ROOT . '/includes/common.inc';
    require_once DRUPAL_ROOT . '/' . './sites/all/modules/learninglab/inc/bootstrap.inc';
    learninglab_bootstrap_ini();

    // Avoid direct access to gsearch page
    if (arg(0) == 'gsearch') {
        drupal_not_found();
    }
}

/**
 * Implements hook_init().
 */
function learninglab_init() {
    /* Restricting old 2 series IDs for remember me option */
    if (isset($_COOKIE['client_remember_me_users_id'])) {
        $id_hcp_c = $_COOKIE['client_remember_me_users_id'];
        $id_hcp = db_query("select external_id from client_remember_me_user_information where id = " . $id_hcp_c)->fetchField();
        if (!empty($id_hcp) && (substr($id_hcp, 0, 1) == "2")) {
            client_remember_me_remove_user($id_hcp_c);
        }
    }
    //drupal_add_js('jQuery(document).ready(function () { jQuery( "ul.main-content-share-print li:empty" ).first().remove(); });', 'inline');
    drupal_add_js('jQuery(document).ready(function () { 
if(jQuery(".header-content ul.main-content-share-print li").first().html()){if(jQuery(".header-content ul.main-content-share-print li").first().html().trim().length == 0){
jQuery(".header-content ul.main-content-share-print li").first().remove();
}}
});', 'inline');

    $field_empty_check_array = explode(",", variable_get('field_jmd_jcr_prep_empty_field_check', ""));

    // Add drupal vars to JS
    _learninglab_add_drupal_vars_to_js();


    $for_multimedia_url = $_SERVER['REQUEST_URI'];
    $for_multimedia_url_arr = explode('/', $for_multimedia_url);
    if ($for_multimedia_url_arr[1] == 'multimedia' && isset($for_multimedia_url_arr[2]) && !empty($for_multimedia_url_arr[2])) {
        $old_multimedia_url = $for_multimedia_url_arr[1] . "/" . $for_multimedia_url_arr[2];
        $node_url = db_query("SELECT alias FROM url_alias WHERE alias LIKE '%" . $old_multimedia_url . "'")->fetchObject()->alias;
        drupal_goto($node_url);
        exit;
    }
    /*     * ********URL redirection for Multimedia page END******* */
    $node = menu_get_object();
    if (isset($node)) {
        if ($node->type == MULTIMEDIA_NODE) {
            drupal_set_title($node->field_mm_title[LANGUAGE_NONE][0]['value']);
        }
    }

    _learninglab_set_breadcrumb();
    if (!isset($_SESSION['allowed_message_display'])) {
        $_SESSION['allowed_message_display'] = TRUE;
    }
}

/**
 * This function implements a method to programatically add drupal variables
 * to the drupal javascript object, so them will be available for the user side
 */
function _learninglab_add_drupal_vars_to_js() {

    // Creates a list of variables to be passed to the js
    $learninglab_js_variables = array(
      /**
       * Modal name for product search
       */
      array(
        'drupal_variable' => 'product_title_modal',
        'js_name' => 'productTitleModal',
        'default_value' => 'Product List',
      ),
      array(
        'drupal_variable' => 'hcp_form_modal_desktop',
        'js_name' => 'hcpFormModalDesktop',
        'default_value' => 'You are now accessing the JanssenMDÂ® Medical Information Database',
      ),
      array(
        'drupal_variable' => 'hcp_form_modal_mobile',
        'js_name' => 'hcpFormModalMobile',
        'default_value' => 'Please Log In',
      ),
      /**
       * Search text to be displayed at the search placeholder
       */
      array(
        'drupal_variable' => 'home_page_search_text_desktop',
        'js_name' => 'homePageSearchTextDesktop',
        'default_value' => 'Enter a word of phrase to search...',
      ),
      array(
        'drupal_variable' => 'home_page_search_text_tablet',
        'js_name' => 'homePageSearchTextTablet',
        'default_value' => 'Enter a word of phrase to search...',
      ),
      array(
        'drupal_variable' => 'home_page_search_text_phone',
        'js_name' => 'homePageSearchTextPhone',
        'default_value' => 'Enter a word of phrase to search...',
      ),
      /**
       * HCP form error messages
       */
      array(
        'drupal_variable' => 'hcp_form_message_first_name',
        'js_name' => 'hcpFormMessageFirstName',
        'default_value' => 'Enter your first name',
      ),
      array(
        'drupal_variable' => 'hcp_form_message_last_name',
        'js_name' => 'hcpFormMessageLastName',
        'default_value' => 'Enter your last name',
      ),
      array(
        'drupal_variable' => 'hcp_form_message_speciality',
        'js_name' => 'hcpFormMessageSpeciality',
        'default_value' => 'Enter your speciality',
      ),
      array(
        'drupal_variable' => 'hcp_form_message_practice_institution',
        'js_name' => 'hcpFormMessagePracticeInstitution',
        'default_value' => 'Enter your practice or institution',
      ),
      array(
        'drupal_variable' => 'hcp_form_message_street_address',
        'js_name' => 'hcpFormMessageStreetAddress',
        'default_value' => 'Enter your street address',
      ),
      array(
        'drupal_variable' => 'hcp_form_message_zip_code',
        'js_name' => 'hcpFormMessage|ipCode',
        'default_value' => 'Enter your zip code',
      ),
      array(
        'drupal_variable' => 'hcp_form_message_healthcare_professional',
        'js_name' => 'hcpFormMessageHealthcareProfessional',
        'default_value' => 'Confirm you are a Healthcare Provider in the US',
      ),
      array(
        'drupal_variable' => 'load_more_gsa_normal_state_button',
        'js_name' => 'loadMoreGsaNormalStateButton',
        'default_value' => 'Load more',
      ),
      array(
        'drupal_variable' => 'load_more_gsa_clicked_state_button',
        'js_name' => 'loadMoreGsaClickedStateButton',
        'default_value' => 'Loading ...',
      ),
      array(
        'drupal_variable' => 'references_modal_topic_page_title',
        'js_name' => 'referencesModalTopicPageTitle',
        'default_value' => 'Full reference',
      ),
      array(
        'drupal_variable' => 'references_modal_search_page_title',
        'js_name' => 'referencesModalSearchPageTitle',
        'default_value' => 'Full reference',
      ),
      array(
        'drupal_variable' => 'back_to_home_modal_text',
        'js_name' => 'backToHomeModalText',
        'default_value' => 'You are now returning to home page.',
      ),
    );

    // Creates the list and retrieves the values
    foreach ($learninglab_js_variables as $list) {
        $var_list[$list['js_name']] = variable_get($list['drupal_variable'], $list['default_value']);
    }

    $current_page = _learninglab_get_current_page();
    // Check now if the current page is a valid product
    $product_context = (in_array($current_page, _learninglab_get_products())) ? $current_page : 'home';

    $hcp_filled = (!empty($_SESSION['HCP']) && $_SESSION['HCP']['is_form_filled'] === TRUE) ? TRUE : FALSE;

    // Populates drupal object
    drupal_add_js(
        array(
      'Projmd' => $var_list,
      'pathToTheme' => url(path_to_theme()),
      'currentProduct' => $product_context,
      'hcpIsFormFilled' => $hcp_filled,
        ), 'setting'
    );
}

function learninglab_node_view_alter(&$build) {

    global $user;
    if ($build['#bundle'] == 'sharepoint_pages') {
        $build['field_html_content'][0]['#markup'] = _learninglab_replace_last_updated($build['field_html_content'][0]['#markup'], $build['#node']);
        $build['field_html_content'][0]['#markup'] = _learninglab_placeholder_replace($build['field_html_content'][0]['#markup']);
        $build['field_html_content'][0]['#markup'] = _learninglab_multimedia_replace($build['field_html_content'][0]['#markup']);
        $build['field_html_content'][0]['#markup'] = _learninglab_replace_reference_anchor_links($build['field_html_content'][0]['#markup']);
    }
}

/**
 * Implements hook_preprocess_html to set classes for <body>
 */
function learninglab_preprocess_html(&$variables) {

    $headers = drupal_get_http_header();
    if (isset($headers['status']) && strpos($headers['status'], '403') !== FALSE) {
        $variables['classes_array'][] = 'error-403';
    }
    elseif (isset($headers['status']) && strpos($headers['status'], '404') !== FALSE) {
        $variables['classes_array'][] = 'error-404';
    }
    elseif (isset($_GET['printerfriendly']) || arg(0) == 'printpdf') {
        $variables['classes_array'][] = 'print-page';
    }

    // Checks if PI Nav block was rendered inside the page and adds a class in the <body>.
    if (isset($variables['page']['sidebar_second'])) {
        foreach ($variables['page']['sidebar_second'] as $block) {
            if (isset($block['#markup']) && strpos($block['#markup'], 'pi-navigation') !== FALSE) {
                $variables['classes_array'][] = 'pi-navigation-active';
            }
        }
    }

    $current_product = _learninglab_get_current_page();
    if (preg_match('/^\/' . $current_product . '\/?$/i', request_uri())) {
        $variables['classes_array'][] = 'product-home';
    }
}

/**
 * Implements the placeholder replacement for product pages
 * All other replacements regarding that page should be done here
 *
 */
function _learninglab_placeholder_replace($text) {

    //[D7 OK]
    $pdf_link = array(
      'type' => 'printpdf',
      'query' => array('pdf-version' => ''),
      'title' => 'PDF',
      'path' => 'printpdf/' . drupal_get_path_alias($_GET['q']),
      'placeholder' => '@share@'
    );

    $print_link = array(
      'type' => 'print',
      'query' => array('printerfriendly' => ''),
      'title' => 'Print',
      'path' => $_GET['q'],
      'placeholder' => '@printer_friendly@'
    );

    if (isset($_GET['disclaimer'])) {
        $pdf_link['query']['disclaimer'] = '1';
        $print_link['query']['disclaimer'] = '1';
    }

    $text = _learninglab_replace_print_pdf_links($text, $pdf_link);
    return _learninglab_replace_print_pdf_links($text, $print_link);
}

function _learninglab_replace_print_pdf_links($text, $link) {
    //[D7 OK]
    $url_options = array(
      'absolute' => TRUE,
      'query' => $link['query'],
    );

    $link_options = array(
      'attributes' => array(
        'class' => $link['type'],
        'title' => $link['title'],
        'rel' => 'canonical',
        'target' => '_blank',
    ));

    /* Removed print according to ticket JMDR-2115 */
    if ($link['type'] == 'print') {
        return str_ireplace($link['placeholder'], '', $text);
    }
    if (strpos($text, "<li>@share@@printer_friendly@</li>") !== false) {
        $text = str_ireplace("<li>@share@@printer_friendly@</li>", "@share@@printer_friendly@", $text);
    }
    $html = '<li class="' . $link['type'] . '">' .
        ($link['type'] == 'print' ? '<span class="glyphicon glyphicon-print"> </span>' : '') .
        l(t($link['title']), url($link['path'], $url_options), $link_options) .
        '</li>';

    return str_ireplace($link['placeholder'], $html, $text);
}

function _learninglab_replace_images_url($text) {
    //[D7 OK]
    // Creates the default website link
    global $theme;
    $base_path = url('<front>', array('absolute' => TRUE));
    $resource_path = $base_path . variable_get('file_public_path', conf_path());
    $node_id = explode('/', $_GET['q']);
    $node_id = array_pop($node_id);
    $img_href = $base_path . 'image/' . $node_id;

    $text = str_replace(array('@files_path@', '@device@/', '@img_href@', '@theme_path@'), array($resource_path, '', $img_href, path_to_theme()), $text);

    return $text;
}

function _learninglab_replace_last_updated($text, $node) {
    if (empty($node) || !isset($node->field_last_reviewed[LANGUAGE_NONE][0]['value'])) {
        return $text;
    }

    $last_reviewed = '';
    if ($node->field_last_reviewed[LANGUAGE_NONE][0]['value'] > 0) {
        $last_reviewed = DATE_LAST_UPDATED_TEXT;
        $last_reviewed .= date('m/d/Y', $node->field_last_reviewed[LANGUAGE_NONE][0]['value']);
    }

    return str_replace('@last_reviewed@', $last_reviewed, $text);
}

/**
 * Implements hook_preprocess_page.
 */
function learninglab_preprocess_page(&$variables) {
    global $user;

    /* Processing logic for fetching Product Name in SP pages */
    if ((isset($variables['node']->type)) && ($variables['node']->type == "sharepoint_pages")) {
        $parent_product_nid = $variables['node']->field_vv_product[LANGUAGE_NONE][0]['nid'];
        $parent_node_obj = node_load($parent_product_nid);
        $variables['product_name'] = $parent_node_obj->field_product_name[LANGUAGE_NONE][0]['value'];
        $variables['generic_name'] = $parent_node_obj->field_generic_name[LANGUAGE_NONE][0]['value'];
    }

    $base_path = url('<front>', array('absolute' => TRUE));
    $product = _learninglab_get_current_page();

    // Add node links for hook_menu announcement/%/%
    if (arg(0) == 'announcement' && arg(1) != '' && arg(2) != '' && $user->uid != 0) {
        $menu_local_tasks = _learninglab_menu_local_tasks();
        $variables['tabs'] = array(
          '#theme' => 'menu_local_tasks',
          '#primary' => $menu_local_tasks['tabs']['output'],
          '#secondary' => '',
        );
    }

    // Add back to top button for all pages, except on front page
    if (!drupal_is_front_page() && !empty($variables['node'])) {
        $variables['back_to_top'] = _learninglab_pi_navigation_back_to_top($variables['node']);
    }

    if ((isset($variables['node']->type)) && ($variables['node']->type == MULTIMEDIA_NODE)) {
        drupal_add_http_header('Status', '404 Not Found');
        drupal_set_title($variables['node']->field_mm_title[LANGUAGE_NONE][0]['value']);
    }

    // Show ISI footer if page is not browseable
    if (!_learninglab_display_disclaimer() && !empty($variables['node'])) {

        // Check now if is home and hcp is filled
        $prouct_home = _learninglab_is_product_home($variables['node']->nid);

        // If we have a product home we show ISI
        if ($prouct_home) {
            $variables['isi_footer'] = _learninglab_isi_display();
        } // Else we only show ISI if node is sharepoint page and HCP isn't filled
        else if (($variables['node']->type == SHAREPOINT_CONTENT_TYPE_PAGES && $_SESSION['HCP']['is_form_filled'] !== TRUE)) {
            $variables['isi_footer'] = _learninglab_isi_display();
        }
    }

    if ((isset($variables['node']->type)) && ($variables['node']->type == SHAREPOINT_CONTENT_TYPE_PAGES)) {


        $variables['test_sp_page'] = 'I\'m here';

        // Get the meta tags from the node
        if (isset($variables['node']->field_package_info[LANGUAGE_NONE][0]['value'])) {
            $package_info = json_decode($variables['node']->field_package_info[LANGUAGE_NONE][0]['value'], TRUE);

            $element = array(
              '#tag' => 'meta',
              '#attributes' => array(
                'name' => 'sharepoint-id',
                'content' => $package_info['topic']['sharepoint_id'],
              ),
            );
            drupal_add_html_head($element, 'sharepoint-id');

            $element = array(
              '#tag' => 'meta',
              '#attributes' => array(
                'name' => 'version',
                'content' => $package_info['topic']['version'],
              ),
            );
            drupal_add_html_head($element, 'version');
        }
        $element = array(
          '#tag' => 'meta',
          '#attributes' => array(
            'name' => 'package-id',
            'content' => $variables['node']->nid,
          ),
        );
        drupal_add_html_head($element, 'package-id');

        // Get the page title from header content
        $page_title = array();
        preg_match("'<title>(.*?)</title>'si", $variables['node']->field_header[LANGUAGE_NONE][0]['value'], $page_title);
        drupal_set_title($page_title[1]);

        // Get the custom meta from the header
        $custom_meta = array(
          '#type' => 'markup',
          '#markup' => preg_replace("'<title>(.*?)</title>'si", '', $variables['node']->field_header[LANGUAGE_NONE][0]['value']),
        );

        drupal_add_html_head($custom_meta, 'custom_meta');

        if (!(strpos(current_path(), 'services/json/publish') !== false)) {

            _learninglab_update_expired_content($variables);
        }
        /*
          if (!_learninglab_display_disclaimer()) {
          _learninglab_remove_all_elements_by_xpath($variables['node']->field_html_content[0]['value'], "//div[@class='disclaimer']");
          }
         */
        _learninglab_multimedia_replace($variables['node']->field_html_content[LANGUAGE_NONE][0]['value']);

        //remove the show/hide references on print friendly version.
        if (isset($_GET['printerfriendly']) || arg(0) == 'print' || arg(0) == 'printpdf') {
            _learninglab_remove_all_elements_by_xpath($variables['node']->field_html_content[LANGUAGE_NONE][0]['value'], "//div[@class='options-button']");

            /*             * ***Qr code removal.****** */

            if (($library = libraries_load('phpqrcode')) && !empty($library['loaded'])) {
                $variables['header_print'] = _learninglab_header_print($variables['node']);
                //_learninglab_change_slide_deck_to_qrcode($variables['node']);
                _learninglab_change_brightcove_to_qrcode($variables['node']);
            }
            else {
                watchdog('library', 'Could not load phpqrcode library');
            }

            /*             * ***End.****** */
            $variables['node']->field_html_content[LANGUAGE_NONE][0]['value'] = _process_tag($variables['node']->field_html_content[LANGUAGE_NONE][0]['value'], array('pre'), '_remove_extra_spaces');

            if (arg(0) == 'printpdf') {
                $variables['page']['footer'] = _learninglab_get_website_header_footer('footer');
            }
        }

        drupal_add_js(array('learninglab' =>
          array('current_content_browsable' => _learninglab_is_content_browsable($variables['node']),
            'last_content_browsable' => _learnlab_last_content_browsable())
            ), 'setting');

        //If the page that going to show is a full image page, then show the original image size.

        $print_options = 'printerfriendly';

        $variables['node']->field_html_content[LANGUAGE_NONE][0]['value'] = _learninglab_placeholder_replace($variables['node']->field_html_content[LANGUAGE_NONE][0]['value']);

        _learninglab_insert_url_token($variables['node']->field_html_content[LANGUAGE_NONE][0]['value']);

        $variables['node']->field_html_content[LANGUAGE_NONE][0]['value'] = _learninglab_replace_images_url($variables['node']->field_html_content[LANGUAGE_NONE][0]['value']);


        $variables['node']->field_html_content[LANGUAGE_NONE][0]['value'] = str_replace('@domain_target_channel@/', $base_path, $variables['node']->field_html_content[LANGUAGE_NONE][0]['value']);
        $variables['node']->field_html_content[LANGUAGE_NONE][0]['value'] = _learninglab_replace_last_updated($variables['node']->field_html_content[LANGUAGE_NONE][0]['value'], $variables['node']);
    }

    if (arg(2) != 'edit' && arg(4) != 'edit') {
        $product_info = _learninglab_get_product($product);
        if ($product_info) {
            $base_path = url('<front>', array('absolute' => TRUE));
            $product_pi_link = $base_path . $product_info->field_prescribing_link[LANGUAGE_NONE][0]['value'];
        }
        else {
            $product_pi_link = '#';
        }

        if (isset($variables['node']->type) && ($variables['node']->type == SHAREPOINT_CONTENT_TYPE_PAGES)) {
            $variables['node']->field_html_content[LANGUAGE_NONE][0]['value'] = str_replace('@product_pi_link@', $product_pi_link, $variables['node']->field_html_content[LANGUAGE_NONE][0]['value']);
        }
        else if (isset($variables['node']->type) && ($variables['node']->type == ANNOUNCEMENT_CONTENT_TYPE_PAGES)) {
            $variables['node']->field_announc_content[LANGUAGE_NONE][0]['value'] = str_replace('@product_pi_link@', $product_pi_link, $variables['node']->field_announc_content[LANGUAGE_NONE][0]['value']);
        }
        else if (isset($variables['node']->type) && ($variables['node']->type == EVENT_CONTENT_TYPE_PAGES)) {
            $variables['node']->field_event_content[LANGUAGE_NONE][0]['value'] = str_replace('@product_pi_link@', $product_pi_link, $variables['node']->field_event_content[LANGUAGE_NONE][0]['value']);
        }

        if (isset($variables['content'])) {
            $variables['content'] = str_replace('@product_pi_link@', $product_pi_link, $variables['content']);
        }
    }

    if ((
        ($user_search = _learninglab_is_user_watching_pdf()) ||
        ($user_search = _learninglab_is_user_searching()) ||
        ($user_search = _learninglab_is_user_watching_announcements_events_news()) ||
        ($user_search = _learninglab_is_user_watching_quick_links())
        ) &&
        (!isset($variables['node']->field_product_full_name[LANGUAGE_NONE][0]['value']))
    ) {

        $product = _learninglab_get_product($user_search['product']);
        if (!empty($product)) {

            $variables['product_name'] = $product->field_product_name[LANGUAGE_NONE][0]['value'];
            $variables['generic_name'] = $product->field_generic_name[LANGUAGE_NONE][0]['value'];
            //$variables['node']->field_product_full_name[LANGUAGE_NONE][0]['value'] = $product->field_product_name[LANGUAGE_NONE][0]['value'] . ' (' . $product->field_generic_name[LANGUAGE_NONE][0]['value'] . ')';
        }
    }

    // If we have a page not found....
    $status = drupal_get_http_header("status");
    if ($status == '404 Not Found') {
        $current_product = _learninglab_get_current_page();
        $product = _learninglab_get_product($current_product);
        if (!empty($product)) {
            $variables['product_name'] = $product->field_product_name[LANGUAGE_NONE][0]['value'];
            $variables['generic_name'] = $product->field_generic_name[LANGUAGE_NONE][0]['value'];
            //$variables['node']->field_product_full_name[LANGUAGE_NONE][0]['value'] = $product->field_product_name[LANGUAGE_NONE][0]['value'] . ' (' . $product->field_generic_name[LANGUAGE_NONE][0]['value'] . ')';
        }
    }
}

/**
 * Implements hook_preprocess_print.
 */
function learninglab_preprocess_print(&$variables) {

    if (isset($_GET['printerfriendly']) || arg(0) == 'print' || arg(0) == 'printpdf') {
        _learninglab_remove_all_elements_by_xpath($variables['node']->field_html_content[LANGUAGE_NONE][0]['value'], "//div[@class='options-button']");
        /*         * ***Qr code removal.****** */
        if (($library = libraries_load('phpqrcode')) && !empty($library['loaded'])) {
            $variables['header_print'] = _learninglab_header_print($variables['node']);
            //_learninglab_change_slide_deck_to_qrcode($variables['node']);
            _learninglab_change_brightcove_to_qrcode($variables['node']);
        }
        else {
            watchdog('library', 'Could not load phpqrcode library');
        }

        /*         * ***End.****** */
        $variables['node']->field_html_content[LANGUAGE_NONE][0]['value'];
        $variables['node']->field_html_content[LANGUAGE_NONE][0]['value'] = _process_tag($variables['node']->field_html_content[LANGUAGE_NONE][0]['value'], array('pre'), '_remove_extra_spaces');
    }
}

/**
 * Implements hook_preprocess_node.
 */
function learninglab_preprocess_node(&$variables) {
    $variables['back_to_top'] = _learninglab_pi_navigation_back_to_top($variables['node']);
    //$variables['newbody'] = str_replace('suppose', 'new string', $variables['field_html_content'][0]['value']);
}

/**
 * Function to mark last page browsable
 */
function _learnlab_last_content_browsable() {
    // check if last
    $path = $_SERVER['HTTP_REFERER'];
    $refer_node = menu_get_object("node", 1, $path);
    return _learninglab_is_content_browsable($refer_node);
}

/**
 * Function to verify if the disclaimer or the ISI will appear
 */
function _learninglab_disclaimer() {

    //Don't track ajax requests
    if ((!empty($_SERVER['HTTP_X_REQUESTED_WITH']) && strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) == 'xmlhttprequest') || (isset($_POST) && is_array($_POST) && (count($_POST) > 0))) {
        return;
    }

    $is_searching = _learninglab_is_user_searching();

    /* D7 NOK MedicalInformationArea will be implemented
      if ($is_searching || MedicalInformationArea::get_status() === TRUE) {}
     */
    if ($is_searching) {
        _learninglab_display_disclaimer(TRUE);
        return;
    }

    $search_results = (isset($_COOKIE['gsa_result'])) ? unserialize($_COOKIE['gsa_result']) : array();
    if (!is_array($search_results)) {
        $search_results = array();
    }

    $current_page = request_uri();
    $has_parameter = strpos($current_page, '?');
    if ($has_parameter !== FALSE) {
        $current_page = substr($current_page, 0, $has_parameter);
    }

    if (!in_array($current_page, $search_results)) { // Case when the page was accessed directly
        setcookie('gsa_result', '', REQUEST_TIME - 3600, '/');

        $node = menu_get_object();
        $is_browseable = !empty($node) ? _learninglab_is_content_browsable($node) : FALSE;

        if ($is_browseable) {
            _learninglab_display_disclaimer(FALSE);
        }
        else {
            _learninglab_display_disclaimer(TRUE);
        }
    }
    else { // When cames from a search
        if (isset($_GET['disclaimer'])) {
            
        }
        else {
            _learninglab_display_disclaimer(FALSE);
        }
    }
}

/**
 * Store the result of "_learninglab_disclaimer()" to be used in the validations of ISI and Disclaimer in the content
 * @param $rule
 *  - boolen to set the value
 *  - nothing to return the stored value
 */
function _learninglab_display_disclaimer($rule = NULL) {
    //[D7 OK]
    if (isset($_GET['pdf-disclaimer'])) {
        $disclaimer = ($_GET['pdf-disclaimer'] == 'true') ? TRUE : FALSE;
        return $disclaimer;
    }

    static $display;


    if ($rule === NULL) {
        return $display;
    }

    $display = $rule;
}

function _learninglab_inactive_url_redirect() {
    if (arg(0) == 'forward') {
        drupal_not_found();
    }
}

function _learninglab_is_content_browsable($node) {

    if (isset($node->nid)) {
        $node_browsable = _learninglab_get_taxonomy_value_from_node($node->nid, "browseable");
        if (!empty($node_browsable) && is_array($node_browsable)) {
            if ($node_browsable[0] == "yes") {
                return TRUE;
            }
            else {
                return FALSE;
            }
        }
    }
    return TRUE;
}

/**
 * Verify if function "hash_hmac" exists, if not try to use the alternative function "hashHMAC"
 */
if (!function_exists('hash_hmac')) {

    function hash_hmac($algo, $data, $key) {
        $hash = hashHMAC('md5', $data, $key);
        return $hash;
    }

}

/**
 * Verify if function "block_flush_caches" exists, if not, use the default function "block_flush_caches" from Drupal 6 API
 */
function _learninglab_block_flush_caches() {
    if (!function_exists('block_flush_caches')) {
        // Rehash blocks for active themes. We don't use list_themes() here,
        // because if MAINTENANCE_MODE is defined it skips reading the database,
        // and we can't tell which themes are active.
        $result = db_query("SELECT name FROM {system} WHERE type = :type AND status = :status", array(':type' => 'theme', ':status' => 1));
        while ($theme = $result->fetchField()) {
            _block_rehash($theme);
        }
    }
    else {
        block_flush_caches();
    }
    cache_clear_all();
}

/*
 * Implementation of hook_cron().
 */

/**
 * @todo Please document this function.
 * @see http://drupal.org/node/1354
 */
function learninglab_cron() {
    $start = 213000; /* 09:30PM EST */
    $end = 233000; /* 11:30PM EST */
    $currentTime = (int) date('Gis');

    if ($currentTime > $start && $currentTime < $end) {
        watchdog("CRON", "Cron executed for CIA, Eureka");

        // Call function to send the audit log search result email (CIA Email)
        _learninglab_audit_log_mailer('CRON'); /* COMMENTED BY SUVASISH FOR SOLR CRON CHECK */

        // Call function to send the audit log to Eureka
        _learninglab_eureka_cron(); /* COMMENTED BY SUVASISH FOR SOLR CRON CHECK */
    }
    else {
        watchdog("CRON", "Cron executed for Report");
        // Generate Export report and send to MBox
        _expdata_select(); /* COMMENTED BY SUVASISH FOR SOLR CRON CHECK */
        //Remove 5days old csv reports from local directory
        report_file_remove();   /* COMMENTED BY SUVASISH FOR SOLR CRON CHECK */
    }
}

/** * Implementation of hook_cron_queue_info() */
function learninglab_cron_queue_info() {
    $queues = array();
    $queues['process_auditlog_files'] = array(
      'worker callback' => '_learninglab_eureka_process_auditlog_files_queue',
      'time' => 900
    );
    return $queues;
}

/*
 * Implementation of hook_menu().
 */

/**
 * @todo Please document this function.
 * @see http://drupal.org/node/1354
 */
function learninglab_menu() {

    // Settings by admin interface.
    // http://api.drupal.org/api/function/hook_menu/6
    // Override favicon.ico to forward to the theme's shortcut icon.
    $items['favicon.ico'] = array(
      'page callback' => 'favicon_shortcut_icon',
      'access callback' => TRUE,
      'type' => MENU_CALLBACK,
    );
    // Settings by admin interface.
    $items['admin/set_default_settings'] = array(
      'page callback' => 'learninglab_set_default_settings',
      'access arguments' => array('administer site configuration'),
      'type' => MENU_CALLBACK,
      'file' => 'inc/default_settings.inc',
    );

    $items['admin_menu/settings/Projmd'] = array(
      'title' => t('[JanssenMD&reg;] Project General Settings'),
      'page callback' => 'drupal_get_form',
      'page arguments' => array('learninglab_settings_form'),
      'access arguments' => array('administer site configuration'),
      'type' => MENU_NORMAL_ITEM,
    );

    $items['admin_menu/settings/Projmd/keywords'] = array(
      'title' => t('Products Keywords Search Settings'),
      'page callback' => 'drupal_get_form',
      'page arguments' => array('learninglab_keywords_settings_form'),
      'access arguments' => array('access administration menu'),
      'type' => MENU_NORMAL_ITEM,
    );

    $items['admin_menu/settings/Projmd/general'] = array(
      'title' => t('Generate Configuration'),
      'description' => t('General Project Configuration.'),
      'access arguments' => array('administer site configuration'),
      'weight' => 0,
      'type' => MENU_DEFAULT_LOCAL_TASK,
    );

    $items['admin_menu/settings/Projmd/admin'] = array(
      'title' => t('Administrator Settings'),
      'page callback' => 'drupal_get_form',
      'page arguments' => array('_learninglab_admin_settings_form'),
      'access arguments' => array('administer site configuration'),
      'type' => MENU_NORMAL_ITEM,
    );

    $items['admin_menu/settings/Projmd/api-settings'] = array(
      'title' => t('Jmd Api Settings'),
      'page callback' => 'drupal_get_form',
      'page arguments' => array('_learninglab_api_settings_form'),
      'access arguments' => array('administer site configuration'),
      'type' => MENU_NORMAL_ITEM,
    );

    $items['admin_menu/settings/Projmd/synonym-settings'] = array(
      'title' => t('Add Synonym'),
      'page callback' => 'drupal_get_form',
      'page arguments' => array('_synonym_settings_form'),
      'access arguments' => array('administer site configuration'),
      'type' => MENU_NORMAL_ITEM,
    );
    $items['admin_menu/settings/Projmd/synonym-list'] = array(
      'title' => t('Jmd Synonym Settings'),
      'page callback' => '_get_synonym_list',
      'access arguments' => array('administer site configuration'),
      'type' => MENU_NORMAL_ITEM,
    );

    $items['admin_menu/settings/Projmd/ta-settings'] = array(
      'title' => t('Jmd TA Settings'),
      'page callback' => '_learninglab_ta_settings_page',
      //	'page arguments' => array('_learninglab_ta_settings_form'),
      'access arguments' => array('administer site configuration'),
      'type' => MENU_NORMAL_ITEM,
    );

    $items['admin_menu/settings/Projmd/ta-settings/delete/%'] = array(
      'title' => t('Delete TA'),
      'page callback' => 'drupal_get_form',
      'page arguments' => array('ta_delete_confirm', 5),
      'access arguments' => array('administer site configuration'),
      'type' => MENU_NORMAL_ITEM,
    );

    $items['admin_menu/settings/Projmd/ta-settings/create'] = array(
      'title' => t('Create TA'),
      'page callback' => 'drupal_get_form',
      'page arguments' => array('ta_craete'),
      'access arguments' => array('administer site configuration'),
      'type' => MENU_NORMAL_ITEM,
    );

    $items['admin_menu/settings/Projmd/maintenance'] = array(
      'title' => t('Maintenance'),
      'description' => t('Maintenance.'),
      'page callback' => 'drupal_get_form',
      'page arguments' => array('_learninglab_form_maintenance'),
      'access arguments' => array('administer site configuration'),
      'weight' => 2,
      'type' => MENU_CALLBACK,
    );

    $items['direct_access_page'] = array(
      'page callback' => '_learninglab_content_page',
      'access arguments' => array('access content'),
      'type' => MENU_CALLBACK,
    );

    $items['direct_access_form'] = array(
      'title' => '[Tweak] Direct access to custom form',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('learninglab_custom_form'),
      'access arguments' => array('access content'),
      'type' => MENU_CALLBACK,
    );

    $items['search/solr/%/%'] = array(
      'page callback' => 'ext_apache_solr_search',
      'access arguments' => array('access content'),
      'type' => MENU_CALLBACK,
    );

    $items['learninglab_get_products_az'] = array(
      'title' => '_learninglab_get_products_a_to_z',
      'page callback' => '_learninglab_get_products_a_to_z',
      'access arguments' => array('access content'),
      'weight' => 6,
      'type' => MENU_LOCAL_TASK,
    );

    $items['get_all_therapeutic_area'] = array(
      'title' => 'Get all Therapeutic Area',
      'page callback' => '_learninglab_get_all_therapeutic_area',
      'access arguments' => array('access content'),
      'type' => MENU_LOCAL_TASK,
    );

    $items['get_therapeutic_area/%'] = array(
      'title' => 'Get all Therapeutic Area',
      'page callback' => '_learninglab_get_therapeutic_area',
      'access arguments' => array('access content'),
      'type' => MENU_LOCAL_TASK,
    );

    $items['get_tooltip_content'] = array(
      'title' => 'Get the tooltip content',
      'page callback' => '_learninglab_get_tooltip_content',
      'access arguments' => array('access content'),
      'type' => MENU_CALLBACK,
    );

    /*  $items['admin_menu/config/google_appliance_feed'] = array(
      'title' => 'GSA feed settings',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('_learninglab_gsa_feed_settings'),
      'access arguments' => array('administer site configuration'),
      'type' => MENU_CALLBACK,
      ); */

    /* $items['admin_menu/config/google_appliance_feed/settings'] = array(
      'title' => 'Settings',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('_learninglab_gsa_feed_settings'),
      'access arguments' => array('administer site configuration'),
      'type' => MENU_CALLBACK,
      ); */

    /*  $items['admin_menu/config/google_appliance_feed/update'] = array(
      'title' => 'Update',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('_learninglab_gsa_feed_update'),
      'access arguments' => array('administer site configuration'),
      'type' => MENU_CALLBACK,
      ); */

    $items['qrcode_generator'] = array(
      'title' => 'QR Code Generator',
      'page callback' => '_learninglab_qrcode_generator',
      'access arguments' => array('access content'),
      'type' => MENU_CALLBACK,
    );


    // PDF aliases.
    $items['pdf/%/%'] = array(
      'title' => t('PDF Access link'),
      'page arguments' => array(1, 2),
      'page callback' => '_learninglab_pdf_access',
      'access arguments' => array('access content'),
      'type' => MENU_CALLBACK,
    );

    // File aliases
    $items['file/%node'] = array(
      'title' => t('File Access link'),
      'page arguments' => array(1),
      'page callback' => '_learninglab_file_access',
      'access arguments' => array('access content'),
      //'access callback' => 'node_access',
      //'access arguments' => array('view', 1),
      'type' => MENU_CALLBACK,
    );

    $items['hcp_filled'] = array(
      'title' => t('HCP Form Filled'),
      'page callback' => '_learninglab_is_hcp_form_filled',
      'page arguments' => array(2),
      'access arguments' => array('access content'),
      'type' => MENU_CALLBACK,
    );

    // External Search Result (Redirect and AuditLog)
    $items[EXTERNAL_URL_PREFIX . '/%/%sresult'] = array(
      'title' => t('File Access link'),
      'page callback' => '_learninglab_external_search_result',
      'page arguments' => array(2),
      'access arguments' => array('access content'),
      'type' => MENU_CALLBACK,
    );

    $items['admin_menu/quick_information'] = array(
      'title' => t('Quick Information'),
      'page callback' => '_learninglab_quick_links',
      'access arguments' => array('content admin'),
      'type' => MENU_CALLBACK,
    );

    $items['admin_menu/quick_information/%'] = array(
      'title' => t('Quick Information'),
      'page arguments' => array(2),
      'page callback' => '_learninglab_quick_links',
      'access arguments' => array('content admin'),
      'type' => MENU_CALLBACK,
    );

    $items['admin_menu/save_quick_information'] = array(
      'title' => t('Save Quick Information'),
      'page callback' => '_learninglab_save_quick_link',
      'access arguments' => array('content admin'),
      'type' => MENU_CALLBACK,
    );

    $items['admin_menu/save_quick_information_order'] = array(
      'title' => 'Save Quick Information Order',
      'page callback' => '_learninglab_save_quick_link_order',
      'access arguments' => array('content admin'),
      'type' => MENU_CALLBACK,
    );

    $items['quick-information/%'] = array(
      'title' => 'Quick Information',
      'page arguments' => array(1),
      'page callback' => '_learninglab_get_all_quick_links',
      'access arguments' => array('access content'),
    );

    $items['image/%/%'] = array(
      'page callback' => '_learninglab_preview_image_content',
      'access arguments' => array('access content'),
      'type' => MENU_CALLBACK,
    );


    $items['announcement/%/%'] = array(
      'page callback' => '_learninglab_announcement_content',
      'access arguments' => array('access content'),
      'type' => MENU_CALLBACK,
    );

    $items['admin_menu/settings/Projmd/footer-msg'] = array(
      'title' => t('Copyright and Last Updated settings'),
      'description' => t('Copyright and Last Updated settings'),
      'page callback' => 'drupal_get_form',
      'page arguments' => array('_learninglab_footer_msg_settings'),
      'access arguments' => array('content admin'),
      'weight' => 1,
      'type' => MENU_CALLBACK,
    );

    $items['contactus'] = array(
      'page callback' => FALSE,
    );

    $items['hcp'] = array(
      'title' => t(''),
      'description' => '',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('_learninglab_contactus_list'),
      'access arguments' => array('access content'),
    );

    $items['logout_hcp'] = array(
      'title' => t(''),
      'description' => '',
      'page callback' => '_learninglab_logout_hcp',
      'access arguments' => array('access content'),
    );

    /* @disablechat
      $items['start_chat'] = array(
      'title' => t('Live Chat'),
      'page callback' => '_learninglab_start_chat',
      'access arguments' => array('access content'),
      ); */

    $items['admin/reports/audit-log'] = array(
      'title' => t('Audit Log Report'),
      'page callback' => 'drupal_get_form',
      'page arguments' => array('_learninglab_audit_log_form'),
      'access arguments' => array('content admin'),
      'type' => MENU_NORMAL_ITEM,
    );

    $items['jmd_content/audit_log'] = array(
      'title' => t('Audit Log Report'),
      'page callback' => 'drupal_get_form',
      'page arguments' => array('_learninglab_audit_log_form'),
      'access arguments' => array('content admin'),
      'type' => MENU_NORMAL_ITEM,
    );

    $items['jmd_content/breadcrumb'] = array(
      'title' => t('Breadcrumb configuration'),
      'page callback' => 'drupal_get_form',
      'page arguments' => array('_learninglab_breadcrumb_form'),
      'access arguments' => array('content admin'),
      'type' => MENU_NORMAL_ITEM,
    );

    /*
      $items['admin/audit-log/progress-status'] = array(
      'title' => t('Audit Log progress status'),
      'page callback' => '_learninglab_audit_log_progress_status',
      'access arguments' => array('access content'),
      'type' => MENU_CALLBACK,
      ); */

    $items['jmd_content/audit-log/progress-status'] = array(
      'title' => t('Audit Log progress status'),
      'page callback' => '_learninglab_audit_log_progress_status',
      'access arguments' => array('access content'),
      'type' => MENU_CALLBACK,
    );

    /*
      $items['admin/process-audit-log'] = array(
      'title' => t('Progress Audit Log'),
      'page callback' => '_learninglab_progress_audit_log',
      'access arguments' => array('access content'),
      'type' => MENU_CALLBACK,
      );
     */

    $items['jmd_content/process-audit-log'] = array(
      'title' => t('Progress Audit Log'),
      'page callback' => '_learninglab_progress_audit_log',
      'access arguments' => array('access content'),
      'type' => MENU_CALLBACK,
    );

    /* $items['admin/audit-log/get-file'] = array(
      'title' => t('Audit Log get file'),
      'page callback' => '_learninglab_get_audit_log_html',
      'access arguments' => array('access content'),
      'type' => MENU_CALLBACK,
      ); */

    $items['jmd_content/audit-log/get-file'] = array(
      'title' => t('Audit Log get file'),
      'page callback' => '_learninglab_get_audit_log_html',
      'access arguments' => array('access content'),
      'type' => MENU_CALLBACK,
    );

    //download audit log
    $items['get/audit-log'] = array(
      'title' => t('Download Audit Log file'),
      'page callback' => '_learninglab_download_audit_log',
      'access arguments' => array('access reports'),
      'type' => MENU_CALLBACK,
    );

    $items['audit-log/%'] = array(
      'title' => 'Reports',
      'page callback' => '_learninglab_get_audit_log_report',
      'page arguments' => array(1),
      'access arguments' => array('access reports'),
      'type' => MENU_CALLBACK,
    );

    $items['download/%'] = array(
      'title' => 'Download uploaded file',
      'page callback' => '_learninglab_download_uploaded_file',
      'page arguments' => array(1),
      'access arguments' => array('access content'),
      'type' => MENU_CALLBACK,
    );

    // Slide deck alias
    $items['slidedeck/%'] = array(
      'title' => t('Slide deck alias'),
      'page arguments' => array(1),
      'page callback' => '_learninglab_slidedeck_download',
      'access arguments' => array('access content'),
      'type' => MENU_CALLBACK,
    );

    // upload file
    $items['upload-file'] = array(
      'title' => t('IMCE upload file'),
      'page callback' => '_learninglab_redirect_to_imce_upload',
      'access arguments' => array('access imce menu'),
      'type' => MENU_CALLBACK,
    );
    //--------------------------

    $items['admin_menu/side_bar'] = array(
      'title' => t('Side Bar'),
      'page callback' => '_learninglab_sidebar',
      'access arguments' => array('content admin'),
      'type' => MENU_CALLBACK,
    );

    $items['widget_config/side_bar'] = array(
      'title' => t('Side Bar'),
      'page callback' => '_learninglab_widget_cofig_sidebar',
      'access arguments' => array('content admin'),
      'type' => MENU_CALLBACK,
    );

    $items['admin_menu/save_blocks'] = array(
      'title' => t('Save Blocks'),
      'page callback' => '_learninglab_save_blocks',
      'access arguments' => array('content admin'),
      'type' => MENU_CALLBACK,
    );

    $items['admin_menu/save_widget_order'] = array(
      'title' => t('Save Widget Order'),
      'page callback' => '_learninglab_save_widget_order',
      'access arguments' => array('content admin'),
      'type' => MENU_CALLBACK,
    );

    $items['admin_menu/settings/events_announcement'] = array(
      'title' => t('Settings'),
      'page callback' => 'drupal_get_form',
      'page arguments' => array('_learninglab_news_announc_settings_form'),
      'access arguments' => array('content admin'),
      'type' => MENU_NORMAL_ITEM,
    );

    $items['admin/process-medical-dictionaly'] = array(
      'title' => t('Progress Medical Dictionaly'),
      'page callback' => '_learninglab_insert_to_med_dictionary',
      'access arguments' => array('access content'),
      'type' => MENU_CALLBACK,
    );

    $items['admin_menu/gsa_search_limit'] = array(
      'title' => t('SOLR Search Limit/Search Cache'),
      'page callback' => 'drupal_get_form',
      'page arguments' => array('_learninglab_gsa_search_limit_form'),
      'access arguments' => array('access administration menu'),
      'type' => MENU_NORMAL_ITEM,
    );

    $items['admin_menu/reports/audit-log-mailer-settings'] = array(
      'title' => t('Audit Log Mailer Settings'),
      'page callback' => 'drupal_get_form',
      'page arguments' => array('_learninglab_audit_log_mailer_settings_form'),
      'access arguments' => array('content admin'),
      'type' => MENU_NORMAL_ITEM,
      'file' => 'inc/audit_log_mailer_form.inc',
    );

    $items['all-announcements/%'] = array(
      'title callback' => '_learninglab_viewl_all_announcements_title_callback',
      'title arguments' => array(1),
      'page callback' => '_learninglab_view_all_announcements',
      'page arguments' => array(1),
      'access arguments' => array('access content'),
      'type' => MENU_CALLBACK,
      'file' => 'inc/widget.inc',
    );

    // Tools Form
    $items['tools/view'] = array(
      'title' => t('Access a Tool'),
      'description' => t('Access a Tool'),
      'page callback' => '_learninglab_hecor_tools_view',
      'access arguments' => array('access content'),
      'type' => MENU_NORMAL_ITEM,
      'file' => 'inc/hecor_tools.inc',
    );

    $items['tool-access-form/%'] = array(
      'title' => t('Tool Access Form'),
      'description' => t('Tool Access Form'),
      'page callback' => 'drupal_get_form',
      'page arguments' => array('_learninglab_hecor_tools_access_form_page'),
      'access arguments' => array('access content'),
      'type' => MENU_NORMAL_ITEM,
      'file' => 'inc/hecor_tools.inc',
    );

    $items['tools/thank-you'] = array(
      'title' => t('Access a Tool'),
      'description' => t('Access a Tool'),
      'page callback' => '_learninglab_tools_thankyou',
      'access arguments' => array('access content'),
      'type' => MENU_NORMAL_ITEM,
      'file' => 'inc/hecor_tools.inc',
    );

    $items['admin_menu/run-cron'] = array(
      'title' => 'Run cron',
      'page callback' => '_learninglab_run_cron',
      'access callback' => '_learninglab_check_run_cron',
      'type' => MENU_CALLBACK,
    );

    $items['admin_menu/run-cron'] = array(
      'title' => 'Run cron',
      'page callback' => '_learninglab_run_cron',
      'access callback' => '_learninglab_check_run_cron',
      'type' => MENU_CALLBACK,
    );

    // [D7_MODULE_ADAPTATION]
    // _learninglab_hecor_tools_menu($items);


    /* Custom content_admin/ approver menu */
    _learninglab_custom_content_menu($items);

    _learninglab_custom_ajax_menu_callback($items);

    $items['admin_menu/create_master_file'] = array(
      'title' => 'Creating the master file',
      'page callback' => '_learninglab_create_eureka_file',
      //'page arguments' => array(2),
      'access arguments' => array('administer site configuration'),
      'type' => MENU_CALLBACK,
    );

    $items['contactus-temp-data-import/%'] = array(
      'title' => 'PI Migration : Temp Data Import',
      'page callback' => '_learninglab_contactus_temp_data_import',
      'page arguments' => array(1),
      'access arguments' => array('administer site configuration'),
      'type' => MENU_CALLBACK,
      'file' => 'inc/contactus_temp_data_import.inc',
    );

    $items['contactus-data-import'] = array(
      'title' => 'PI Migration : Data Import',
      'page callback' => '_learninglab_contactus_data_import',
      'access arguments' => array('administer site configuration'),
      'type' => MENU_CALLBACK,
      'file' => 'inc/contactus_data_import.inc',
    );
    $items['expusers'] = array(
      'page callback' => '_expdata_select',
      'access arguments' => array('access content'),
    );
    $items['admin/reports/expdata'] = array(
      'title' => t('Export Data'),
      'page callback' => '_expdata_select',
      'type' => MENU_NORMAL_ITEM,
      'access arguments' => array('administer site configuration'),
    );

    return $items;
}

function get_taxonomy_term_name_from_tid($tid) {
    return db_query('SELECT name FROM {taxonomy_term_data} WHERE tid = :tid', array(':tid' => $tid))->fetchField();
}

function _expdata_select() {
    $mbox_file_name_prefix = variable_get('file_name_prefix', '');
    $filemktime = date('Ymd_H-i-s', time());
    $filename = $mbox_file_name_prefix . "_Documents_Report_" . $filemktime . ".csv";
    $filenamesummary = $mbox_file_name_prefix . "_Documents_DataFeedSummary_" . $filemktime . ".csv";


    $results = db_query("SELECT nid FROM `node` WHERE `type` = 'sharepoint_pages' AND `status` = 1", array());
    $csvdata = 'Title,Dita_content_type,Searchable,Browseable,Sharepoint_ID,Product,Product_Full_Name,Canonical_Url,Component_Type,Total_References,Package_Info,Expired_Date,Last_Reviewed,Slide_Deck,Binary_File_Path,Category,Subcategory,JCR_MANAGED,CE_Effort,VV_Document_Type,VV_Document_Subtype,VV_Status,Publishing_Channel,Priority,VV_Document_Title,VV_Last_updated_date,VV_Header_Subject_Terms,Reason_for_change,VV_Comments,VV_Assigned_To,VV_Content_Source,VV_JCR_RECEIVED_DATE,VV_CA_START_DATE,VV_SUSPEND_ON_DATE,VV_SUSPEND_OFF_DATE,VV_QC_START_DATE,VV_QC_COMPLETE_DATE,VV_PUBLISHED_DATE,FIELD_VV_READY_FOR_QC_DATE,Publishing_Status,Article_Modified_Time' . PHP_EOL;
    foreach ($results as $record) {
        $node_data = node_load($record->nid);
        //print_r($node_data);
        if (!empty($node_data->field_product[LANGUAGE_NONE][0]['value'])) {
            $product_mapp_name = $node_data->field_product[LANGUAGE_NONE][0]['value'];
            $product_nid = db_query("SELECT nid FROM `node` WHERE `title` = '" . $product_mapp_name . "' ")->fetchField();
            $product_full_name = db_query("SELECT field_product_name_value FROM `field_data_field_product_name` WHERE `entity_id` = '" . $product_nid . "' ")->fetchField();
        }
        if ($node_data->field_jcr_managed[LANGUAGE_NONE][0]['value'] == 0) {
            $pack_info = json_decode($node_data->field_package_info[LANGUAGE_NONE][0]['value']);
            $field_package_info = $pack_info->{"vault id"};
            $last_updated_data = date("Y-m-d H:i:s", strtotime($pack_info->{"version creation date"}));
        }
        else {
            $field_package_info = $node_data->field_package_info[LANGUAGE_NONE][0]['value'];
            $last_updated_data = (!empty($node_data->field_vv_last_updated_date[LANGUAGE_NONE][0]['value']) ? date("Y-m-d  H:i:s", strtotime($node_data->field_vv_last_updated_date[LANGUAGE_NONE][0]['value'])) : '');
        }
        /* publishd_time date time config (Format change) */
        $field_publishd_time = (!empty($node_data->field_published_time[LANGUAGE_NONE][0]['value']) ? $node_data->field_published_time[LANGUAGE_NONE][0]['value'] : '');
        #$field_publishd_time = $node_data->field_published_time[LANGUAGE_NONE][0]['value'];
        $field_publishd_time_ar = array();
        $field_publishd_time_1 = '';
        $field_publishd_time_2 = '';
        $field_publishd_time_val = '';
        if (!empty($field_publishd_time)) {
            $field_publishd_time_ar = explode("_", $field_publishd_time);
            $field_publishd_time_1 = $field_publishd_time_ar[0];
            $field_publishd_time_2 = str_replace('-', ':', $field_publishd_time_ar[1]);
            $field_publishd_time_val = $field_publishd_time_1 . " " . $field_publishd_time_2;
        }
        /* field_slide_deck VAL config */
        $slide_deck_val = '';
        if (!empty($node_data->field_slide_deck[LANGUAGE_NONE][0]['value'])) {
            $slide_deck_val = (($node_data->field_slide_deck[LANGUAGE_NONE][0]['value'] == 0) ? "Not have a slide-deck" : (($node_data->field_slide_deck[LANGUAGE_NONE][0]['value'] == 1) ? "have a slide-deck" : "N/A"));
        }
        /* field_ce_effort VAL config */
        $ce_effort_val = '';
        if (!empty($node_data->field_ce_effort[LANGUAGE_NONE][0]['value'])) {
            $ce_effort_val = (($node_data->field_ce_effort[LANGUAGE_NONE][0]['value'] == 1) ? "High" : (($node_data->field_ce_effort[LANGUAGE_NONE][0]['value'] == 2) ? "Medium" : (($node_data->field_ce_effort[LANGUAGE_NONE][0]['value'] == 3) ? "Low" : "None")));
        }

        $row = array();
        $row[] = '"' . $node_data->title . '"';
        $row[] = (!empty($node_data->field_dita_content_type[LANGUAGE_NONE][0]['tid']) ? get_taxonomy_term_name_from_tid($node_data->field_dita_content_type[LANGUAGE_NONE][0]['tid']) : '');
        $row[] = (!empty($node_data->field_searchable[LANGUAGE_NONE][0]['tid']) ? get_taxonomy_term_name_from_tid($node_data->field_searchable[LANGUAGE_NONE][0]['tid']) : '');
        $row[] = (!empty($node_data->field_browseable[LANGUAGE_NONE][0]['tid']) ? get_taxonomy_term_name_from_tid($node_data->field_browseable[LANGUAGE_NONE][0]['tid']) : '');
        $row[] = (!empty($node_data->field_sharepoint_id[LANGUAGE_NONE][0]['value']) ? '"' . $node_data->field_sharepoint_id[LANGUAGE_NONE][0]['value'] . '"' : '');
        $row[] = (!empty($node_data->field_product[LANGUAGE_NONE][0]['value']) ? '"' . $node_data->field_product[LANGUAGE_NONE][0]['value'] . '"' : '');
        $row[] = htmlentities($product_full_name);
        $row[] = (!empty($node_data->field_canonical_url[LANGUAGE_NONE][0]['value']) ? '"' . $node_data->field_canonical_url[LANGUAGE_NONE][0]['value'] . '"' : '');
        $row[] = (!empty($node_data->field_component_type[LANGUAGE_NONE][0]['value']) ? '"' . $node_data->field_component_type[LANGUAGE_NONE][0]['value'] . '"' : '');
        $row[] = (!empty($node_data->field_total_references[LANGUAGE_NONE][0]['value']) ? '"' . $node_data->field_total_references[LANGUAGE_NONE][0]['value'] . '"' : '');
        $row[] = $field_package_info;
        $row[] = (!empty($node_data->field_expired_date[LANGUAGE_NONE][0]['value']) ? $node_data->field_expired_date[LANGUAGE_NONE][0]['value'] : '');
        $row[] = (!empty($node_data->field_last_reviewed[LANGUAGE_NONE][0]['value']) ? date("Y-m-d  H:i:s", $node_data->field_last_reviewed[LANGUAGE_NONE][0]['value']) : '');
        $row[] = $slide_deck_val;
        $row[] = (!empty($node_data->field_binary_file_path[LANGUAGE_NONE][0]['value']) ? $node_data->field_binary_file_path[LANGUAGE_NONE][0]['value'] : '');
        $row[] = (!empty($node_data->field_category[LANGUAGE_NONE][0]['value']) ? '"' . $node_data->field_category[LANGUAGE_NONE][0]['value'] . '"' : '');
        $row[] = (!empty($node_data->field_subcategory[LANGUAGE_NONE][0]['value']) ? '"' . $node_data->field_subcategory[LANGUAGE_NONE][0]['value'] . '"' : '');
        $row[] = (($node_data->field_jcr_managed[LANGUAGE_NONE][0]['value'] == 0) ? "NO" : "YES");
        $row[] = $ce_effort_val;
        $row[] = (!empty($node_data->field_vv_doc_type[LANGUAGE_NONE][0]['value']) ? $node_data->field_vv_doc_type[LANGUAGE_NONE][0]['value'] : '');
        $row[] = (!empty($node_data->field_vv_doc_subtype[LANGUAGE_NONE][0]['value']) ? $node_data->field_vv_doc_subtype[LANGUAGE_NONE][0]['value'] : '');
        $row[] = (!empty($node_data->field_vv_status[LANGUAGE_NONE][0]['value']) ? $node_data->field_vv_status[LANGUAGE_NONE][0]['value'] : '');
        $row[] = (!empty($node_data->field_publishing_channel[LANGUAGE_NONE][0]['value']) ? $node_data->field_publishing_channel[LANGUAGE_NONE][0]['value'] : '');
        $row[] = (!empty($node_data->field_priority[LANGUAGE_NONE][0]['value']) ? $node_data->field_priority[LANGUAGE_NONE][0]['value'] : '');
        $row[] = '"' . $node_data->field_vv_doc_title[LANGUAGE_NONE][0]['value'] . '"';
        $row[] = $last_updated_data;
        $row[] = (!empty($node_data->field_vv_header_subject_terms[LANGUAGE_NONE][0]['value']) ? $node_data->field_vv_header_subject_terms[LANGUAGE_NONE][0]['value'] : '');
        #$row[] = '"'.$node_data->field_reason_for_change[LANGUAGE_NONE][0]['value'].'"';
        $row[] = (!empty($node_data->field_reason_for_change[LANGUAGE_NONE][0]['value']) ? '"' . $node_data->field_reason_for_change[LANGUAGE_NONE][0]['value'] . '"' : '');
        $row[] = (!empty($node_data->field_vv_comments[LANGUAGE_NONE][0]['value']) ? '"' . $node_data->field_vv_comments[LANGUAGE_NONE][0]['value'] . '"' : '');
        $row[] = (!empty($node_data->field_vv_assigned_to[LANGUAGE_NONE][0]['value']) ? $node_data->field_vv_assigned_to[LANGUAGE_NONE][0]['value'] : '');
        $row[] = (!empty($node_data->field_vv_content_source[LANGUAGE_NONE][0]['value']) ? $node_data->field_vv_content_source[LANGUAGE_NONE][0]['value'] : '');
        $row[] = (!empty($node_data->field_vv_jcr_receive[LANGUAGE_NONE][0]['value']) ? date("Y-m-d  H:i:s", strtotime($node_data->field_vv_jcr_receive[LANGUAGE_NONE][0]['value'])) : '');
        $row[] = (!empty($node_data->field_vv_ca_start_date[LANGUAGE_NONE][0]['value']) ? date("Y-m-d  H:i:s", strtotime($node_data->field_vv_ca_start_date[LANGUAGE_NONE][0]['value'])) : '');
        $row[] = (!empty($node_data->field_vv_suspend_on_date[LANGUAGE_NONE][0]['value']) ? date("Y-m-d  H:i:s", strtotime($node_data->field_vv_suspend_on_date[LANGUAGE_NONE][0]['value'])) : '');
        $row[] = (!empty($node_data->field_vv_suspend_off_date[LANGUAGE_NONE][0]['value']) ? date("Y-m-d  H:i:s", strtotime($node_data->field_vv_suspend_off_date[LANGUAGE_NONE][0]['value'])) : '');
        $row[] = (!empty($node_data->field_vv_qc_start_date[LANGUAGE_NONE][0]['value']) ? date("Y-m-d  H:i:s", strtotime($node_data->field_vv_qc_start_date[LANGUAGE_NONE][0]['value'])) : '');
        $row[] = (!empty($node_data->field_vv_qc_complete_date[LANGUAGE_NONE][0]['value']) ? date("Y-m-d  H:i:s", strtotime($node_data->field_vv_qc_complete_date[LANGUAGE_NONE][0]['value'])) : '');
        $row[] = (!empty($node_data->field_vv_published_date[LANGUAGE_NONE][0]['value']) ? date("Y-m-d  H:i:s", strtotime($node_data->field_vv_published_date[LANGUAGE_NONE][0]['value'])) : '');
        $row[] = (!empty($node_data->field_vv_ready_for_qc_date[LANGUAGE_NONE][0]['value']) ? date("Y-m-d  H:i:s", strtotime($node_data->field_vv_ready_for_qc_date[LANGUAGE_NONE][0]['value'])) : '');
        $row[] = (!empty($node_data->field_publish_state[LANGUAGE_NONE][0]['value']) ? $node_data->field_publish_state[LANGUAGE_NONE][0]['value'] : '');
        $row[] = $field_publishd_time_val;
        $i++;
        $csvdata .= implode(',', $row) . PHP_EOL;
    }

    global $base_url;
    $file_directory_path = drupal_realpath('public://');
    $local_csv_path = variable_get('local_csv_path', 'mboxreport');
    $csv_handler = fopen($file_directory_path . "/" . $local_csv_path . "/" . $filename, 'w');

    fwrite($csv_handler, $csvdata);
    fclose($csv_handler);
    #watchdog('expdata_cron', 'LOCAL FILEPATH :' .$file_directory_path."/".$local_csv_path."/".$filename);
    /* csvdatasummary import */
    $rowsummary = array();
    $csvdatasummary = 'File_Name,Rows_Include_Header,File_Size_Bytes,Delimiter,Text_Qualifier,Row_Delimiter,File_CutOff_Date,Data_Cutoff_Date,Seq_ID_If_Splitted,Regular/Adhoc' . PHP_EOL;
    $rowsummary[] = $filename;
    $rowsummary[] = $i;
    $rowsummary[] = filesize($file_directory_path . "/" . $local_csv_path . "/" . $filename);
    $rowsummary[] = '","';
    $rowsummary[] = '""""';
    $rowsummary[] = 'CRLF';
    $rowsummary[] = date('Y-m-d  H:i:s');
    $rowsummary[] = date('Y-m-d  H:i:s');
    $rowsummary[] = '1';
    $rowsummary[] = 'Regular';

    $csvdatasummary .= implode(',', $rowsummary) . PHP_EOL;

    $csv_handler_summary = fopen($file_directory_path . "/" . $local_csv_path . "/" . $filenamesummary, 'w');
    fwrite($csv_handler_summary, $csvdatasummary);
    //fputcsv($csv_handler_summary, array("admin","title","category","Test","admin","title","category","Test","Test"));
    fclose($csv_handler_summary);
    /* csvdatasummary import */

    $report_move_status = mbox_file_move($filename);
    if ($report_move_status == 1) {
        #watchdog('expdata_cron', 'TRANSFERED SUCCESSFULLY:' . $filename . 'TRANSFERED report_move_status:' .$report_move_status);
        $filenamesummary_move_status = mbox_file_move($filenamesummary);
        if ($filenamesummary_move_status == 1) {
            watchdog('expdata_cron', 'TRANSFERED SUCCESSFULLY:' . $filenamesummary . 'TRANSFERED report_move_status:' . $filenamesummary_move_status);
        }
        else {
            watchdog('expdata_cron', 'SFTP TRANSFER FAIL. Error:' . $filenamesummary);
        }
    }
    else {
        watchdog('expdata_cron', 'SFTP TRANSFER FAIL. Error:' . $filename);
    }
}

function mbox_file_move($filename) {
    $file_directory_path = drupal_realpath('public://');
    $ftp_url = variable_get('mbox_url', 'mboxnaprd.client.com');
    $ftp_username = variable_get('mbox_username', 'jmd');
    $ftp_password = variable_get('mbox_password', '********');
    $mbox_dir = variable_get('mbox_dir', 'WCPITUS_CDE_WCPITUS_CDE_JMDPUB_Q');
    $local_csv_path = variable_get('local_csv_path', 'mboxcsvpub');


    $file_path_str = $file_directory_path . "/" . $local_csv_path . "/" . $filename;
    if (file_exists($file_path_str)) {
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, 'https://' . $ftp_url . '/' . $mbox_dir . '/' . $filename);
        curl_setopt($ch, CURLOPT_USERPWD, $ftp_username . ':' . $ftp_password);
        curl_setopt($ch, CURLOPT_PUT, 1);
        $fh_res = fopen($file_path_str, 'r');
        curl_setopt($ch, CURLOPT_INFILE, $fh_res);
        curl_setopt($ch, CURLOPT_INFILESIZE, filesize($file_path_str));
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($ch, CURLOPT_BINARYTRANSFER, TRUE);
        $curl_response_res = curl_exec($ch);
        $errors = curl_error($ch);
        curl_close($ch);
        fclose($fh_res);

        if (!empty($errors)) {
            watchdog('expdata_cron', 'SFTP TRANSFER FAIL. Error:' . $errors . 'FOR FILE NAME' . $filename);
            return 0;
        }
        else {
            watchdog('expdata_cron', 'TRANSFERED SUCCESSFULLY:' . $filename);
            return 1;
        }
    }
    else {
        watchdog('expdata_cron', 'File doesn\'t exist to move to MBox');
    }
}

function report_file_remove() {
    $file_directory_path = drupal_realpath('public://');
    $local_csv_path = variable_get('local_csv_path', 'mboxcsvpub');
    $mboxdir = $file_directory_path . "/" . $local_csv_path;
    $mboxfiles = scandir($mboxdir, 1);
    foreach ($mboxfiles as $val) {
        $filename = $mboxdir . '/' . $val;
        if ((file_exists($filename)) && $filename != '.' && $filename != '..') {
            if (filemtime($filename) < strtotime(' -5 day')) {
                if (file_exists($filename)) {
                    unlink($filename);
                    watchdog('expdata_cron', 'DELETED SUCCESSFULLY:' . $filename);
                }
            }
        }
    }
}

function array_to_xml($data, &$xml_data) {
    foreach ($data as $key => $value) {
        if (is_numeric($key)) {
            $key = 'data' . $key; //dealing with <0/>..<n/> issues
        }
        if (is_array($value)) {
            $subnode = $xml_data->addChild($key);
            array_to_xml($value, $subnode);
        }
        else {
            $xml_data->addChild("$key", htmlspecialchars("$value"));
        }
    }
}

function _learninglab_check_run_cron() {
    global $user;
    if (user_access('run cron') && (isset($user->uid) && ($user->uid != 1))) {
        return TRUE;
    }
    return FALSE;
}

function _learninglab_run_cron() {
    if (drupal_cron_run()) {
        drupal_set_message(t('Cron ran successfully.'));
    }
    else {
        drupal_set_message(t('Cron run failed.'), 'error');
    }

    drupal_goto($_SERVER['HTTP_REFERER']);
}

/**
 *
 * Title callback to get title for View All Announcements hook_menu
 */
function _learninglab_viewl_all_announcements_title_callback($current_product = '') {
    if ($current_product != 'home') {
        return variable_get('announc_header_text_product', 'Announcements');
    }
    else {
        return variable_get('announc_header_text', 'Announcements');
    }
}

/**
 * Menu callback; forwards to the favicon.
 */
function favicon_shortcut_icon() {
    init_theme();
    $favicon = theme_get_setting('favicon', TRUE);
    if (empty($favicon)) {
        drupal_not_found();
    }
    else {
        header('Location: ' . $favicon);
    }
}

/**
 * Function to return all the selected products associated with category
 * @return serialized string with selected products
 */
function _learninglab_selectedproducts($categoryId) {
    $sql = "SELECT REPLACE(GROUP_CONCAT(product_name),'\"','') as product_name FROM {aggregator_category_product} WHERE cid = %d GROUP BY cid";
    $db_result = db_query("SELECT REPLACE(GROUP_CONCAT(product_name),'\"','') as product_name FROM {aggregator_category_product} WHERE cid = :cid GROUP BY cid", array(':cid' => $categoryId));

    while ($item = db_fetch_object($db_result)) {
        $selected_products = $item->product_name;
    }
    return str_replace(" ", "", $selected_products);
}

function _learninglab_widget_cofig_sidebar() {
    drupal_goto('admin_menu/side_bar');
}

/**
 * Callback function to control side bar
 * @return array theme containing the side bar page
 */
function _learninglab_sidebar() {
    //Enable aggregator blocks
    _learninglab_block_flush_caches();
    // TODO Please convert this statement to the D7 database API syntax.
    /* db_query("UPDATE blocks b SET status = 1, region = 'sidebar', visibility = 2 where module = 'aggregator' AND delta LIKE 'category%' AND theme != 'garland'") */
    NULL;

    //Catch the delta from all empty pages in aggregators blcks
    $categories_blocks = db_query("SELECT b.delta, c.title FROM {block} b INNER JOIN {aggregator_category} c ON c.cid = SUBSTRING(b.delta, 10) WHERE b.module = :b.module AND b.delta LIKE 'category-%%' AND b.pages = :b.pages GROUP BY b.delta", array(':b.module' => 'aggregator', ':b.pages' => ''));
    while ($delta = db_fetch_object($categories_blocks)) {

        $delta_id = substr($delta->delta, 9);

        // Get the selected pages to insert in the blocks page visibility
        $sql = "SELECT product_name FROM {aggregator_category_product} WHERE cid = %d";
        $category_products = db_fetch_array(db_query("SELECT product_name FROM {aggregator_category_product} WHERE cid = :cid", array(':cid' => $delta_id)));
        $selected_products = implode("','", $category_products);


        $php_code = "if ((request_uri() == '/admin_menu/side_bar') ||
                   ((variable_get(\"block_b-category-{$delta_id}\", 'enable') == 'enable') &&
                    (in_array(_learninglab_get_current_page(),array($selected_products))))) {
                return TRUE;
              }";

        $sql = "UPDATE {block} SET pages = '<?php %s ?>' , theme = 'learninglab_web_theme' WHERE delta = 'category-%s'";
        // TODO Please review the conversion of this statement to the D7 database API syntax.
        /* db_query($sql, $php_code, $delta_id) */
        /* learninglab_web_theme doesn't exists */
        /* db_update('block')
          ->fields(array(
          'pages' => $php_code,
          'theme' =>  'learninglab_web_theme',
          ))
          ->condition('delta', $delta_id)
          ->execute(); */
    }

    return theme('side_bar', array('side_bar' => array()));
}

function _learninglab_save_blocks() {
    $blocks = substr($_REQUEST['blocks'], 0, -1);
    $order = explode("|", $blocks);
    $list = array();

    for ($i = 0; $i < count($order); $i++) {
        $block_details = explode("_", $order[$i]);
        $block = $block_details[0];
        $weight = $block_details[1];
        $enable_disable = $block_details[2];
        $box = $block_details[3];

        array_push($list, $block);

        // TODO Please review the conversion of this statement to the D7 database API syntax.
        /* db_query("UPDATE {block} SET weight = %d, cache = %d  WHERE bid = %d", $weight, 1, $block) */
        db_update('block')
            ->fields(array(
              'weight' => $weight,
              'cache' => 1,
            ))
            ->condition('bid', $block)
            ->execute();
        variable_set("block_" . $box, $enable_disable);
        _learninglab_block_flush_caches();
    }

    //Checks the log flag
    if (variable_get('sidebar_order_updated_debug', FALSE)) {
        watchdog('Sidebar Change', var_export(array($GLOBALS['user']->name => $GLOBALS['user']->mail, 'ListOrder: ' => var_export($list, TRUE)), TRUE));
    }

    return drupal_json_output(array("msg" => "The operation has been saved."));
}

function _learninglab_save_widget_order() {
    if (isset($_POST['weight']) && (is_array($_POST['weight']))) {
        foreach ($_POST['weight'] as $nid => $weight) {
            $node = node_load($nid);
            $node->field_weight[0]['value'] = $weight;
            node_save($node);
        }
    }

    drupal_set_message(t('The operation has been saved.'), 'status');
    drupal_goto($_SERVER['HTTP_REFERER']);
}

function _learninglab_slidedeck_download($slidedeck_filename) {
    /* [D7_MODULE_ADAPTATION]
      $file_path = file_directory_path() . "/restrict/Decks/Slides/" . $slidedeck_filename;

      if (!file_exists($file_path)) {
      drupal_not_found();
      return FALSE;
      }

      drupal_add_http_header('Last-Modified', gmdate('D,d M YH:i:s') . ' GMT');
      drupal_add_http_header('Cache-Control', 'private, max-age=0, must-reavalidate');
      drupal_add_http_header('Content-Type', 'application/octet-stream; charset=utf-8');
      drupal_add_http_header('Pragma', 'private');
      drupal_add_http_header('Content-Disposition', 'attachment; filename="' . $slidedeck_filename . '"');
      drupal_add_http_header('Content-Transfer-Encoding', 'binary');

      readfile($file_path);
      exit;
     *
     */
}

function _learninglab_download_uploaded_file($file) {
    $file_path = variable_get('imce_file_upload_path', '') . $file;

    if (!file_exists($file_path)) {
        //We need to enforce to mi-exception cause we cannot verify if user is on MI-AREA
        //and has a product
        drupal_goto('<front>', array('query' => array('mi-exception' => '')));
        exit;
    }

    drupal_add_http_header('Last-Modified', gmdate('D,d M YH:i:s') . ' GMT');
    drupal_add_http_header('Cache-Control', 'private, max-age=0, must-revalidate');
    drupal_add_http_header('Content-Type', 'application/octet-stream; charset=utf-8');
    drupal_add_http_header('Pragma', 'public');
    drupal_add_http_header('Content-Disposition', 'attachment; filename="' . $file . '"');
    drupal_add_http_header('Content-Transfer-Encoding', 'binary');
    drupal_add_http_header('Content-Length', filesize($file_path));

    readfile($file_path);
    exit;
}

/**
 * Function to detect if is the stock browser of android
 */
function _learninglab_is_android_native_browser() {
    $device = (function_exists('mobile_tools_is_mobile_device')) ? mobile_tools_is_mobile_device() : array('type' => 'desktop');
    if ($device['type'] == 'mobile') {
        if (array_key_exists('HTTP_USER_AGENT', $_SERVER)) {
            $user_agent = $_SERVER['HTTP_USER_AGENT'];
            if ((FALSE !== stripos($user_agent, 'android')) && (FALSE !== stripos($user_agent, 'applewebkit'))) {
                return TRUE;
            }
        }
    }

    return FALSE;
}

/**
 * Function for pdf files access.
 */
function _learninglab_pdf_access($product, $pdf, $path = null, $is_pdf = TRUE) {
    $pdf_filename = $pdf;

    $my_path = variable_get('file_public_path', conf_path() . '/files');

    if (!$path) {
        $path = $my_path . "/" . $product . "/product-info/" . $pdf;
    }

    if (!file_exists($path)) {

        $dir = $my_path . "/" . $product . "/product-info";
        $result = file_scan_directory($dir, '/.*\.pdf$/');

        //@todo: REMOVE DEBUG.
        watchdog("Directory Scan", var_export($result, TRUE));
        watchdog("PDF Not Found", $path);

        drupal_not_found();
        exit;
    }

    if (ob_get_length()) {
        $ob_content = ob_get_contents();

        // Ignore empty spaces
        if (trim($ob_content)) {
            print('Some data has already been output, can\'t send PDF file');
            die;
        }
    }

    if (php_sapi_name() != 'cli') {
        if (_learninglab_is_android_native_browser()) {
            header('Content-Description: File Transfer');
            header('Content-Type: application/octet-stream');
            header('Content-Disposition: attachment; filename="' . $pdf_filename . '"');
            header('Content-Transfer-Encoding: binary');
            header('Expires: 0');
            header('Cache-Control: must-revalidate, post-check=0, pre-check=0');
            header('Pragma: public');
            header('Content-Length: ' . filesize($path));
            ob_clean();
            flush();
            readfile($path);
            exit;
        }

        if ($is_pdf) {
            header('Content-Type: application/pdf');
        }
        else {
            header('Content-Type: application/octet-stream');
        }

        if (headers_sent()) {
            print('Some data has already been output, can\'t send file');
            die;
        }
        header('Content-Length: ' . filesize($path));
        header('Content-Disposition: inline; filename="' . $pdf_filename . '"');
        header('Cache-Control: private, max-age=0, must-revalidate');
        header('Pragma: public');
        header("Content-Transfer-Encoding: binary");
        if (file_exists($path)) {
            header('Expires: 0');
            ob_clean();
            flush();
            readfile($path);
            exit;
        }
    }
}

function _learninglab_file_access($node = null) {

    $file_path = $node->field_binary_file_path[LANGUAGE_NONE][0]['value'];
    $file_path = str_replace('sites/default/files', _learninglab_file_directory_path(), $file_path);

    if (file_exists($file_path)) {
        // If is a PDF file, use the PDF handler
        $is_pdf = _learninglab_is_pdf($file_path);
        $file_name = basename($file_path);

        if ($_SESSION['HCP']['display'] === TRUE) {
            // If PDF isn't brownseable should render the node page so we can display the HCP Form
            if ($render_array = _learninglab_render_current_product_page()) {
                return $render_array;
            }
            drupal_not_found();
        }
        else {
            // renders the PDF file
            _learninglab_pdf_access(null, $file_name, $file_path, $is_pdf, TRUE);
        }
    }
    else {
        watchdog('file.access', 'File not found: ' . $file_path);
        drupal_not_found();
    }
}

function _learninglab_create_folder_structure($resource_path, $folder = FALSE) {
    //[D7 OK]
    if ($folder == FALSE) {
        $folder_path = dirname($resource_path);
    }
    else {
        $folder_path = $resource_path;
    }

    if (!is_dir($folder_path)) {
        mkdir($folder_path, 0755, TRUE);
    }
}

function _learninglab_qrcode_generator() {
    /* [D7_MODULE_ADAPTATION]
      $file = file_directory_path() . '/restrict/qrcode/' . $_REQUEST['tiny'] . '.png';
      _learninglab_create_folder_structure($file);
      return QRcode::png($_REQUEST['tiny_url'], $file, $level = QR_ECLEVEL_L, $size = 4, $margin = 0, TRUE);
     *
     */
}

function _learninglab_workflow_menu_links(&$links) {

    $root_path = '<root>';
    $workflow_path = 'workflow';

    /* Workflow Options start */
    $links[] = array(
      'title' => 'Workflow',
      'path' => $workflow_path,
      'weight' => 20,
      'class' => 'first-level',
    );

    $links[] = array(
      'title' => '"Draft" Content',
      'path' => 'content/draft',
      'options' => array('extra class' => 'noremove'),
      'weight' => 10,
      'class' => 'second-level',
    );

    $links[] = array(
      'title' => '"Rejected" Content',
      'path' => 'content/rejected',
      'options' => array('extra class' => 'noremove'),
      'weight' => 20,
      'class' => 'second-level',
    );

    $links[] = array(
      'title' => '"Under Approval" Content',
      'path' => 'content/under-approval',
      'options' => array('extra class' => 'noremove'),
      'weight' => 30,
      'class' => 'second-level',
    );

    $links[] = array(
      'title' => '"Approved" Content',
      'path' => 'content/approved',
      'options' => array('extra class' => 'noremove'),
      'weight' => 40,
      'class' => 'second-level',
    );

    $links[] = array(
      'title' => '"Published" Content',
      'path' => 'content/published',
      'options' => array('extra class' => 'noremove'),
      'weight' => 50,
      'class' => 'second-level',
    );
    /*
      $links[] = array(
      'title' => 'Create content',
      'path' => 'create-content',
      'options' => array('extra class' => 'noremove'),
      'weight' => 60,
      'class' => 'second-level',
      );
     */
    $links[] = array(
      'title' => '"Page" Content',
      'path' => 'workflow/pages',
      'options' => array('extra class' => 'noremove'),
      'weight' => 60,
      'class' => 'second-level',
    );
    /* Workflow Options end */
}

function _learninglab_get_tooltip_content() {
    $db_result = db_query("SELECT node.nid AS nid, node.vid AS vid, p.field_tooltip_content_value as tooltip_content, p.field_tooltip_title_value as tooltip_title
                 FROM {content_type_product_page} p
                 INNER JOIN {node} ON node.nid = p.nid AND node.vid = p.vid
                 WHERE node.title = :node.title;", array(':node.title' => $_REQUEST['product_title']));
    $node = db_fetch_object($db_result);

    $tool_tip_title = variable_get('what_am_i_searching_tool_tip_title', '');
    $tool_tip_content = variable_get('what_am_i_searching_tool_tip_content', '');

    if ($node) {
        if (!empty($node->tooltip_content)) {
            $tool_tip_content = $node->tooltip_content;
        }
        if (!empty($node->tooltip_title)) {
            $tool_tip_title = $node->tooltip_title;
        }
    }


    if (variable_get('learninglab_product_search_tooltip_debug', FALSE)) {
        watchdog('tooltip_log', 'Tooltip Title: ' . check_plain($tool_tip_title) . '<br/>Tooltip content: ' . check_plain($tool_tip_content));
    }

    return drupal_json_output(array("tooltip_content" => $tool_tip_content, "tooltip_title" => $tool_tip_title));
}

/*
 * Get the title for all products
 */

function _learninglab_get_products($limit = FALSE, $generic_name = FALSE, $nid = FALSE) {
    // [D7 OK]
    static $db_result_map = array();
    $formated_products = $products = array();

    if (($limit === FALSE) || ($limit < 0)) {
        $limit = 0;
    }

    if (!isset($db_result_map[$limit])) {
        $sql = "SELECT
              node.nid,
              node.title,
              prd.field_generic_name_value AS generic_name
            FROM
              {node}
            INNER JOIN
              {field_data_field_generic_name} prd ON (prd.entity_id = node.nid)
            ORDER BY
              node.title";

        if ($limit > 0) {
            $sql .= " LIMIT {$limit}";
        }

        $db_result = db_query($sql);

        foreach ($db_result as $result) {
            $products[] = $result;
        }

        $db_result_map[$limit] = $products;
    }

    $extra_fields = array_keys(array_filter(compact('generic_name', 'nid')));

    foreach ($db_result_map[$limit] as $key => $product) {
        if ($extra_fields) {
            $data = array('product' => $product->title);
            foreach ($extra_fields as $extra_field) {
                $data[$extra_field] = $product->$extra_field;
            }
        }
        else {
            $data = $product->title;
        }
        //$data = ($generic_name === FALSE) ? $product->title : array('product' => $product->title, 'generic_name' => $product->field_generic_name_value);
        $formated_products[] = $data;
    }

    return $formated_products;
}

function _learninglab_get_product($product_title) {
    // [D7 OK]
    if ($product_title == HOME_PAGE) {
        return FALSE;
    }

    $query = new EntityFieldQuery();

    $entities = $query->entityCondition('entity_type', 'node')
        ->propertyCondition('type', 'product_page')
        ->propertyCondition('title', $product_title)
        ->propertyCondition('status', 1)
        ->range(0, 1)
        ->execute();

    if (!empty($entities['node'])) {
        $node_list = array_keys($entities['node']);
        $node_to_pass = array_shift($node_list);
        $product = node_load($node_to_pass);
        return $product;
    }
    return FALSE;
}

/**
 * Set in the cache all published products
 */
function _learninglab_get_all_products() {
    $all_products = cache_get("_learninglab_all_products");
    if (!$all_products) {
        $query = db_select("node", "n")
            ->fields("n", array('title'))
            ->condition("type", "product_page", "=")
            ->condition("status", 1, "=");
        $result = $query->execute()->fetchAll();
    }
    else {
        return unserialize($all_products->data);
    }

    $products = array();
    foreach ($result as $product) {
        $products[] = $product->title;
    }
    cache_set("_learninglab_all_products", serialize($products));
    return $products;
}

/**
 * Verify if product exists
 */
function _learninglab_product_exists($title) {
    if (!isset($_SESSION['_learninglab_all_products'])) {
        $_SESSION['_learninglab_all_products'] = _learninglab_get_all_products();
    }
    if (array_search($title, $_SESSION['_learninglab_all_products']) === FALSE) {
        return NULL;
    }
    return TRUE;
}

function _learninglab_get_sharepoint_page($sharepoint_id) {
    $query = new EntityFieldQuery();

    $entities = $query->entityCondition('entity_type', 'node')
        ->propertyCondition('type', 'sharepoint_pages')
        ->propertyCondition('status', 1)
        ->fieldCondition('field_sharepoint_id', 'value', $sharepoint_id, '=')
        ->range(0, 1)
        ->execute();

    if (!empty($entities['node'])) {
        $node_list = array_keys($entities['node']);
        $node_to_pass = array_shift($node_list);
        return node_load($node_to_pass);
    }

    return FALSE;
}

function _learninglab_get_products_a_to_z() {
    // TODO Please convert this statement to the D7 database API syntax.
    $db_result = db_query("SELECT node.nid AS nid,
                       node.title,
                         node_data_field_product_name.field_product_name_value AS node_data_field_product_name_field_product_name_value,
                         node.type AS node_type,
                         node.vid AS node_vid,
                         node_data_field_product_name.field_prescribing_information_value AS node_data_field_product_name_field_prescribing_information_value,
                         node_data_field_product_name.field_prescribing_link_value AS node_data_field_product_name_field_prescribing_link_value,
                         node_data_field_product_name.field_generic_name_value AS node_data_field_product_name_field_generic_name_value,
                         node_data_field_product_name.field_product_base_url_value
                       FROM {node} node
                       LEFT JOIN {content_type_product_page} node_data_field_product_name ON node.vid = node_data_field_product_name.vid
                       WHERE node.type in ('product_page')
                         ORDER BY node_data_field_product_name_field_product_name_value ASC;");

    $result = array();
    $i = 0;
    while ($obj = db_fetch_object($db_result)) {
        $result[$i]['title'] = $obj->title;
        $result[$i]['brand_name'] = $obj->node_data_field_product_name_field_product_name_value;
        $result[$i]['generic_name'] = $obj->node_data_field_product_name_field_generic_name_value;
        $result[$i]['prescibing_information'] = $obj->node_data_field_product_name_field_prescribing_information_value;
        $result[$i]['prescibing_information_link'] = $obj->node_data_field_product_name_field_prescribing_link_value;
        $result[$i]['product_base_url'] = $obj->field_product_base_url_value;
        $i++;
    }
    sort($result);
    return theme('display_products_a_to_z', array('results' => $result));
}

/**
 * Returns the node_page_view for the current product.
 * Should be used in a hook_menu
 */
function _learninglab_render_current_product_page() {
    $current_product = _learninglab_get_current_page();
    $product = _learninglab_get_product($current_product);

    if (isset($product->field_prod_home_sp_id) && !empty($product->field_prod_home_sp_id[LANGUAGE_NONE])) {
        if ($sharepoint_page = _learninglab_get_sharepoint_page($product->field_prod_home_sp_id[LANGUAGE_NONE][0]['value'])) {
            // Make Drupal think it's the actual Sharepoint Page that's being loaded so preprocesses are handled correctly.
            $_GET['q'] = 'node/' . $sharepoint_page->nid;
            return node_page_view($sharepoint_page);
        }
    }

    return FALSE;
}

function _learninglab_get_therapeutic_area() {
    $therapeutic_area = arg(1);
    $result = array();

    // Append Hecor Tools
    $hecor_tools = _learninglab_get_hecor_tools_by_therapeutic_area($therapeutic_area);
    $result[] = (object) array(
          'therapeutic_area' => $hecor_tools,
    );

    $db_result = db_query("SELECT *
                       FROM {node} node
                       LEFT JOIN {content_type_product_page} node_data_field_product_name ON node.vid = node_data_field_product_name.vid
                       INNER JOIN {product_therapeutic_area} p ON node.title = p.product
                       WHERE node.type in ('product_page') AND p.therapeutic_area = :p.therapeutic_area
                         ORDER BY node.title  ASC;", array(':p.therapeutic_area' => $therapeutic_area));

    if ((strpos($hecor_tools, '<h3>') !== FALSE) && (db_affected_rows() > 0)) {
        $result[] = (object) array(
              'therapeutic_area' => "<div class='divisor-shape'>&nbsp;</div>",
        );
    }

    if (db_affected_rows() > 0) {
        $result[] = (object) array('therapeutic_area' => '<h2>' . t('Products') . '</h2>');
        $html_button = '<div class="hecor-tool-show-button options-button"><div>' .
            '<a class="show" title="' . Show . '" href="javascript:void(0);">Show</a>' .
            '</div></div>';
        $result[] = (object) array('therapeutic_area' => $html_button);

        $html_content = '<div class="block-to-hide">';
        while ($obj = db_fetch_object($db_result)) {
            $html_content .= "<div class='related-content-therapeutic-area'>
                      <h2><a title='" . $obj->field_product_name_value . " (" . $obj->field_generic_name_value . ")' href='" . $obj->title . "'><span class='product-name'>" . $obj->field_product_name_value . "</span><span class='generic-name'> (" . $obj->field_generic_name_value . ")</span></a></h2>
                      <h3>Indications</h3>
                      " . $obj->field_indications_value . "
                      <div class='prescribing-information'><a target='_blank' href='/" . $obj->field_prescribing_link_value . "' title='" . $obj->field_prescribing_information_value . "'>" . $obj->field_prescribing_information_value . "</a></div>
                      <h3>Important Safety Information</h3>
                      <p>" . $obj->field_isi_pannel_value . "</p>
                      <div class='divisor-shape'>&nbsp;</div>
                      </div>";
        }
        $html_content .= '</div>';
        $obj->therapeutic_area = special_replace_avoid_title($html_content);
        $result[] = $obj;
    }

    return drupal_json_output(array("therapeutic_areas" => $result));
}

/*
 * Implementation of hook_perm().
 */

/**
 * @todo Please document this function.
 * @see http://drupal.org/node/1354
 */
function learninglab_permission() {
    return array(
      'config specific learninglab configuration' => array(
        'title' => t('config specific learninglab configuration'),
        'description' => t('TODO Add a description for \'config specific learninglab configuration\''),
      ),
      'content admin' => array(
        'title' => t('content admin'),
        'description' => t('TODO Add a description for \'content admin\''),
      ),
      'Use the site in maintenance mode' => array(
        'title' => t('Use the site in maintenance mode'),
        'description' => t('TODO Add a description for \'Use the site in maintenance mode\''),
      ),
      'access reports' => array(
        'title' => t('access reports'),
        'description' => t('TODO Add a description for \'access reports\''),
      ),
      'access imce menu' => array(
        'title' => t('access imce menu'),
        'description' => t('TODO Add a description for \'access imce menu\''),
      ),
      'run cron' => array(
        'title' => t('Run cron'),
        'description' => t('Enable user to run cron.'),
      ),
      'user reject workbench tab' => array(
        'title' => t('Use "Rejected Content" workbench tab')
      ),
      'user publish workbench tab' => array(
        'title' => t('Use "Published Content" workbench tab')
      ),
    );
}

/*
 * Implementation of hook_block().
 */

/**
 * Implements hook_block_info().
 */
function learninglab_block_info() {
    //[D7_MODULE_ADAPTATION BEGIN]
    $blocks['delta-0'] = array(
      'info' => t('[Sidebar] - Announcements Widget'));

    $blocks['delta-1'] = array(
      'info' => t('[Therapeutic Area] - Edit Field Information'));

    $blocks['delta-2'] = array(
      'info' => t('[Therapeutic Area] - List all TAs'));

    $blocks['delta-3'] = array(
      'info' => t('[Message Alert] - Site Maintenance alert message'));

    $blocks['delta-4'] = array(
      'info' => t('[Header Links] - Search and Product Links'));

    $blocks['delta-5'] = array(
      'info' => t('[Sidebar] - PI Navigation'));

    $blocks['delta-6'] = array(
      'info' => t('[PI Mobile Navbar] - PI Navigation'));

    $blocks['delta-7'] = array(
      'info' => t('[Header] - Website header'));

    $blocks['delta-8'] = array(
      'info' => t('[Footer] - Website footer'));

    $blocks['delta-9'] = array(
      'info' => t('[Header Search] - Website search bar'));

    $blocks['delta-10'] = array(
      'info' => t('[Front page tabs] - Front page product and TA tabs'));

    $blocks['delta-11'] = array(
      'info' => t('Tools Widget - General Pages'));

    $blocks['delta-12'] = array(
      'info' => t('[Header Links AE/PQC] - AE/PQC Header links Desktop/Tablet'));

    $blocks['delta-13'] = array(
      'info' => t('[Header Links AE/PQC] - AE/PQC Header links mobile'));

    $blocks['delta-14'] = array(
      'info' => t('[Footer Links AE/PQC] - AE/PQC Footer links'));

    $blocks['delta-15'] = array(
      'info' => t('[Sidebar] - Resources Widget'));

    $blocks['delta-16'] = array(
      'info' => t('[Sidebar] - REMS Desktop Widget'));

    $blocks['delta-17'] = array(
      'info' => t('[Header Links] - REMS Mobile Widget'));

    $blocks['delta-18'] = array(
      'info' => t('[Footer] - Website footer menu'));

    $blocks['delta-19'] = array(
      'info' => t('[Pre-Footer] - Need help bar'));

    $blocks['delta-20'] = array(
      'info' => t('[Secondary] - Need help block'));

    $blocks['delta-21'] = array(
      'info' => t('[Modal] - Exitlink'));

    $blocks['delta-22'] = array(
      'info' => t('[Modal] - Images'));

    $blocks['delta-23'] = array(
      'info' => t('[Modal] - Table'));

    $blocks['delta-25'] = array(
      'info' => t('[Modal] - Ajax with header'));

    $blocks['delta-26'] = array(
      'info' => t('[Modal] - Report AE/PQC'));

    $blocks['delta-27'] = array(
      'info' => t('[Modal] - Loader'));

    $blocks['delta-28'] = array(
      'info' => t('[Modal] - Reference'));

    $blocks['delta-29'] = array(
      'info' => t('[Modal] - Return to home'));

    $blocks['delta-30'] = array(
      'info' => t('[Modal] - Product'));

    return $blocks;
}

/**
 * Implements hook_block_view().
 */
function learninglab_block_view($delta) {
    $block = array();
    switch ($delta) {

        case 'delta-0':
            $block['content'] = _learninglab_announcement_widget();
            break;

        case 'delta-1':
            $block['content'] = _learninglab_edit_ta_information();
            break;

        case 'delta-2':
            $block['content'] = _learninglab_list_all_ta_temporary_function();
            break;

        case 'delta-3':
            $block['content'] = _learninglab_site_maintenance_alert_message();
            break;

        case 'delta-4':
            $block['content'] = _learninglab_header_web();
            break;

        case 'delta-5':
            $block['content'] = _learninglab_pi_navigation();
            break;

        case 'delta-6':
            $block['content'] = _learninglab_pi_navigation('mobile');
            break;

        case 'delta-7':
            $block['content'] = _learninglab_get_website_header_footer('header');
            break;

        case 'delta-8':
            $block['content'] = _learninglab_get_website_header_footer('footer');
            break;

        case 'delta-9':
            $block['content'] = _learninglab_get_header_search_bar();
            break;

        case 'delta-10':
            $block['content'] = _learninglab_get_front_page_product_ta_list();
            break;

        case 'delta-11':
            $block['content'] = _learninglab_get_right_general_tools();
            break;

        case 'delta-12':
            $block['content'] = _learninglab_get_ae_pqc_links('desktop');
            break;

        case 'delta-13':
            $block['content'] = _learninglab_get_ae_pqc_links('mobile');
            break;

        case 'delta-14':
            $block['content'] = _learninglab_get_ae_pqc_links('footer');
            break;

        case 'delta-15':
            $block['content'] = _learninglab_resources_widget();
            break;

        case 'delta-16':
            $block['content'] = _learninglab_get_rems_widget_information('desktop');
            break;

        case 'delta-17':
            $block['content'] = _learninglab_get_rems_widget_information('mobile');
            break;

        case 'delta-18':
            $block['content'] = _learninglab_get_website_header_footer('footer_menu');
            break;

        case 'delta-19':
            $block['content'] = _learninglab_get_website_pre_footer_need_help_bar('footer');
            break;

        case 'delta-20':
            $block['content'] = _learninglab_get_website_pre_footer_need_help_bar('sidebar');
            break;

        case 'delta-21':
            $block['content'] = _learninglab_modal_exitlink();
            break;

        case 'delta-22':
            $block['content'] = _learninglab_modal_images();
            break;

        case 'delta-23':
            $block['content'] = _learninglab_modal_table();
            break;

        case 'delta-25':
            $block['content'] = _learninglab_modal_ajax_with_header();
            break;

        case 'delta-26':
            $block['content'] = _learninglab_modal_ae_pqc();
            break;

        case 'delta-27':
            $block['content'] = _learninglab_modal_loader();
            break;

        case 'delta-28':
            $block['content'] = _learninglab_modal_reference();
            break;

        case 'delta-29':
            $block['content'] = _learninglab_modal_return_to_home();
            break;

        case 'delta-30':
            $block['content'] = _learninglab_modal_product();
            break;
    }

    return $block;
}

/**
 * @todo Please document this function.
 * @see http://drupal.org/node/1354
 */
function learninglab_block_OLD($op = 'list', $delta = 0, $edit = array()) {
    // TODO Remaining code in this function needs to be moved to the appropriate new hook function.
    global $theme;
    _learninglab_hecor_tools_block($blocks, $op, $delta, $edit);
    return $blocks;
}

/*
 * Function to edit therapeutic introduction information.
 */

function _learninglab_edit_ta_information() {
    $content = variable_get("ta_intro_text", "JanssenMD&reg; provides medical information for a number of products marketed by the Janssen Pharmaceutical companies of Johnson &amp; Johnson.  These products are grouped by Therapeutic areas.");
    return theme('ta_information_field', array('content' => $content));
}

/*
 * General javascript loader function.
 */

/**
 * @todo Please document this function.
 * @see http://drupal.org/node/1354
 */
function learninglab_load_js() {
    // http://api.drupal.org/api/function/drupal_add_js
    drupal_add_js(drupal_get_path('module', 'learninglab') . '/jscripts/general_functions.js', array('type' => 'file', 'weight' => JS_LIBRARY));

    if ((stripos(request_uri(), '/admin/reports/audit-log') !== FALSE) || (stripos(request_uri(), '/jmd_content/audit_log') !== FALSE)) {
        drupal_add_js(drupal_get_path("module", "learninglab") . "/jscripts/audit_log_form.js", array('type' => 'file', 'weight' => JS_LIBRARY));
    }

    drupal_add_js(drupal_get_path('module', 'learninglab') . '/jscripts/multimedia.js');
    _learninglab_add_brightcove_js();
}

/*
 * General CSS loader function.
 */

/**
 * @todo Please document this function.
 * @see http://drupal.org/node/1354
 */
function learninglab_load_css() {
    drupal_add_css(drupal_get_path('module', 'learninglab') . '/styles/cms.css', array('type' => 'core'));
}

/*
  Fetch a specific URL alias from the database.
 */

function _learninglab_path_load($alias) {
    $result = db_query("SELECT pid FROM {url_alias} WHERE alias = :alias", array(':alias' => $alias));
    return $result->fetchAssoc();
}

/**
 * Implements hook_node_delete().
 */
function learninglab_node_delete($node) {
    /*
     *   if (!module_exists('client_content_workflow')) {
      exclude_quick_information_action($node);
      }

      if ($node->nid != "" && ($node->type == ANNOUNCEMENT_CONTENT_TYPE_PAGES || $node->type == EVENT_CONTENT_TYPE_PAGES)) {
      if ($node->type == ANNOUNCEMENT_CONTENT_TYPE_PAGES) {
      $comp_type = QUICKLINK_ANNOUNCEMENT;
      }
      else {
      $comp_type = QUICKLINK_EVENT;
      }
      _learninglab_remove_announcement_event_quick_links($comp_type, $node->nid);
      }

      // Deletes the widget header blocks when the node is deleted
      if ($node->id != "" && $node->type == 'widget_header') {
      $sql = "DELETE FROM {block} WHERE module = 'learninglab' AND delta = 'llab-%s' AND region = 'sidebar'";
      // TODO Please review the conversion of this statement to the D7 database API syntax.
      // db_query($sql, $node->nid)
      db_delete('block')
      ->condition('module', 'learninglab')
      ->condition('delta', $node->nid)
      ->condition('region', 'sidebar')
      ->execute();
      }
     *
     */

    if ($node->nid != "" && $node->type == PRODUCT_PAGE) {

        /*         * ******Therapeutic Area Transformation******** */

        if (isset($node->title)) {

            db_query("DELETE FROM product_therapeutic_area WHERE product = '" . $node->title . "'");
        }

        /*         * ******Therapeutic Area Transformation End******** */
    }
}

/**
 * Implements hook_node_update().
 */
function learninglab_node_update($node) {
    // [D7 ADAPTED]
    //$node_title_slug    = _learninglab_get_node_filed_value($node, 'field_title_slug');
    $node_sharepoint_id = _learninglab_get_node_filed_value($node, 'field_sharepoint_id');

    // [D7 ADAPTED]
    // _learninglab_update_product($node);

    /* [D7_MODULE_ADAPTATION] THIS SHOULD BE FIXED WITH FILE IMPORT AND QUICK LINKS
      if (!module_exists('client_content_workflow')) {
      save_quick_information_action($node);
      _learninglab_update_quick_link($node);
      }
     */

    if ($node->nid != "" && $node->type == SHAREPOINT_CONTENT_TYPE_PAGES) {

        watchdog('sharepoint_pages', 'IN NODE UPDATE' . $node->type);

        $jcr_canonical_url_val = $node->field_canonical_url[LANGUAGE_NONE][0]['value'];
        $node->field_canonical_url[LANGUAGE_NONE][0]['value'] = _nfr_url_dita_address($jcr_canonical_url_val, $node_sharepoint_id);

        watchdog('sharepoint_pages', 'jcr_canonical_url_val' . $jcr_canonical_url_val);
        watchdog('sharepoint_pages', 'UPDATED jcr_canonical_url_val' . $node->field_canonical_url[LANGUAGE_NONE][0]['value']);

        if ($node->field_jcr_managed[LANGUAGE_NONE][0]['value'] == 1) {

            $node = sharepoint_content_transform($node);
        }
        //Deleting quick links when the content has a newer version
        //_learninglab_remove_obsolete_quick_links($node->nid);
        //Setting quick links table mapping
        // [D7_MODULE_ADAPTATION] QUICK LINKS HERE
        //$node_browsable = _learninglab_get_taxonomy_value_from_node($node->nid, "browseable");
        //if ($node->field_quick_link[0]['value'] == "yes" && (is_array($node_browsable) && $node_browsable[0] == "yes")) {
        //  _learninglab_save_quick_link_map(QUICKLINK_DITA_TOPIC, $node->vid, $node->nid);
        //}
        $node_title_slug = $node->field_title_slug[LANGUAGE_NONE][0]['value'];
        watchdog("URL Alias", "Creating node_title_slug: " . $node_title_slug);
        watchdog("URL Alias", "Creating alias for: " . $node->nid . " as: " . $node_title_slug);
        $titles = explode("|", $node_title_slug);

        watchdog("Obsolete", "Defined obsolete for id: " . $node_sharepoint_id);
        _learninglab_set_sharepoint_id_all_url_obsolete($node_sharepoint_id);

        // If the content type is a file, the url_alias should start with file/
        $dita_content_type = _learninglab_get_taxonomy_value_from_node($node->nid, "dita content type");
        if ($dita_content_type[0] == 'file') {
            $alias_prefix = 'file/';
        }
        else {
            $alias_prefix = 'node/';
        }

        // Check now if this topic is a home page topic
        $query_for_product_home = new EntityFieldQuery();
        $query_for_product_home->entityCondition('entity_type', 'node')
            ->fieldCondition('field_prod_home_sp_id', 'value', $node_sharepoint_id, '=');
        $result_for_product_home = $query_for_product_home->execute();

        $product_node_for_base_url = FALSE;

        // if so, lets get the base URL to exclude it from the delete list
        if (isset($result_for_product_home['node'])) {
            unset($product_node_for_base_url);
            foreach ($result_for_product_home['node'] as $node_home_for_this_node_product) {
                $node_id_for_this_product_home = $node_home_for_this_node_product->nid;
            }
            $product_node_for_base_url = node_load($node_id_for_this_product_home);
        }

        //Remove old path_alias
        $sql_node_path_alias = db_select('url_alias', 'ua');
        $sql_node_path_alias->fields('ua', array('alias'));
        $sql_node_path_alias->condition('source', $alias_prefix . $node->nid, 'LIKE');
        //watchdog('condition-1 : ', $alias_prefix . $node->nid);
        if ($product_node_for_base_url !== FALSE) {
            $sql_node_path_alias->condition('alias', $product_node_for_base_url->field_product_base_url[LANGUAGE_NONE][0]['value'], "<>");
            /* watchdog('condition-2 : ', $product_node_for_base_url->field_product_base_url[LANGUAGE_NONE][0]['value']); */
        }
        $rs_node_path_alias = $sql_node_path_alias->execute()->fetchAll();
        foreach ($rs_node_path_alias as $node_path_alias) {
            // watchdog('Path Deleted', 'Alias : '.$node_path_alias->alias);	
            path_delete(array('alias' => $node_path_alias->alias));
            /* log for alias path deletion : start */
            if (sizeof($rs_node_path_alias) > 1) {
                $log_content = $node->nid . " " . str_replace('/', '', $alias_prefix) . " " . $node_path_alias->alias . " " . date('m/d/Y H:i:s');
                $url_alias_log_file_path = _learninglab_file_directory_path() . '/url_alias_removal_logs.txt';
                $url_alias_log_file = file_put_contents($url_alias_log_file_path, $log_content . PHP_EOL, FILE_APPEND | LOCK_EX);
            }
            /* log for alias path deletion : end */
        }

        foreach ($titles as $slug) {
            $slug = trim($slug);
            if ($slug != "") {
                // Update or Create a new path_alias
                $pid = _learninglab_path_load(_learninglab_replace_slug_chars($slug));
                if ($pid) {
                    $pid = $pid['pid'];
                }
                else {
                    $pid = NULL;
                }

                $field_sharepoint_id = $node->field_sharepoint_id[LANGUAGE_NONE][0]['value'];
                $prod_home_id = '';
                if (!empty($field_sharepoint_id)) {
                    $prod_home_id = db_query("SELECT entity_id FROM `field_data_field_prod_home_sp_id` WHERE `field_prod_home_sp_id_value` = '" . $field_sharepoint_id . "' ")->fetchField();

                    if (!empty($prod_home_id)) {
                        $product_base_url = db_query("SELECT `field_product_base_url_value` FROM field_data_field_product_base_url WHERE `entity_id` = '" . $prod_home_id . "' ")->fetchField();
                        $path_to_save = array('source' => $alias_prefix . $node->nid, 'alias' => _learninglab_replace_slug_chars($product_base_url));
                        path_save($path_to_save); #Alias created with product_base_url
                        $path_to_save = array('source' => $alias_prefix . $node->nid, 'alias' => _learninglab_replace_slug_chars($slug), 'pid' => $pid);
                        /* watchdog('Path Updated', 'Alias 1 : '._learninglab_replace_slug_chars($slug)); */
                        path_save($path_to_save); #Alias created with canonical_url
                    }
                    else {
                        $path_to_save = array('source' => $alias_prefix . $node->nid, 'alias' => _learninglab_replace_slug_chars($slug), 'pid' => $pid);
                        // watchdog('Path Updated', 'Alias 2 : '._learninglab_replace_slug_chars($slug));
                        path_save($path_to_save);
                    }
                }
                else {
                    // [D7 ADAPTED]
                    $path_to_save = array('source' => $alias_prefix . $node->nid, 'alias' => _learninglab_replace_slug_chars($slug), 'pid' => $pid);
                    //watchdog('Path Updated', 'Alias 3 : '._learninglab_replace_slug_chars($slug));
                    path_save($path_to_save);
                }
                // [D7 ADAPTED]
                watchdog("Obsolete", "Gonna create the following URL not obsolete: " . $node_sharepoint_id . ' |' . $slug);
                _learninglab_set_create_sharepoint_id_url_not_obsolete($node_sharepoint_id, _learninglab_replace_slug_chars($slug));
            }
        }
        /* NODE PDF RECREATE */
        $canonical_url_val = $node->field_canonical_url[LANGUAGE_NONE][0]['value'];
        $vv_info = get_vv_info($canonical_url_val);

        $document_version = $vv_info['version'];
        if (empty($document_version)) {
            $document_version = "N/A";
        }
        $pdf_filename = $document_version . '-' . $node->title;
        $pdf_filename = str_replace(array('â', '&mdash;', '&#8212;'), '-', $pdf_filename);
        $pdf_filename = str_replace(array('/', '\\', ':', '*', '"', '<', '>', '\'', '?', '|'), '_', $pdf_filename);
        $pdf_filename = preg_replace('/[^A-Za-z0-9_\-\.\(\)]/i', '_', $pdf_filename);
        $cached_filename = _learninglab_file_directory_path() . '/audit_log_cache/' . $pdf_filename . '.pdf';
        if (file_exists($cached_filename)) {
            watchdog("cached_filename", "cached_filename: " . $cached_filename);
            unlink($cached_filename);
        }
        /* NODE PDF RECREATE */

        /* //Placing product unique identifier in SP content pages
          $nodeObj = node_load($node->field_vv_product[LANGUAGE_NONE][0]['nid']);
          $node->field_product[LANGUAGE_NONE][0]['value'] = $nodeObj->title;
          $node->field_sharepoint_id[LANGUAGE_NONE][0]['value'] = $nodeObj->uuid;
          field_attach_update('node', $node); */
    }
    else if ($node->nid != "" && $node->type == 'file_resource') {

        // Register file resource as updated.
        // Product's files path will be updated after import is finished.
        JCRJMDProductCustom::updatedFileResources($node->nid);

        $query_nid_pi = db_select('field_data_field_pi_pdf', 'fp')
                ->fields('fp', array('entity_id'))
                ->condition('fp.bundle', 'product_page')
                ->condition('fp.field_pi_pdf_nid', $node->nid, '=')
                ->execute()
                ->fetchObject()
            ->entity_id;
        watchdog("JMD FILE", print_r($query_nid_pi, true));

        if (isset($query_nid_pi) && !empty($query_nid_pi)) {
            $node_product_pi = node_load($query_nid_pi);

            $node_product_pi->field_prescribing_link[LANGUAGE_NONE][0]['value'] = substr(trim(strip_tags($node->body[LANGUAGE_NONE][0]['summary'])), 1);
            field_attach_update('node', $node_product_pi);
            $_SESSION['pi'][$node->nid] = 1;

            $node_product_pi->field_prescribing_link[LANGUAGE_NONE][0]['value'] = substr(trim(strip_tags($node->body[LANGUAGE_NONE][0]['summary'])), 1);
            field_attach_update('node', $node_product_pi);
            $_SESSION['pi'][$node->nid] = 1;
        }

        $query_nid_med = db_select('field_data_field_medication_guide_pdf', 'fm')
                ->fields('fm', array('entity_id'))
                ->condition('fm.bundle', 'product_page')
                ->condition('fm.field_medication_guide_pdf_nid', $node->nid, '=')
                ->execute()
                ->fetchObject()
            ->entity_id;
        watchdog("JMD FILE", print_r($query_nid_med, true));

        if (isset($query_nid_med) && !empty($query_nid_med)) {
            $node_product_med = node_load($query_nid_med);

            $node_product_med->field_medication_guide[LANGUAGE_NONE][0]['value'] = substr(trim(strip_tags($node->body[LANGUAGE_NONE][0]['summary'])), 1);
            field_attach_update('node', $node_product_med);
            $_SESSION['med'][$node->nid] = 1;
        }
    }
    else if ($node->nid != "" && $node->type == PRODUCT_PAGE) {
        // Register product to corresponding file resource.
        // Product's files path will be updated after import is finished.
        if (isset(
                $node->field_pi_pdf['und'], $node->field_pi_pdf['und'][0], $node->field_pi_pdf['und'][0]['nid'])) {
            JCRJMDProductCustom::updatedFileResources($node->field_pi_pdf['und'][0]['nid'], $node->nid);
        }
        if (isset(
                $node->field_medication_guide_pdf['und'], $node->field_medication_guide_pdf['und'][0], $node->field_medication_guide_pdf['und'][0]['nid'])) {
            JCRJMDProductCustom::updatedFileResources($node->field_medication_guide_pdf['und'][0]['nid'], $node->nid);
        }

        $node = product_page_field_transform($node);
        if (!empty($node->field_medication_guide_pdf) && !isset($_SESSION['pi'][$node->field_pi_pdf['und'][0]['nid']])) {
            $node = product_page_pi_transform($node);
        }
        if (!empty($node->field_medication_guide_pdf) && !isset($_SESSION['med'][$node->field_medication_guide_pdf['und'][0]['nid']])) {
            $node = product_page_medguide_transform($node);
        }

        /* When PI pdf has been archived and the alias needs to be removed now */
        if (!isset($node->field_pi_pdf['und'][0]['nid']) || empty($node->field_pi_pdf['und'][0]['nid'])) {
            $node->field_prescribing_link[LANGUAGE_NONE][0]['value'] = "";
        }
        /* When Med Guide pdf has been archived and the alias needs to be removed now */
        if (!isset($node->field_medication_guide_pdf['und'][0]['nid']) || empty($node->field_medication_guide_pdf['und'][0]['nid'])) {
            $node->field_medication_guide[LANGUAGE_NONE][0]['value'] = "";
        }

        field_attach_update('node', $node);
        $node_prod_home_sp_id = _learninglab_get_node_filed_value($node, 'field_prod_home_sp_id');
        $node_product_base_url = _learninglab_get_node_filed_value($node, 'field_product_base_url');

        $node_id = _learninglab_get_node_id_by_sharepoint_id($node_prod_home_sp_id);
        if ($node_id) {
            $pid = _learninglab_path_load($node_product_base_url);
            if ($pid) {
                // [D7 ADAPTED]
                $path_to_save = array('source' => 'node/' . $node_id, 'alias' => _learninglab_replace_slug_chars($node_product_base_url), 'pid' => $pid['pid']);
                path_save($path_to_save);
            }
            else {
                // [D7 ADAPTED]
                $path_to_save = array('source' => 'node/' . $node_id, 'alias' => _learninglab_replace_slug_chars($node_product_base_url));
                path_save($path_to_save);
            }
        }

        _learninglab_update_product_disclaimer_list($node);

        //path_set_alias("quick-information/{$product_base_url}", "{$product_base_url}/quick-information");
    }
    /*  if ($node->nid != "" && $node->type == SHAREPOINT_CONTENT_TYPE_PAGES) {


      } */
}

/**
 * Function to return the value of a field
 */
function _learninglab_get_node_filed_value($node, $field, $type = 'value') {

    $field = field_get_items('node', $node, $field);
    $value_to_return = ($field[0][$type]) ? $field[0][$type] : NULL;

    return $value_to_return;
}

/**
 * This function is used to replace special chars from the URL slug(path alias)
 *
 */
function _learninglab_replace_slug_chars($slug) {

    // !@#$%*()=+<>:,?[]{}

    $new_slug = str_ireplace(
        array('Â®', 'â¢', '&', ';', '!', '@', '#', '$', '%', '*', '(', ')', '=', '+', '<', '>', ':', ',', '?', '[', ']', '{', '}'), array('', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''), $slug);

    $new_slug = trim($new_slug);

    return $new_slug;
}

/**
 * Implements hook_node_presave
 */
function learninglab_node_presave($node) {
    // [D7 OK]
    if ($node->type == SHAREPOINT_CONTENT_TYPE_PAGES) {
        $node->field_header[LANGUAGE_NONE][0]['format'] = 'full_html';
        $node->field_html_content[LANGUAGE_NONE][0]['format'] = 'full_html';

        // Avoid creating path autos for Share Point Pages
        $node->path['pathauto'] = 0;
    }
}

/**
 * Implements hook_node_insert().
 */
function learninglab_node_insert($node) {
    watchdog('sharepoint_pages', 'IN NODE INSERT ' . $node->nid);
    if (!empty($node->field_canonical_url)) {
        watchdog('sharepoint_pages', 'field_canonical_url' . $node->field_canonical_url[LANGUAGE_NONE][0]['value']);
    }
    // [D7 ADAPTED]
    $node_title_slug = _learninglab_get_node_filed_value($node, 'field_title_slug');
    $node_sharepoint_id = _learninglab_get_node_filed_value($node, 'field_sharepoint_id');

    // [D7 ADAPTED]
    // _learninglab_update_product($node);

    /* [D7_MODULE_ADAPTATION] THIS SHOULD BE FIXED WITH FILE IMPORT AND QUICK LINKS
      if (!module_exists('client_content_workflow')) {
      save_quick_information_action($node);
      _learninglab_update_quick_link($node);
      }
     */


    if ($node->nid != "" && $node->type == SHAREPOINT_CONTENT_TYPE_PAGES) {
        watchdog('sharepoint_pages', 'IN NODE INSERT ' . $node->nid);
        /* $jcr_canonical_url_val = $node->field_canonical_url[LANGUAGE_NONE][0]['value'];
          $node->field_canonical_url[LANGUAGE_NONE][0]['value'] = _nfr_url_dita_address($jcr_canonical_url_val, $node_sharepoint_id); */


        watchdog('sharepoint_pages', 'field_canonical_url' . $node->field_canonical_url[LANGUAGE_NONE][0]['value']);

        if ($node->field_jcr_managed[LANGUAGE_NONE][0]['value'] == 1) {

            $node = sharepoint_content_transform($node);
        }

        //$node_title_slug = $node->field_canonical_url[LANGUAGE_NONE][0]['value']."|";
        //$node_title_slug = $node->field_title_slug[LANGUAGE_NONE][0]['value'];

        watchdog("URL Alias", "Creating alias for: " . $node->nid . " as: " . $node_title_slug);
        $titles = explode("|", $node_title_slug);

        watchdog("Obsolete", "Defined obsolete for id: " . $node_sharepoint_id);
        _learninglab_set_sharepoint_id_all_url_obsolete($node_sharepoint_id);

        // If the content type is a file, the url_alias should start with file/
        $dita_content_type = _learninglab_get_taxonomy_value_from_node($node->nid, "dita content type");
        if ($dita_content_type[0] == 'file') {
            $alias_prefix = 'file/';
        }
        else {
            $alias_prefix = 'node/';
        }

        foreach ($titles as $slug) {
            $slug = trim($slug);
            if ($slug != "") {
                // Update or Create a new path_alias
                $pid = _learninglab_path_load(_learninglab_replace_slug_chars($slug));
                if ($pid) {
                    $pid = $pid['pid'];
                }
                else {
                    $pid = NULL;
                }

                // [D7 ADAPTED]
                $path_to_save = array('source' => $alias_prefix . $node->nid, 'alias' => _learninglab_replace_slug_chars($slug), 'pid' => $pid);
                path_save($path_to_save);

                // [D7 ADAPTED]
                watchdog("Obsolete", "Going to create the following URL not obsolete: " . $node_sharepoint_id . ' |' . $slug);
                watchdog("Obsolete", "_learninglab_replace_slug_chars VAL: " . _learninglab_replace_slug_chars($slug));
                _learninglab_set_create_sharepoint_id_url_not_obsolete($node_sharepoint_id, _learninglab_replace_slug_chars($slug));
            }
        }
    }
    else if ($node->nid != "" && $node->type == PRODUCT_PAGE) {

        $node = product_page_field_transform($node);
        $node = product_page_pi_transform($node);
        $node = product_page_medguide_transform($node);

        field_attach_update('node', $node);

        $node_prod_home_sp_id = _learninglab_get_node_filed_value($node, 'field_prod_home_sp_id');
        $node_product_base_url = _learninglab_get_node_filed_value($node, 'field_product_base_url');

        $node_id = _learninglab_get_node_id_by_sharepoint_id($node_prod_home_sp_id);
        if ($node_id) {
            $pid = _learninglab_path_load($node_product_base_url);
            if ($pid) {
                // [D7 ADAPTED]
                $path_to_save = array('source' => 'node/' . $node_id, 'alias' => _learninglab_replace_slug_chars($node_product_base_url), 'pid' => $pid['pid']);
                path_save($path_to_save);
            }
            else {
                // [D7 ADAPTED]
                $path_to_save = array('source' => 'node/' . $node_id, 'alias' => _learninglab_replace_slug_chars($node_product_base_url));
                path_save($path_to_save);
            }
        }

        _learninglab_update_product_node_reference_list($node);
    }
    /* else if ($node->nid != "" && $node->type == SHAREPOINT_CONTENT_TYPE_PAGES) {

      } */


    if ($node->nid && $node->type == 'file_resource') {
        // Register file resource as updated.
        // Product's files path will be updated after import is finished.
        JCRJMDProductCustom::updatedFileResources($node->nid);
    }
    else if ($node->nid && $node->type == PRODUCT_PAGE) {
        // Register product to corresponding file resource.
        // Product's files path will be updated after import is finished.
        if (isset(
                $node->field_pi_pdf['und'], $node->field_pi_pdf['und'][0], $node->field_pi_pdf['und'][0]['nid'])) {
            JCRJMDProductCustom::updatedFileResources($node->field_pi_pdf['und'][0]['nid'], $node->nid);
        }
        if (isset(
                $node->field_medication_guide_pdf['und'], $node->field_medication_guide_pdf['und'][0], $node->field_medication_guide_pdf['und'][0]['nid'])) {
            JCRJMDProductCustom::updatedFileResources($node->field_medication_guide_pdf['und'][0]['nid'], $node->nid);
        }
    }
}

/**
 * Implements hook_node_load().
 */
function learninglab_node_load($node, $types) {
    // [D7 ADAPTED]
    $node_type = reset($node);
    if ($node_type->type == "sharepoint_pages") {
        _learninglab_retired_content();
    }
}

/**
 * Implements hook_node_view().
 */
function learninglab_node_view($node, $view_mode = 'full') {
    if ($node->type == "sharepoint_pages") {
        _learninglab_retired_content();
    }
}

/**
 * @todo Please document this function.
 * @see http://drupal.org/node/1354
 */
function learninglab_nodeapi_OLD(&$node, $op, $a3 = NULL, $a4 = NULL) {

    // TODO Remaining code in this function needs to be moved to the appropriate new hook function.
    // SubComponents callbacks
    _learninglab_hecor_tools_nodeapi($node, $op, $a3, $a);
}

function _learninglab_update_product($node) {

    if ($node->type != PRODUCT_PAGE) {

        $node_product = _learninglab_get_node_filed_value($node, 'field_product');
        $node_product_full_name = _learninglab_get_node_filed_value($node, 'field_product_full_name');

        _learninglab_check_product_fullname($node_product, $node_product_full_name);
    }
    else {

        $node_product_name = _learninglab_get_node_filed_value($node, 'field_product_name');
        $node_generic_name = _learninglab_get_node_filed_value($node, 'field_generic_name');
        $node_base_url_name = _learninglab_get_node_filed_value($node, 'field_product_base_url');

        $brand_full_name = $node_product_name . ' (' . $node_generic_name . ')';
        _learninglab_check_product_fullname($node_base_url_name, $brand_full_name);
    }
}

function _learninglab_check_product_fullname($product_name, $product_fullname) {
    if (empty($product_fullname) || empty($product_name)) {
        return;
    }
    $aux = explode('(', $product_fullname);
    $brandName = _learninglab_prepare_brand_name($aux[0]);
    $genericName = _learninglab_prepare_generic_name($aux[1]);
    _learninglab_update_product_fullname($product_name, $brandName, $genericName);
}

function _learninglab_update_product_fullname($product, $brandName, $genericName) {

    // [D7 UPDATED] REVIEW THIS
    $updated_brand_full_name = $brandName . ' (' . $genericName . ')';

    /*     * *************************************************************************8
     * First lets get the values that the content type sharepoint page uses
     */
    $base_urls = db_query('SELECT entity_id FROM {field_data_field_product_base_url}
                          WHERE field_product_base_url_value = :product', array(':product' => $product));

    // [D7 ADAPTED]
    foreach ($base_urls as $record) {

        //UPDATES ALL PRODUCT BRAND NAMES
        $num_updated = db_update('field_data_field_product_name')
            ->fields(array(
              'field_product_name_value' => $brandName,
            ))
            ->condition('entity_id', $record->entity_id, '=')
            ->execute();

        // UPDATE ALL PRODUCT GENERIC NAMES
        $num_updated = db_update('field_data_field_generic_name')
            ->fields(array(
              'field_generic_name_value' => $genericName,
            ))
            ->condition('entity_id', $record->entity_id, '=')
            ->execute();
    }

    //Unset base_urls var
    unset($base_urls);

    /*     * *************************************************************************8
     * Now we can get the values that the product pages uses
     */

    // Now grab all the term used by the table "product_base_url_value"
    $base_urls = db_query('SELECT entity_id FROM {field_data_field_product}
                          WHERE field_product_value = :product', array(':product' => $product));
    // [D7 ADAPTED]
    foreach ($base_urls as $record) {
        /* echo "<pre>"; print_r($record);
          echo "<pre>"; print_r($updated_brand_full_name); */
        //UPDATES ALL PRODUCT BRAND NAMES
        $num_updated = db_update('field_data_field_product_full_name')
            ->fields(array(
              'field_product_full_name_value' => $updated_brand_full_name,
            ))
            ->condition('entity_id', $record->entity_id, '=')
            ->execute();
    }
}

function _learninglab_prepare_brand_name($brandName) {
    // Replace all the TM and REG
    $brandName = str_ireplace(array('Â®', 'â¢'), array('&reg;', '&trade;'), $brandName);
    // Remove the extra spaces
    $brandName = trim($brandName);
    return $brandName;
}

function _learninglab_prepare_generic_name($genericName) {
    // Remove the last parenteses
    $size = strlen($genericName);
    $genericName = substr($genericName, 0, $genericName - 1);
    // Replace all the TM and REG
    $genericName = str_ireplace(array('Â®', 'â¢'), array('&reg;', '&trade;'), $genericName);
    // Remove the extra spaces
    $genericName = trim($genericName);
    return $genericName;
}

function _learninglab_get_taxonomy_value_from_node($nid, $vocabulary_name) {
    // Creates a table to translate the old calls to the new calls
    $vocabulary_to_search = '';

    $vocabulary_name = strtolower($vocabulary_name);

    switch ($vocabulary_name) {

        case 'dita content type':
            $vocabulary_to_search = 'field_dita_content_type';
            break;

        case 'searchable':
            $vocabulary_to_search = 'field_searchable';
            break;

        case 'browseable':
            $vocabulary_to_search = 'field_browseable';
            break;
    }

    // Loads the node to get the terms from here
    $node_to_get_values = node_load($nid);
    if (empty($node_to_get_values->$vocabulary_to_search)) {
        return array();
    }

    // Gets the term ID at the drupal Style
    $node_content_type_arr = field_get_items('node', $node_to_get_values, $vocabulary_to_search);
    $node_content_type = ($node_content_type_arr[0]['tid']) ? $node_content_type_arr[0]['tid'] : NULL;

    // Get the term
    $term = taxonomy_term_load($node_content_type);
    $terms[] = $term->name;

    return $terms;
}

/**
 * Try to map a string to an existing term, as for glossary use, filtering by the vocabulary
 *
 * Provides a case-insensitive and trimmed mapping, to maximize the
 * likelihood of a successful match.
 *
 * @param term_name
 *   Name of the term to search for.
 * @param vocabulary
 *   Name of the vocabulary to search for.
 *
 * @return
 *   An array of matching term objects.
 */
function _learninglab_get_taxonomy_term_by_name_and_vocabulary($term_name, $vocabulary) {

    $sql = "SELECT
            term_data.tid, term_data.*
          FROM {taxonomy_term_data}
          INNER JOIN {taxonomy_vocabulary} ON
            vocabulary.vid = term_data.vid
          WHERE
            LOWER(term_data.name) = LOWER('%s')
            AND LOWER(vocabulary.name) = LOWER('%s')
          ";

    $db_result = db_query("SELECT
            term_data.tid, term_data.*
          FROM {taxonomy_term_data}
          INNER JOIN {taxonomy_vocabulary} ON
            vocabulary.vid = term_data.vid
          WHERE
            LOWER(term_data.name) = :LOWER(term_data.name)
            AND LOWER(vocabulary.name) = :LOWER(vocabulary.name)
          ", array(':LOWER(term_data.name)' => LOWER('%s'), ':LOWER(vocabulary.name)' => LOWER('%s'), '' => trim($term_name), '' => trim($vocabulary)));
    $result = array();
    while ($term = db_fetch_object($db_result)) {
        $result[] = $term;
    }

    return $result;
}

/*
 * Implementation of hook_node_submit().
 * We are using this hook to call the properly clear cache since the content is sensitive
 */

function learninglab_node_submit($node, $form, &$form_state) {
// [D7 OK]
    switch ($node->form_id) {
        case 'announcement_node_form':
            _learninglab_clear_specific_cache_announcement();
            break;
        default:
            break;
    }
}

function _learninglab_tools_upload_validate($field) {
    $errors = array();

    // Extract zip file and check if there is an index.HTML file inside the root folder.

    $zip = new Archive_Zip($field->uri);

    if ($zip) {
        $temp_path = HecorToolWebInternal::get_temp_path_by_file($field);
        $html_root_file = HecorToolWebInternal::get_tool_index_file_name($field);

        $extracted = $zip->extract(array('add_path' => $temp_path));

        if (!file_exists($html_root_file)) {
            $errors[] = t('The zip must have an "index.html" file in its root');
        }
    }

    return $errors;
}

function _learninglab_workflow_after_build($form, &$form_state) {

    // Get the first valid value to set the workbench_access or Section field
    if (!$form['workbench_access']['workbench_access']['#value']) {

        foreach ($form['workbench_access']['workbench_access']['#options'] as $key => $value) {
            if ($key != '') {
                $first_key = $key;
                break;
            }
        }

        $form['workbench_access']['workbench_access']['#value'] = $first_key;
    }
    return $form;
}

/*
 * Implements hook_form_alter().
 */

function learninglab_form_alter(&$form, &$form_state, $form_id) {
    //watchdog('user', 'Form: %formid', array('%formid' => $form_id));
    $workflow_forms_to_check = array(
      'page_node_form',
      'announcement_node_form',
      'header_footer_node_form',
      'navigation_item_node_form',
      'product_disclaimer_node_form',
      'report_an_ae_pqc_node_form',
      'resources_node_form',
      'tools_node_form',
      'multimedia_node_form',
    );

    if (in_array($form_id, $workflow_forms_to_check)) {
        $form['#after_build'][] = '_learninglab_workflow_after_build';
    }
    //page_node_form


    if ($form['#id'] == 'report-an-ae-pqc-node-form') {

        // Adds a validate to the form
        $form['#validate'][] = '_learninglab_pqc_ae_validate';

        // First lets check if there is already a generic content type of this one at the database
        // If so, lets remove the options for the user to add a new one and show a link to edit it.
        $query = new EntityFieldQuery();
        $query->entityCondition('entity_type', 'node')
            ->entityCondition('bundle', 'report_an_ae_pqc')
            ->fieldCondition('field_type', 'value', '1', '=');
        $result = $query->execute();

        //Grab first node object and get the nid value
        if (isset($result['node'])) {
            $node_id = array_keys($result['node']);
            $node_id = $node_id[0];

            // If the node id from the URL is the same as the nid from the
            // general it means it is a edit
            if ($node_id != arg(1)) {
                $form['field_type']['#disabled'] = TRUE;

                $form['field_type']['#suffix'] = '<b>There is already a Generic AE/PQC, if you wish to edit it, please
                        <a href="/node/' . $node_id . '/edit">click here</a></b>';

                drupal_add_js(array('learninglab' => array('aePqcType' => '2')), 'setting');
            }
            else {
                drupal_add_js(array('learninglab' => array('aePqcType' => '1')), 'setting');
            }
        }

        // Now we check if there is already a product that has a PQC and we remove it from the product LIST
        $query = db_select('field_data_field_ae_pqc_product', 'ae_pqc');
        $query->fields('ae_pqc', array('field_ae_pqc_product_nid'));
        $query->condition('entity_id', arg(1), '!=');

        $result = $query->execute();

        while ($result_set = $result->fetchAssoc()) {
            $list_of_ids[] = $result_set['field_ae_pqc_product_nid'];
        }

        if (isset($list_of_ids)) {
            foreach ($form['field_ae_pqc_product'][LANGUAGE_NONE]['#options'] as $key => $check_id) {
                foreach ($list_of_ids as $verify_id) {
                    if ($verify_id == $key) {
                        unset($form['field_ae_pqc_product'][LANGUAGE_NONE]['#options'][$key]);
                    }
                }
            }
        }

        drupal_add_js(drupal_get_path('module', 'learninglab') . '/jscripts/pqc_ae.js', array('type' => 'file', 'weight' => JS_LIBRARY));
    }

    if ($form_id == 'multimedia_node_form') {
        // Adds a validate to the form
        $form['#validate'][] = '_learninglab_multimedia_validate';
    }

    // honeypot zero value validation    
    if ($form_id == '_learninglab_hecor_tools_access_form_page' || $form_id == 'user_login') {
        if (function_exists('honeypot_add_form_protection')) {
            $form['#validate'][] = '_honeypot_zero_value_validate';
            //echo '<pre>'; print_r($form);
        }
    }

    if ($form['#id'] == 'apache-solr-block-form') {
        $form['#validate'][] = '_learninglab_google_appliance_validate';
        $form['actions']['submit']['#attributes'] = array('data-modal-id' => 'modalExternal', 'data-role' => 'modal-open', 'class' => array('btn-primary', 'jmd-btn', 'jmd-btn--search', 'jmd-btn--tall'));
    }



    if ($form['#id'] == 'views-exposed-form-sharepoint-page-page') {
        // Dinamically gets all pructs from nodes
        $product_list = db_select('node');
        $product_list->fields('field_data_field_product', array('field_product_value'));
        $product_list->leftJoin('field_data_field_product', 'field_data_field_product', 'node.vid = field_data_field_product.revision_id');
        $product_list->condition('node.type', 'sharepoint_pages', '=');
        $product_list->orderBy('field_product_value', 'ASC');
        $product_list->distinct();

        $sql_result = $product_list->execute();

        $options = array('' => '-- Select a product');
        while ($products = $sql_result->fetchAssoc()) {
            $options[$products['field_product_value']] = $products['field_product_value'];
        }

        $form['field_product_value'] = array(
          '#type' => 'select',
          '#options' => $options,
          '#default_value' => '',
        );
    }

    // To handle the cache system
    switch ($form_id) {
        case 'views_form_announcements_drag_and_drop_page':
            array_unshift($form['actions']['submit']['#submit'], '_learninglab_clear_specific_cache_announcement');
            break;


        case 'contactus_list':

            if (function_exists('client_remember_me_cookie_exists') && client_remember_me_cookie_exists() && (count(client_remember_me_cookie_get_users()) > 0) && (!$form_state['build_info']['args'][4]) && $form_state['build_info']['args'][5]) {
                $user = array_values(client_remember_me_cookie_get_users());
                $user_date = AuditLogQueue::get_hcp_information($user[0]['external_id']);

                $form['custom_form']['name']['#default_value'] = $user_date['First Name'];
                $form['custom_form']['last_name']['#default_value'] = $user_date['Last Name'];
                $form['custom_form']['zip_code']['#default_value'] = $user_date['Zip Code'];
                $remember_me_label = variable_get('client_remember_me_checkbox_label', 'Remember my information');
                $remember = explode(' ', $user_date[$remember_me_label]);
                $form['custom_form']['client_remember_me']['#default_value'] = ($remember[0] == '1' ? 1 : 0);
                $do_not_contact_label = variable_get('client_remember_me_do_not_contact_me_checkbox_label', 'Do not contact me unless requested');
                $contact = explode(' ', $user_date[$do_not_contact_label]);
                $form['custom_form']['hcp_do_not_contact_me']['#default_value'] = ($contact[0] == '1' ? 1 : 0);
            }

            // HCP Form Maintenance Mode
            if (variable_get('hcp_form_maintenance', FALSE)) {
                $form = array();

                $form['message'] = array(
                  '#type' => 'markup',
                  '#markup' => variable_get('hcp_form_maintenance_message', _learninglab_get_hcp_form_maintenance_message())
                );

                return $form;
            }

            // Set hidden values for the contact us form
            if (!empty($form_state['build_info']['args'][1])) {
                $form['selected_product'] = array(
                  '#type' => 'hidden',
                  '#value' => $form_state['build_info']['args'][1],
                );

                $form['redirect_url'] = array(
                  '#type' => 'hidden',
                  '#value' => $form_state['build_info']['args'][2],
                );

                $form['keyword'] = array(
                  '#type' => 'hidden',
                  '#value' => $form_state['build_info']['args'][3],
                );

                $form['new-user'] = array(
                  '#type' => 'hidden',
                  '#value' => $form_state['build_info']['args'][4],
                );

                $form['is_mobile'] = array(
                  '#type' => 'hidden',
                  '#value' => $form_state['build_info']['args'][5],
                );
            }

            $form['before_custom']['subject']['#type'] = 'value';
            $form['before_custom']['subject']['#value'] = $form['before_custom']['subject']['#default_value'];

            $form['after_custom']['contact_ok']['#value'] = '<span>' . t('Confirm') . '</span>';
            $form['after_custom']['contact_ok']['#attributes'] = array('class' => array('jmd-btn', 'jmd-btn--modal-primary', 'jmd-btn--medium'), 'disabled' => 'disabled');
            $form['after_custom']['contact_ok']['#suffix'] = "</div></div>";

            //Add Honypot
            if (function_exists('honeypot_add_form_protection')) {
                honeypot_add_form_protection($form, $form_state, array('honeypot', 'time_restriction'));
            }

            $cancel_button = array(
              'cancel' => array(
                '#type' => 'button',
                '#value' => 'Cancel',
                '#prefix' => '<div class="jmd-form-btns"><div class="jmd-btn-group"><div class="jmd-popover-container hcp-main-cancel-popover">
        <div class="jmd-popover jmd-popover--search-error" data-role="search-error">
            <div class="jmd-popover-close-container">
                <button class="jmd-popover-close hcp-main-cancel-popover-close" data-role="search-error-close">
                    <span class="jmd-visually-hide">Close</span>
                </button>
            </div>
            <div class="jmd-popover-body">
                <p class="jmd-popover-title">' . strip_tags(variable_get('hcp_cancel_tooltip_message', '<p>Are you sure you want to cancel? We are not currently able to provide a response to your request for Medical Information without confirmation that you are a Healthcare Professional.</p>')) . '</p>
                <div class="jmd-popover-btn-group">
                    <button class="jmd-btn jmd-btn--modal-primary jmd-btn--small hcp-main-cancel-popover-submit" data-role="search-error-confirm">OK</button>
                </div>
            </div>
            <div class="arrow"></div>
        </div>
    </div>',
                '#attributes' => array(
                  'class' => array('btn btn-primary jmd-btn jmd-btn--modal-secondary jmd-btn--medium hcp-cancel-custom'),
                  'data-role' => 'modal-close',
                /* 'data-close' => 'TRUE',
                  'data-buttonconfirm' => t('OK'),
                  'data-functioncallback' => 'tooltip.cancelFormHcp',
                  'id' => array('btn-hcp-form-close'),
                  'data-classpopover' => 'tooltip-cancel-hcpform',
                  /*'data-dismiss' => array('modal'), */
                /* 'data-content' => array(strip_tags(variable_get('hcp_cancel_tooltip_message', '<p>Are you sure you want to cancel? We are not currently able to provide a response to your request for Medical Information without confirmation that you are a Healthcare Professional.</p>'))), */
                ),
              ),
            );

            $form['after_custom'] = $cancel_button + $form['after_custom'];

            // Remove validation of Contact Us since we don't have E-mail field
            if (($key = array_search('contactus_list_validate', $form['#validate'])) !== FALSE) {
                unset($form['#validate'][$key]);
            }

            // Add validation for invalid characters
            //$form = _website_security_preprocess($form);
            // Set customized validation and submission functions
            $form['#validate'][] = '_learninglab_hcp_form_validate';
            $form['#submit'] = array('_learninglab_hcp_form_submit');

            /*    $form['after_custom']['#prefix'] = '<div class="hcp-buttons"><a data-toggle="tooltip" title="' . strip_tags(variable_get('hcp_cancel_tooltip_message', '<p>Are you sure you want to cancel? We are not currently able to provide a response to your request for Medical Information without confirmation that you are a Healthcare Professional.</p>')) . '" id="tooltip-cancel-hcp-form"></a>'; */
            $form['after_custom']['#prefix'] = '<div class="hcp-buttons">';
            $form['after_custom']['#suffix'] = '</div>';

            // Add validation for bValidator
            $form['custom_form']['name']['#attributes'] = array(
              'data-bvalidator-msg' => variable_get('hcp_form_message_first_name'),
              'data-bvalidator' => 'required',
              'class' => array('jmd-form-control')
            );
            $form['custom_form']['last_name']['#attributes'] = array(
              'data-bvalidator-msg' => variable_get('hcp_form_message_last_name'),
              'data-bvalidator' => 'required',
              'class' => array('jmd-form-control')
            );
            $form['custom_form']['zip_code']['#attributes'] = array(
              'data-bvalidator-msg' => variable_get('hcp_form_message_zip_code'),
              'data-bvalidator' => 'required',
              'class' => array('jmd-form-control')
            );
            $form['custom_form']['hcp_confirm']['#attributes'] = array(
              'data-bvalidator-msg' => variable_get('hcp_form_message_healthcare_professional'),
              'data-bvalidator' => 'required',
            );
            $form['custom_form']['hcp_confirm']['#title'] = '';
            //$form['custom_form']['hcp_confirm']['#required'] = 0;

            /* To implement the tooltip as per BuildKit START */
            $form['custom_form']['name']['#attributes'] = array(
              'required' => 'required',
            );
            $form['custom_form']['last_name']['#attributes'] = array(
              'required' => 'required',
            );
            $form['custom_form']['zip_code']['#attributes'] = array(
              'required' => 'required',
            );
            /* To implement the tooltip as per BuildKit END */

            break;
        case 'apache_solr_block_form':
            //Add Honypot
            if (function_exists('honeypot_add_form_protection')) {
                honeypot_add_form_protection($form, $form_state, array('honeypot', 'time_restriction'));
            }
            break;
        case 'user_login':
            //Add Honypot
            if (function_exists('honeypot_add_form_protection')) {
                honeypot_add_form_protection($form, $form_state, array('honeypot', 'time_restriction'));
            }
            break;
        case '_learninglab_hecor_tools_access_form_page':
            //Add Honypot 
            if (function_exists('honeypot_add_form_protection')) {
                honeypot_add_form_protection($form, $form_state, array('honeypot', 'time_restriction'));
            }
            break;
        case 'tools_node_form':
            // form_alter for HECOR TOOLS
            module_load_include('inc', 'learninglab', 'inc/hecor_tools');
            _learninglab_hecor_tools_form_alter($form, $form_state, $form_id);
            break;
        case 'product_page_node_form':
            $form['title']['#attributes'] = array('readonly' => 'readonly');
            #$form['field_prescribing_information']['#access'] = user_access('administer site configuration');
            #$form['field_product_name']['#access'] = user_access('administer site configuration');
            #$form['field_prescribing_link']['#access'] = user_access('administer site configuration');
            #$form['field_generic_name']['#access'] = user_access('administer site configuration');
            #$form['field_boxed_warning']['#access'] = user_access('administer site configuration');
            #$form['field_isi_link']['#access'] = user_access('administer site configuration');
            #$form['field_rems_information']['#access'] = user_access('administer site configuration');
            #$form['field_prod_home_sp_id']['#access'] = user_access('administer site configuration');
            #$form['field_product_base_url']['#access'] = user_access('administer site configuration');
            #$form['field_medication_guide']['#access'] = user_access('administer site configuration');
            #$form['field_gsa_search_limit']['#access'] = user_access('administer site configuration');
            #$form['field_isi_pannel']['#access'] = user_access('administer site configuration');
            #$form['field_indications']['#access'] = user_access('administer site configuration');
            break;
        case 'announcement_node_form':
            $form['#validate'][] = '_learninglab_announcement_validate';
            break;
        case 'system_site_maintenance_mode':
            $form['#submit'][] = '_learninglab_site_maintenance_submit';
            break;
        default;
            break;
    }

    if ($form_id == 'tools_node_form') {
        $form['actions']['submit']['#validate'][] = 'custom_tool_form_validate';
    }
}

/**
 *
 * Implements ajax callback for HCP form submission
 */
function learninglab_hcp_form_ajax_callback($form, &$form_state) {

    return $form;
}

/*
 * Implements hook_form_node_form_alter
 */

function learninglab_form_node_form_alter(&$form, $form_state) {
    // [D7 OK]
    // Disable Path Auto for SharePoint Pages
    if ($form['#node']->type == SHAREPOINT_CONTENT_TYPE_PAGES) {
        $form['path']['pathauto']['#type'] = 'hidden';
        $form['path']['pathauto']['#default_value'] = 0;
        $form['path']['pathauto']['#value'] = 0;
    }
}

function _learninglab_form_after_build($form, &$form_state) {
    if ($form_state['clicked_button']['#value'] == 'Delete') {
        _learninglab_disable_validation($form);
    }
    return $form;
}

/**
 *
 * Break the link, into parts. If you do not do this, the layout of share e-mail will broke.
 * @param string $link
 * @param int $lenght
 * @param array $collection
 */
//@disableshare
/*
  function _learninglab_break_share_link($link, $lenght, $collection = array()) {
  if (strlen($link) > $lenght) {
  $sub_link_to_break = (count($collection) > 0) ? array_pop($collection) : $link;

  $pos = strripos(substr($sub_link_to_break, 0, $lenght), '/');
  if (($pos == 0) || ($pos > $lenght)) {
  $collection[] = substr($sub_link_to_break, 0, $lenght);
  $collection[] = substr($sub_link_to_break, $lenght);
  }else {
  $collection[] = substr($sub_link_to_break, 0, $pos);
  $collection[] = substr($sub_link_to_break, $pos);
  }

  if (strlen(substr($sub_link_to_break, $pos)) > $lenght) {
  return _learninglab_break_share_link($link, $lenght, $collection);
  }
  else {
  $url_to_return = implode('@break_line@', $collection);
  return $url_to_return;
  }
  }
  else{
  return $link;
  }
  }

  function learninglab_mail_alter(&$message) {
  global $base_root;
  if ($message['id'] == 'forward_forward_page') {
  module_load_include('inc', 'learninglab', 'inc/share');

  $site_name = variable_get('site_name', 'JanssenMD&reg;');

  $base_path = url('<front>', array('absolute' => TRUE));
  $base_path = str_replace('https://', 'http://', $base_path);

  $base_path_link = l($base_path, $base_path, $options = array('attributes' => array('title' => $base_path)));

  $privacy_policy_link = "{$base_path}privacy-policy";
  $privacy_policy_link = l('Privacy Policy', $privacy_policy_link, $options = array('attributes' => array('title' => 'Privacy Policy')));

  $node_path = $_GET['path'];
  $node_id = explode('/', $node_path);
  $node_id = array_pop($node_id);
  $page_inf = _learninglab_share_get_page_inf($node_id);

  $product_link = "{$base_path}{$page_inf->product}";
  $product_link = l($product_link, $product_link, $options = array('attributes' => array('title' => $product_link)));

  if ($page_inf) {
  $url = $base_path . $page_inf->canonical_url;
  $link = _learninglab_break_share_link($url, 68);
  $share_link = l($link, $url, $options = array('attributes' => array('title' => $url)));
  $share_link = str_replace('@break_line@', '<br />', $share_link);

  $message['params']['subject'] = str_replace('@component_title@', $page_inf->title, variable_get('forward_emailsubject', ''));


  $message['headers']['Sender'] = $message['headers']['From'] = $message['headers']['Reply-To'] = '"'. $_SESSION['share_mail']['sender_name'].'" <'. $message['params']['from'] .'>';
  //$message['headers']['Sender'] = $message['headers']['From'] = $_SESSION['share_mail']['sender_name'];
  //$message['headers']['Sender'] = $_SESSION['share_mail']['sender_name'];
  unset($_SESSION['share_mail']['sender_name']);

  //      $msg_body = variable_get('forward_emailmessage', '');
  //      $msg_footer = variable_get('forward_emailmessage_footer', '');

  $default_msg = "<p>I found the following information on @product_link@ and thought you'd be interested in it as well. Click the link below to visit the site. You may be prompted to confirm that you are a Healthcare Professional.</p><p>@share_link@</p>";
  $main_content = variable_get('share_email_content', $default_msg);

  $main_content = str_replace(array('<p>', '</p>'), array('', '<br /><br />'), $main_content);

  $default_msg = "<p>This is an automated message that has been sent using the &quot;Share&quot; feature on the @base_path_link@ website. No names, email addresses, or other details were captured during the process. Please feel free to review our @privacy_policy_link@.</p><p>&copy; Medical Information and Services, Janssen Scientific Affairs, LLC 2011-@current_year@. All rights reserved.</p><p>This email is intended for US Healthcare Professionals only.</p>";
  $footer_content = variable_get('share_email_footer', $default_msg);

  $footer_content = str_replace(array('<p>', '</p>'), array('', '<br /><br />'), $footer_content);

  $msg = <<<EOL
  <html>
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>@site_name@</title>
  <style type="text/css">
  img{
  border:0 none;
  display:block;
  }
  a{
  color:#047EC4;
  text-decoration:none;
  }

  </style>
  </head>
  <body bgcolor="#bfd6e0" leftmargin="0" topmargin="0" marginwidth="0" marginheight="0" style="border:0;margin:0; padding:0;">
  <table border="0" cellpadding="0" cellspacing="0" width="100%" bgcolor="#bfd6e0">
  <tr>
  <td>
  <table border="0" cellpadding="0" cellspacing="0" width="650" align="center">
  <tr>
  <td>
  <table border="0" cellpadding="0" cellspacing="0">
  <tr>
  <td width="56" height="40"><img style="display:block" src="@base_path@sites/default/files/images/email/header_1.jpg" alt="" /></td>
  <td width="293"><a href="@base_path@" title="@site_name@"><img style="display:block" src="@base_path@sites/default/files/images/email/header_logo.jpg" alt="@site_name@" /></a></td>
  <td width="301"><img style="display:block" src="@base_path@sites/default/files/images/email/header_2.jpg" alt="" /></td>
  </tr>
  </table>
  </td>
  </tr>
  <tr>
  <td height="15"></td>
  </tr>
  <tr>
  <td>
  <table border="0" cellpadding="0" cellspacing="0" width="650" height="211">
  <tr>
  <td>
  <table border="0" cellpadding="0" cellspacing="0">
  <tr>
  <td width="56" height="15"></td>
  <td width="538"><img style="display:block" src="@base_path@sites/default/files/images/email/body_1.jpg" alt="" /></td>
  <td width="56" height="15"></td>
  </tr>
  </table>
  </td>
  </tr>
  <tr>
  <td>
  <table border="0" cellpadding="0" cellspacing="0" width="650">
  <tr>
  <td width="56" height="15"></td>
  <td>
  <table border="0" cellpadding="0" cellspacing="0" width="539">
  <tr>
  <td height="181" width="18"><img style="display:block" src="@base_path@sites/default/files/images/email/body_l.jpg" alt="" /></td>
  <td width="503" valign="top" bgcolor="#FFFFFF">
  <table border="0" cellpadding="0" cellspacing="0">
  <tr>
  <td width="15"></td>
  <td></td>
  <td height="27" width="15"></td>
  </tr>
  <tr>
  <td></td>
  <td><font face="Arial, Helvetica, sans-serif" color="#333" style="font-size:14px;font-weight:bold;">$main_content</font></td>
  <td></td>
  </tr>
  <tr>
  <td height="15"></td>
  <td></td>
  <td></td>
  </tr>
  </table>
  </td>
  <td width="18"><img style="display:block" src="@base_path@sites/default/files/images/email/body_r.jpg" alt="" /></td>
  </tr>
  </table>
  </td>
  <td width="56" height="15"></td>
  </tr>
  </table>
  </td>
  </tr>
  <tr>
  <td>
  <table border="0" cellpadding="0" cellspacing="0">
  <tr>
  <td width="56" height="15"></td>
  <td width="539"><img style="display:block" src="@base_path@sites/default/files/images/email/body_2.jpg" alt="" /></td>
  <td width="56"></td>
  </tr>
  </table>
  </td>
  </tr>
  </table>
  </td>
  </tr>
  <tr>
  <td>
  <table border="0" cellpadding="0" cellspacing="0">
  <tr>
  <td width="51"></td>
  <td width="538"><table border="0" cellpadding="0" cellspacing="0"><tr><td height="17" width="45"></td><td></td><td></td></tr><tr><td></td><td><font face="Arial, Helvetica, sans-serif" color="#333" style="font-size:13px;font-weight:bold; line-height:20px">$footer_content</font></td><td width="45"></td></tr></table></td>
  <td width="51"></td>
  </tr>
  </table>
  </td>
  <tr>
  </table>
  </td>
  </tr>
  <tr>
  <td height="30"></td>
  </tr>
  </table>
  </body>
  </html>
  EOL;

  $msg = str_replace('@current_year@', date('Y'), $msg);
  $msg = str_replace('@product_name@', $page_inf->product, $msg);
  $msg = str_replace('@base_path@', $base_path, $msg);
  $msg = str_replace('@base_path_link@', $base_path_link, $msg);
  $msg = str_replace('@share_link@', $share_link, $msg);
  $msg = str_replace('@privacy_policy_link@', $privacy_policy_link, $msg);
  $msg = str_replace('@product_link@', $product_link, $msg);
  $msg = str_replace('@site_name@', $site_name, $msg);
  $message['params']['body']  = $msg;

  $message['body'] = $message['params']['body'];
  $message['subject'] = $message['params']['subject'];
  }
  else {
  $message = array();
  }
  }
  }
 */

/**
 * Function to break phrases with defined length, but prioritizing the delimiter, never breaking one word at the middle
 * @param string $text
 * @param integer $length
 * @param string $delimiter
 * @param string $break_indicator
 */
function _learninglab_break_text($text, $length = 70, $delimiter = ' ', $break_indicator = ' ...') {
    $text = strip_tags($text);
    if (strlen($text) > $length) {
        $truncated_text = '';
        $text_pieces = explode($delimiter, $text);
        foreach ($text_pieces as $key => $piece) {
            if (!empty($truncated_text)) {
                if (strlen($truncated_text . $delimiter . $piece . $break_indicator) <= $length) {
                    $truncated_text .= $delimiter . $piece;
                }
                else {
                    break;
                }
            }
            else {
                if (empty($piece)) {
                    $piece = ' ';
                }
                $truncated_text .= $piece;
            }
        }

        if (strlen($truncated_text) < strlen($text)) {
            $truncated_text .= $break_indicator;
        }

        return $truncated_text;
    }
    else {
        return $text;
    }
}

function user_login_final_validate_alter($form, &$form_state) {
    global $user;
    if (!$user->uid) {
        form_set_error('name', t('Invalid username or password.'));
        watchdog('user', 'Login attempt failed for %user.', array('%user' => $form_state['values']['name']));
    }
}

/**
 * Checks if the user is watching a pdf, if yes, return current product.
 */
function _learninglab_is_user_watching_pdf() {
    if (arg(0) == "pdf") {
        if (_learninglab_product_exists(arg(1))) {
            return array('product' => arg(1));
        }
        return FALSE;
    }
    else {
        return FALSE;
    }
}

/*
 * Checks if the user watching the quick links page
 */

function _learninglab_is_user_watching_quick_links() {
    if (arg(0) == "quick-information") {
        return array('product' => arg(1));
    }
    else {
        return FALSE;
    }
}

/*
 * Checks if the user watching the announcements/events page
 */

function _learninglab_is_user_watching_announcements_events_news() {

    if (arg(0) == "aggregator") {
        return array('product' => arg(3));
    }

    if (arg(0) == "all-announcements" || arg(0) == "all-events" || arg(0) == 'announcement') {
        if (arg(1) != 'home') {
            return array('product' => arg(1));
        }
    }
    else {
        return FALSE;
    }
}

function google_appliance_settings_submit($form1, $form) {
    variable_set('search_auto_complete_location', check_plain($form['values']['search_auto_complete_location']));
    variable_set('search_auto_complete', check_plain($form['values']['search_auto_complete']));
    variable_set('search_rss_frequency', check_plain($form['values']['search_rss_frequency']));
    variable_set('search_rss_subscription', check_plain($form['values']['search_rss_subscription']));
    variable_set('search_categorize', check_plain($form['values']['search_categorize']));
    variable_set('search_limit_per_page_desktop', check_plain($form['values']['search_limit_per_page_desktop']));
    variable_set('search_limit_per_page_mobile', check_plain($form['values']['search_limit_per_page_mobile']));
    variable_set('gsa_max_search_limit_per_request', check_plain($form['values']['gsa_max_search_limit_per_request']));

    drupal_set_message('The configurations settings have been saved.');
}

/**
 * Function to save custom fields in its own tables for content types
 * product_page
 * @param string $form Form name
 * @param array &$form_state Form state generated by drupal form handling functions
 * @return NULL Alter pointer variable form_state
 */
function _learninglab_product_page_submit($form, &$form_state) {
    if ($form_state['values']['field_disclaimer'] != '0') {
        $query = 'INSERT INTO {drupal_map_table_disclaimer} values(%d, "%s") ON DUPLICATE KEY UPDATE product_disclaimer_nid = %d';
        // TODO Please convert this statement to the D7 database API syntax.
        /* db_query($query, $form_state['values']['field_disclaimer'], $form_state['values']['field_product_base_url'][0]['value'], $form_state['values']['field_disclaimer']) */
        NULL;
    }
    else {
        $query = 'DELETE FROM {drupal_map_table_disclaimer} WHERE product_name = "%s"';
        // TODO Please review the conversion of this statement to the D7 database API syntax.
        /* db_query($query, $form_state['values']['field_product_base_url'][0]['value']) */
        db_delete('drupal_map_table_disclaimer')
            ->condition('product_name', $form_state['values']['field_product_base_url'][0]['value'])
            ->execute();
    }
}

/**
 * Returns if user is a non administrator user
 */
function _learninglab_is_normal_user() {
    global $user;
    if ($user->uid != 0) {
        if (in_array('content_admin', $user->roles) === FALSE && $user->name != 'site_admin') {
            return TRUE;
        }
        else {
            return FALSE;
        }
    }
    else {
        return 'anonymous';
    }
}

/**
 * Implements hook_filter_info()
 *
 * This is done bypassing the hook_preprocess_node, for some reasong we don't know why
 * this is not working, so we figured out this was the best approach
 *
 * Further info at:
 *
 * https://api.drupal.org/api/drupal/modules!filter!filter.api.php/function/hook_filter_info/7
 *
 */
function learninglab_filter_info() {

    $filters = array(
      'learninglab_basepath_replace' => array(
        'title' => 'Replace basepath from 404 page',
        'description' => 'Replaces placeholders for the nodes',
        'process callback' => '_learninglab_basepath_replace',
        'cache' => FALSE,
      ),
    );

    return $filters;
}

/**
 * Implements the placeholder replace for basepath under page 404.
 *
 */
function _learninglab_basepath_replace($text, $filter, $format, $langcode, $cache, $cache_id) {
    $base_path = url('<front>', array('absolute' => TRUE));
    $base_path_text = trim(str_ireplace(array('http://', 'https://'), array('', ''), $base_path), '/');

    $text = str_replace('@base_path_text@', $base_path_text, $text);
    $text = str_replace('@base_path@', $base_path, $text);

    return $text;
}

function learninglab_preprocess_block(&$variables) {
//  $variables['block']->content = str_replace('@base_path@', $base_path, $variables['block']->content);
//  _special_replace_preprocess($variables['block']->content);
//  _learninglab_replace_publish_year($variables['block']->content);
}

/**
 * Replace the url if the user is using @slide_deck_file@ token
 * from admin interface.
 */
function _learninglab_replace_slidedeck_url(&$content) {
    //Checking if the user is using the placeholder @slide_deck_file@, if so, we need to replace it with the link from div@rel;
    if (strpos($content, '@slide_deck_file@') !== FALSE) {
        $token = '@slide_deck_file@';
        $token_length = strlen($token);

        preg_match_all("/{$token}/", $content, $slides, PREG_OFFSET_CAPTURE);
        preg_match_all('/class="slidedeck-inner".*?rel="(.*?)"/', $content, $slides_path);
//    preg_match_all('/rel="(.*?)"/', $content, $slides_path2);
//    foreach ($slides_path[1] as $key => $path) {
//      if (strpos($path, '/slidedeck/') !== FALSE) {
//        $slides_path[2][] = $path;
//      }
//    }

        $tokens_per_slide = ceil(count($slides[0]) / count($slides_path[1]));

        $displacement = 0;
        $replaced_tokens = 1;
        $slide_path_vector = 0;
        foreach ($slides[0] as $slide) {
            $path_to_replace = $slides_path[1][$slide_path_vector];
            $content = substr_replace($content, $path_to_replace, ($slide[1] + $displacement), $token_length);

            $displacement += (strlen($path_to_replace) - $token_length);
            if ($replaced_tokens >= $tokens_per_slide) {
                $replaced_tokens = 1;
                $slide_path_vector++;
            }
            else {
                $replaced_tokens++;
            }
        }
    }
}

function _learninglab_replace_publish_year(&$content) {
    $lauch_year = date('2011');
    $current_year = date('Y');
    if (($current_year - $lauch_year) == 0) {
        $publish_year = $lauch_year;
    }
    else {
        $publish_year = $lauch_year . '-' . $current_year;
    }

    $content = str_replace('@publish_year@', $publish_year, $content);
}

function _learninglab_get_node_id_by_sharepoint_id($sharepoint_id) {

    /* if (!is_numeric($sharepoint_id)) {
      watchdog('product home page', 'Invalid sharepoint id got in PPI.xml from sharepoint:' . $sharepoint_id);
      return;
      } */

    // Drupal 7 way of gettin things
    $query = new EntityFieldQuery();
    $query->entityCondition('entity_type', 'node')
        ->fieldCondition('field_sharepoint_id', 'value', $sharepoint_id, '=');
    $result = $query->execute();

    //Grab first node object and get the nid value
    if (isset($result['node'])) {
        $node_retrieved = $result['node'];
        foreach ($node_retrieved as $node) {
            $node_id = $node->nid;
        }
    }

    if (!empty($node_id)) {
        return $node_id;
    }
    else {
        watchdog('product home page', 'Node with sharepoin id: ' . $sharepoint_id . ' not found in JanssenMD&reg; data base.');
        return;
    }
}

function _learninglab_get_current_page() {

    static $current_product;

    if (!isset($_SESSION['LAST_ACCESSED_PRODUCT'])) {
        $_SESSION['LAST_ACCESSED_PRODUCT'] = '';
    }


    if (!empty($current_product)) {
        return $current_product;
    }

    if (
        ($user_search = _learninglab_is_user_watching_pdf()) ||
        ($user_search = _learninglab_is_user_searching()) ||
        ($user_search = _learninglab_is_user_watching_announcements_events_news()) ||
        ($user_search = _learninglab_is_user_watching_quick_links())
    ) {
        $current_product = $user_search['product'];
        $_SESSION['LAST_ACCESSED_PRODUCT'] = $current_product;
    }
    else {
        //Gets the current product. It will be used to get the correct tooltip content.
        $node_loaded = node_load(arg(1));

        if (!empty($node_loaded->field_product[LANGUAGE_NONE][0]['value']) && $node_loaded->type == SHAREPOINT_CONTENT_TYPE_PAGES) {
            $current_product = $node_loaded->field_product[LANGUAGE_NONE][0]['value'];
            $_SESSION['LAST_ACCESSED_PRODUCT'] = $current_product;
        }
        elseif ((arg(0) == 'event') || (arg(0) == 'announcement') || (arg(0) == 'all-announcements') || arg(0) == 'print' || arg(0) == 'printpdf') {
            $current_product = arg(1);
        }
        else {
            $query_string_product = _learninglab_get_product_by_querystring();

            if ($query_string_product !== FALSE) {
                $current_product = $query_string_product;
                $_SESSION['LAST_ACCESSED_PRODUCT'] = $query_string_product;
            }
            else {
                $current_product = "home";
            }
        }
    }

    // Check now if we have a node of multimedia, if so we just grab the current product from its node reference
    if (isset($node_loaded->type) && ($node_loaded->type == MULTIMEDIA_NODE)) {
//       $wrapper = entity_metadata_wrapper('node', $node_loaded);
//       $wrapper = $wrapper->field_product_multimedia->value();
//       $current_product = $wrapper->field_product_base_url[LANGUAGE_NONE][0]['value']; 
        $node_id = $node_loaded->field_product_multimedia['und'][0]['nid'];
        $result = db_select("field_data_field_product_base_url", "pbu");
        $result->fields("pbu", array('field_product_base_url_value'));
        $result->condition("pbu.entity_id", $node_id, "=");
        $sql_base_url = $result->execute();
        $current_product = $sql_base_url->fetchAssoc();
        $current_product = $current_product['field_product_base_url_value'];

        // Now we grab current product from this page and cache it
        $product_cache_key = PRODUCT_CACHE_KEY . $current_product;
        if (!cache_get($product_cache_key)) {
            // Product cache
            $product_cache = _learninglab_get_product($current_product);
            cache_set($product_cache_key, $product_cache);
        }
    }
    return $current_product;
}

/**
 *
 * Get the current URL
 * @param array/Bool true $exclude_params - if TRUE exclude all params, if FALSE do not exclude params and if array exclude the params in the array
 */
function _learninglab_get_current_url($exclude_params) {
    global $base_root;
    $url = $base_root . request_uri();
    if (is_array($exclude_params)) {
        //remove query strings in array
        foreach ($exclude_params as $key) {
            $url = preg_replace('/(.*)(?|&)' . $key . '=[^&]+?(&)(.*)/i', '$1$2$4', $url . '&');
        }
    }
    elseif ($exclude_params) {
        //Remove any querystring
        $url = preg_replace('/\?.*/', '', $url);
    }
    return $url;
}

/**
 *
 */
function _learninglab_bb_code_last_modified(&$node) {
    $content = $node->field_footer_secondary_text[LANGUAGE_NONE][0]['value'];
    $changed = '';

    if (strpos($content, '@last_updated@') !== FALSE) {
        $content_type = 'page';

        if (arg(0) == 'node' && is_numeric(arg(1))) {
            $node_loaded = node_load(arg(1));
            if ($node_loaded->type == SHAREPOINT_CONTENT_TYPE_PAGES) {
                $content_type = SHAREPOINT_CONTENT_TYPE_PAGES;
            }
        }

        // If it is the Search Page, the last_updated_date should be the same from Product's Home Page
        if ($is_searching = _learninglab_is_user_searching()) {
            $path = drupal_lookup_path('source', $is_searching['product']);
            if ($path) {
                $product_home_nid = str_replace('node/', '', $path);
                $node_loaded = node_load($product_home_nid);
                if ($node_loaded) {
                    $content_type = SHAREPOINT_CONTENT_TYPE_PAGES;
                }
            }
        }

        if ($content_type == SHAREPOINT_CONTENT_TYPE_PAGES) {

            $query = db_select("node", "n");
            $query->fields("field_data_field_last_reviewed", array("field_last_reviewed_value"));
            $query->join("field_data_field_last_reviewed", "field_data_field_last_reviewed", "field_data_field_last_reviewed.entity_id = n.nid");
            $query->join("field_data_field_product", "field_data_field_product", "field_data_field_product.entity_id = n.nid");
            $query->condition("field_data_field_product.field_product_value", $node_loaded->field_product[LANGUAGE_NONE][0]['value'], "=");
            $query->orderBy("field_data_field_last_reviewed.field_last_reviewed_value", "DESC");
            $query->range(0, 1);
            $sql_result = $query->execute();
            $db_result = $sql_result->fetchObject();

            $changed = $db_result->field_last_reviewed_value;
        }
        else {

            // First we grab the max date from sharepoint pages
            $query = db_select("node", "n");
            $query->fields("field_data_field_last_reviewed", array("field_last_reviewed_value"));
            $query->join("field_data_field_last_reviewed", "field_data_field_last_reviewed", "field_data_field_last_reviewed.entity_id = n.nid");
            $query->orderBy("field_data_field_last_reviewed.field_last_reviewed_value", "DESC");
            $query->range(0, 1);
            $sql_result = $query->execute();
            $db_result = $sql_result->fetchObject();

            $firstDate = (int) $db_result->field_last_reviewed_value;

            $query = db_select("node", "n");
            $query->fields("n", array("changed"));
            $query->orderBy("changed", "DESC");
            $query->range(0, 1);
            $sql_result = $query->execute();
            $db_result = $sql_result->fetchObject();

            $secondDate = (int) $db_result->changed;

            $changed = ($firstDate > $secondDate) ? $firstDate : $secondDate;
        }

        $last_modified_date = date('F d, Y', $changed);
        $node->field_footer_secondary_text[LANGUAGE_NONE][0]['value'] = str_replace('@last_updated@', $last_modified_date, $content);
    }
}

/**
 * Implements hook_filter().
 */
function learninglab_filter_XXX($op, $delta = 0, $format = -1, $text = '') {
    module_load_include('inc', 'learninglab', 'inc/special_replace');

    if ($op == 'list') {
        $list = array();
        $list[0] = t('Specials Replace');
        return $list;
    }
    switch ($delta) {
        case 0:
            switch ($op) {
                case 'description':
                    return _special_replace_filter_description();
                case 'prepare':
                    return $text;
                case 'process':
                    _special_replace_filter_process($text);
                    _flash_replace_preprocess($text);
                    return $text;
                default:
                    return $text;
            }
    }
}

/*
 * Get products from gloabl search
 */

function _learninglab_getProduct_global_search() {
    $result = db_query("SELECT DISTINCT field_product_full_name_value, field_product_value from {content_type_sharepoint_pages} ORDER BY field_product_value;");
    $arr_product = array();
    $arr_product[0] = "Select Product";
    while ($data = db_fetch_array($result)) {
        $label = str_replace(array('&reg;', '&trade;'), array('Â®', 'â¢'), $data["field_product_full_name_value"]);
        $arr_product[$data["field_product_value"]] = $label;
    }
    $arr_product = array_filter($arr_product);
    return $arr_product;
}

/**
 * This helping function converts time to minutes
 * @param int $hour hours in 12 hours pattern
 * @param int $minute Minutes
 * @param time $meridian_time
 * @return int  Minutes in numbers
 */
function _learninglab_convert_in_minutes($hour, $minute, $meridian_time = '') {
    if ($meridian_time == 'pm') {
        $hour += 12;
    }

    return ($hour * 60 + $minute);
}

/*
 * Set default header
 * @param string theme name
 * @param array templete
 * @param object Node
 */

function _learninglab_header_default($theme, $template, $node = NULL) {
    // [D7 OK SHURLY]
    $args = array();
    $products = _learninglab_get_products();
    $current_product = _learninglab_get_current_page();

    if (!in_array($current_product, $products)) {
        $args["logo"] = '<a href="' . url('<front>', array('absolute' => TRUE)) . '" class="logo" title="' . variable_get("site_name", '') . '"><img src="/' . drupal_get_path("theme", $theme) . '/logo.png" alt="' . variable_get("site_name", '') . '" /></a>';
        $args["isProduct"] = FALSE;
    }
    else {
        $args["isProduct"] = TRUE;

        $args["isDislaimer"] = _learninglab_display_disclaimer();

        if (!empty($node) && is_object($node)) {
            $args["nodeType"] = $node->type;
        }
        elseif (menu_get_object()) {
            $args["nodeType"] = menu_get_object()->type;
        }

        //change it to get it from the "session"
        $product = _learninglab_get_product($current_product);

        if (trim($product->title) != "") {
            $args["product_name"] = $product->field_product_name[LANGUAGE_NONE][0]['value'];
            $args["generic_name"] = $product->field_generic_name[LANGUAGE_NONE][0]['value'];
            $args["product_link"] = base_path() . $current_product;
        }
        else {
            $args["product_name"] = "";
            $args["generic_name"] = "";
            watchdog("Product Error", "Failed to load the product: " . $current_product);
        }
    }

    $args["Proj_logo"] = base_path() . drupal_get_path("theme", $theme) . "/images/general/Proj-header.png";

    //Header links
    if (!empty($product->field_prescribing_information[LANGUAGE_NONE][0]['value'])) {
        $args['product_information_links'][0]['class'] = "pdf";
        $args['product_information_links'][0]['link'] = l($product->field_prescribing_information[LANGUAGE_NONE][0]['value'], $product->field_prescribing_link[LANGUAGE_NONE][0]['value'], array('attributes' => array('class' => array('jmd-masthead-utilities-item', 'jmd-masthead-utilities-item--pdf'), "target" => "_blank", "title" => $product->field_prescribing_information[LANGUAGE_NONE][0]['value'])));
    }

    if (!empty($product->field_medication_guide[LANGUAGE_NONE][0]['value'])) {
        $args['product_information_links'][1]['class'] = "pdf";
        $args['product_information_links'][1]['link'] = l(variable_get('medication_guide', "Medication Guide"), $product->field_medication_guide[LANGUAGE_NONE][0]['value'], array('attributes' => array('class' => array('jmd-masthead-utilities-item', 'jmd-masthead-utilities-item--pdf'), "target" => "_blank", "title" => variable_get('medication_guide', "Medication Guide"))));
    }

    if (!empty($product->field_rems_information[LANGUAGE_NONE][0]['value'])) {
        $args['product_information_links'][2]['class'] = "rems";
        $args['product_information_links'][2]['link'] = l(variable_get('rems_information', "Risk Evaluation and Mitigation Strategy (REMS)"), $product->field_rems_information[LANGUAGE_NONE][0]['value'], array('attributes' => array('class' => array('jmd-masthead-utilities-item'), "target" => "_blank", "title" => variable_get('rems_information', "Risk Evaluation and Mitigation Strategy (REMS)"))));
    }

    $args['topic_tiny_url'] = "";
    if ($node != NULL && is_object($node)) {
        $args['topic_tiny_url'] = _learninglab_generate_short_url($node);
    }

    if (!empty($product->field_display_isi_tray[LANGUAGE_NONE][0]['value'])) {
        $args['display_isi'] = $product->field_display_isi_tray[LANGUAGE_NONE][0]['value'];
    }
    // TODO Please change this theme call to use an associative array for the $variables parameter.
    /*     * ****Qrcode removal.******* */
    /* if ($template == 'display_header_print') {
      // QR CODE
      $file = drupal_realpath(file_default_scheme(). '://') .'/restrict/qrcode/'. $args['topic_tiny_url'] .'.png';
      $url = url('<front>', array('absolute' => TRUE)) . $args['topic_tiny_url'];

      _learninglab_create_folder_structure($file);
      QRcode::png($url, $file, QR_ECLEVEL_L, 4, 0, TRUE);
      } */
    /*     * *****End.******* */
    return theme($template, array($args));
}

/**
 * Generate shorten URL for file name
 * @param Obj $node
 * @return String Shorern URL
 */
function _learninglab_generate_short_url($node) {
    $topic_tiny_url = '';
    //($text, $outfile = false, $level = QR_ECLEVEL_L, $size = 3, $margin = 4, $saveandprint=false)
    //we flag this as URL Exists so that it displays but doesn't get saved to the db
    if (!empty($node->field_canonical_url[LANGUAGE_NONE][0]['value'])) {
        $topic_tiny_url = shurly_get_latest_short($node->field_canonical_url[LANGUAGE_NONE][0]['value'], NULL, $node->field_sharepoint_id[LANGUAGE_NONE][0]['value']);
        if (!$topic_tiny_url || empty($topic_tiny_url['source'])) {
            $topic_tiny_url = shurly_next_url();
            shurly_save_url($node->field_canonical_url[LANGUAGE_NONE][0]['value'], $topic_tiny_url, NULL, NULL, $node->field_sharepoint_id[LANGUAGE_NONE][0]['value']);
        }
        else {
            return $topic_tiny_url['source'];
        }
    }
    return $topic_tiny_url;
}

/**
 *
 * Function to verify if the document is "Medical Information" to display another header
 * @param string $default_template
 * @return string $default_template with "_mi" concatenated if needed
 */
function _learninglab_verify_theme_medical_information($default_template) {
    /* [D7 NOK]
      $node = menu_get_object();
      $is_content_browseable = _learninglab_is_content_browsable($node);
      if (MedicalInformationArea::get_status() || (!$is_content_browseable) || (_learninglab_is_user_searching())) {
      $default_template .= '_mi';
      }
     */

    return $default_template;
}

/*
 * This function gets all the list from TA and products to show at home page
 */

function _learninglab_get_front_page_product_ta_list() {
    $view_content = array(
      'products' => views_embed_view('product_list', 'block_1'),
      'ta' => '',
      'home_view_all_link' =>
      array(
        'text' => variable_get('learninglab_view_all_products_text', 'Complete list of products supported by Janssen Pharmaceutical Companies of Johnson & Johnson'),
        'link' => variable_get('learninglab_view_all_products_text_link', '<front>'),
      ),
      'home_page_product_tab_text' => variable_get('learninglab_product_tabs_text'),
      'home_page_ta_tab_text' => variable_get('learninglab_ta_tabs_text')
    );

    return theme('home_page_product_ta_list', array('view_content' => $view_content));
}

/**
 * This function returns the website header of the site
 *
 */
function _learninglab_get_website_header_footer($template) {

    $query = db_select("node", "n")
        ->fields("n", array("nid"))
        ->condition("type", "header_footer", "=")
        ->orderBy("created", "DESC")
        ->range(0, 1)
        ->execute();

    $node = $query->fetchAssoc();
    $node = node_load($node['nid']);

    //Replaces last updated date here
    _learninglab_bb_code_last_modified($node);

    return theme($template, array('node' => $node));
}

function _learninglab_get_header_search_bar() {
    if (module_exists('jmdsolr')) {
        $search_module = module_invoke('jmdsolr', 'block_view', 'as_block_search_form');

        $page_status = _learninglab_check_404_status();

        if ($page_status['product'] != 'home' || !$page_status['404']) {

            if (drupal_is_front_page()) {

                return theme('display_header_search', array(
                  'args' => $search_module['content'],
                  'empty_message' => variable_get('empty_query_search_msg'),
                    )
                );
            }
            else {

                return theme('display_product_header_search', array(
                  'args' => $search_module['content'],
                  'empty_message' => variable_get('empty_query_search_msg'),
                    )
                );
            }
        }
        else {
            return '';
        }
    }
}

function _learninglab_header_web() {
    $page_status = _learninglab_check_404_status();
    if ($page_status['product'] != 'home' || !$page_status['404']) {
        #return _learninglab_header_default('learninglab_web_theme', _learninglab_verify_theme_medical_information('display_header_web'));
        return _learninglab_header_default('jmd_subtheme', _learninglab_verify_theme_medical_information('display_header_web'));
    }
    else {
        return '';
    }
}

function _learninglab_header_print($node) {
    return _learninglab_header_default('Projmd', 'display_header_print', $node);
}

function _learninglab_header_mobile() {
    return _learninglab_header_default("learninglab_mobile_theme", _learninglab_verify_theme_medical_information('display_header_mobile'));
}

function _learninglab_product_information_mobile() {
    return _learninglab_header_default("learninglab_mobile_theme", "display_product_information_mobile");
}

function _learninglab_quick_links_web() {
    if (MedicalInformationArea::get_status() == TRUE) {
        return '';
    }
    $args = array();

    $current_product = _learninglab_get_current_page();
    $product_info = _learninglab_get_product($current_product);

    if ($product_info->field_quick_info_enabled_value == 1 || is_null($product_info->field_quick_info_enabled_value)) {
        $args['quick_links_max'] = variable_get('max_quick_links_web', '10');
        $args['quick_links'] = _learninglab_get_quick_links($current_product);
        $args['current_product'] = $current_product;
    }

    if (count($args['quick_links']['quick_link']) > 0) {
        return theme("display_quick_links_web", array('args' => $args));
    }

    if ((request_uri() == '/admin_menu/side_bar')) {
        return theme("display_quick_links_web", array('args' => ''));
    }

    return '';
}

function _learninglab_quick_links_mobile() {
    $args = array();
    $node = menu_get_object();

    $current_product = _learninglab_get_current_page();

    $product_info = _learninglab_get_product($current_product);

    if ($product_info->field_quick_info_enabled_value == 1 || is_null($product_info->field_quick_info_enabled_value)) {
        $args['quick_links_max'] = variable_get('max_quick_links_mobile', '100');
        $args['quick_links'] = _learninglab_get_quick_links($current_product, $args['quick_links_max']);
        $args['total_quick_links'] = _learninglab_get_quick_links($current_product);
        $args['current_product'] = $current_product;
    }

    if (count($args['quick_links']['quick_link']) > 0 && _learninglab_is_content_browsable($node) == TRUE) {
        return theme("display_quick_links_mobile", array('args' => $args));
    }

    if ((request_uri() == '/admin_menu/side_bar')) {
        return theme("display_quick_links_mobile", array('args' => $args));
    }

    return '';
}

/**
 * Return if the Disclaimer should be removed
 */
function _learninglab_should_disclaimer_be_removed() {
    $node = menu_get_object();
    $is_content_browseable = _learninglab_is_content_browsable($node);
    $is_search_previous_page = _learninglab_is_previous_page_search();

    if (($is_content_browseable) && (!$is_search_previous_page)) {
        return TRUE;
    }
    else {
        return FALSE;
    }
}

/**
 * Return if the previous page is a search
 */
function _learninglab_is_previous_page_search() {
    $previous_page = $_SESSION['HISTORY_NAVIGATION'][1];
    if (isset($_GET['printerfriendly']) && isset($_GET['pdf-version'])) {
        $previous_page = $_SESSION['HISTORY_NAVIGATION'][2];
    }

    if (isset($previous_page)) {
        if (strpos($previous_page, 'search/solr') !== FALSE) {
            return TRUE;
        }
    }

    return FALSE;
}

/**
 * Verify if content is browseable and if last page was a search to display ISI or not
 */
function _learninglab_isi_display() {
    //get product node
    $product_title = _learninglab_get_current_page();
    $node_product = _learninglab_get_product($product_title);

    //get product ISI info (isi_sumary or isi_link fields??)
    $args['display_isi'] = !empty($node_product->field_display_isi_tray[LANGUAGE_NONE][0]['value']) ? $node_product->field_display_isi_tray[LANGUAGE_NONE][0]['value'] : '';
    $isi_text = !empty($node_product->field_isi_pannel[LANGUAGE_NONE][0]['value']) ? $node_product->field_isi_pannel[LANGUAGE_NONE][0]['value'] : '';
    $isi_title = !empty($node_product->field_isi_title[LANGUAGE_NONE][0]['value']) ? $node_product->field_isi_title[LANGUAGE_NONE][0]['value'] : '';

    $args = array();
    $args['isi_text'] = $isi_text;
    $args['isi_title'] = $isi_title;
    $args['display_isi'] = !empty($node_product->field_display_isi_tray[LANGUAGE_NONE][0]['value']) ? $node_product->field_display_isi_tray[LANGUAGE_NONE][0]['value'] : '';
    $args['product_name'] = !empty($node_product->field_product_name[LANGUAGE_NONE][0]['value']) ? $node_product->field_product_name[LANGUAGE_NONE][0]['value'] : '';
    $args['generic_name'] = !empty($node_product->field_generic_name[LANGUAGE_NONE][0]['value']) ? $node_product->field_generic_name[LANGUAGE_NONE][0]['value'] : '';

    return theme('display_isi_footer', array('args' => $args));
}

/**
 * Checks the token in the URL and then replicates it
 * on all the URLs on the page
 */
function _learninglab_insert_url_token(&$content) {
    $tid = AuditLog::get_token_from_url(request_uri());

    if ($tid) {
        $doc = new DOMDocument();
        $doc->loadXML('<content>' . $content . '</content>');

        $xpath = new DOMXPath($doc);

        $anchors = $xpath->query("//a");

        foreach ($anchors as $a) {
            $link = $a->getAttribute("href");
            if (strpos($link, 'tid') || strpos($link, '#') === 0) {
                continue;
            }

            $link = _learninglab_process_url_token($link, $tid);

            $a->setAttribute('href', $link);
        }

        $xml = $doc->saveXML();

        $new_xml = new DOMDocument();
        $new_xml->loadXML($xml);
        $output_xml = $new_xml->saveXML($new_xml->documentElement);

        $replace = array('<content>', '</content>');
        $html = trim(str_replace($replace, '', $output_xml));

        $content = $html;
    }
}

/**
 * Will process the URL and insert the token in the correct place
 */
function _learninglab_process_url_token($link, $tid) {

    if (strpos($link, '#')) {
        $linkWithReference = explode('#', $link);
        $link = $linkWithReference[0];
    }

    if (strpos($link, '?')) {
        $link .= '&tid=' . $tid;
    }
    else {
        $link .= '?tid=' . $tid;
    }

    if (isset($linkWithReference)) {
        $link .= '#' . $linkWithReference[1];
    }

    return $link;
}

function _learninglab_preview_image_content() {
    $args = explode('/', request_uri());
    $topic_id = $args['2'];
    $image_pos = $args['3'];

    if ((int) $topic_id != $topic_id) {
        drupal_not_found();
    }

    $result = db_select('field_data_field_html_content', 'html_content');
    $result->fields('html_content', array('field_html_content_value'));
    $result->leftJoin('node', 'n', 'n.vid = html_content.revision_id');
    $result->condition('entity_id', $topic_id, '=');
    $result->condition('n.status', '1', '=');
    $result->range(0, 1);
    $result = $result->execute();

    $content = $result->fetchAssoc();

    if (!empty($result) && $result->rowCount()) {
        $doc = new DOMDocument();
        $doc->loadXML('<content>' . $content['field_html_content_value'] . '</content>', LIBXML_NOCDATA);
        $xpath = new DOMXPath($doc);

        $content_sunround = $xpath->query("//div[@id='" . $image_pos . "']");
        if ($content_sunround->length > 0) {
            $image = new DOMDocument();
            $image->appendChild($image->importNode($content_sunround->item(0), TRUE));

            return _learninglab_replace_images_url($image->saveXML($image->documentElement));
        }
        else {
            drupal_not_found();
        }
    }
    else {
        drupal_not_found();
    }
}

function _learninglab_get_previous_page($position) {
    global $base_root;
    /* @disablechat
      if (arg(0) == 'start_chat') {
      return $base_root ;
      } */

    if (isset($_SESSION['HISTORY_NAVIGATION'][$position])) {
        $first_element = $_SESSION['HISTORY_NAVIGATION'][$position];

        return $first_element;
    }
    else {
        $current_product = _learninglab_get_current_page();

        if ($current_product != "home") {
            $url = $base_root . "/" . $current_product;
            return str_replace("https:", "http:", $url);
        }

        return $base_root;
    }
}

// Store navigation history in memory to get previous page, since there is one corner case with $_SERVER['HTTP_REFERER'] in ie.
function _learninglab_navigation_history($page) {
    if (!isset($_SESSION['HISTORY_NAVIGATION'])) {
        $_SESSION['HISTORY_NAVIGATION'] = array();
    }
    //verify if the url is HCP
    if ($_SESSION['HCP']['display'] !== TRUE) {
        //Clean up the session, once there is no need to store all the urls.
        if (count($_SESSION['HISTORY_NAVIGATION']) >= 3) {
            array_pop($_SESSION['HISTORY_NAVIGATION']);
        }

        if (!(isset($_POST) && is_array($_POST) && (count($_POST) > 0)) && $_SESSION['HISTORY_NAVIGATION'][0] != $page && (empty($_SERVER['HTTP_X_REQUESTED_WITH']) || strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) != 'xmlhttprequest')) {
            array_unshift($_SESSION['HISTORY_NAVIGATION'], $page);

            if (arg(0) != 'hcp') {
                $_SESSION['hcp_page_redirect'] = $page;
            }
        }
    }
    else {
        $_SESSION['hcp_page_redirect'] = $page;
    }
}

/* @disablechat
  function _learninglab_start_chat() {
  $chat_url = variable_get('chat_url', '');
  $enable_hcp_form_chat = variable_get('display_hcp_chat', FALSE);

  if ($_SESSION['HCP']['is_form_filled'] == TRUE || !$enable_hcp_form_chat) {
  drupal_goto($chat_url);
  exit;
  }
  else {
  $_SESSION['HCP']['outerurl'] = $chat_url;
  return '';
  }
  } */

/**
 *
 * Verify if site maintenance is scheduled, if so and is in maintenance time, set site_offline = 1,
 * else set site_offline = 0.
 * [D7 DONE]
 */
function _learninglab_verify_maintenance() {

    global $base_root, $user;

    if (variable_get('maintenance_theme', 'Bartik') != 'JanssenMD') {
        variable_set('maintenance_theme', 'JanssenMD');
    }

    $today_dt = new DateTime('now');

    $start_maintenance = new DateTime();
    $start_maintenance->setDate(variable_get('start_maintenance_year', ''), variable_get('start_maintenance_month', ''), variable_get('start_maintenance_day', ''));
    $start_maintenance->setTime(variable_get('start_maintenance_hour', '0'), variable_get('start_maintenance_minute', '0'));

    $end_maintenance = new DateTime();
    $end_maintenance->setDate(variable_get('end_maintenance_year', ''), variable_get('end_maintenance_month', ''), variable_get('end_maintenance_day', ''));
    $end_maintenance->setTime(variable_get('end_maintenance_hour', '0'), variable_get('end_maintenance_minute', '0'));

    if (($start_maintenance->format('U') < $today_dt->format('U')) && ($today_dt->format('U') < $end_maintenance->format('U'))) {

        if (variable_get('maintenance_mode', 0) == 0) {
            variable_set('maintenance_mode', 1);
            drupal_flush_all_caches();
        }

        if (strpos(request_uri(), '/home') === FALSE && (strpos(request_uri(), '/user') === FALSE && !$user->uid)) {
            drupal_goto($base_root . '/home');
            exit;
        }
    }
    else { //Need to reset site_offline
        if (variable_get('maintenance_mode', 0) == 0) {
            variable_set('maintenance_mode', 0);
            drupal_flush_all_caches();
        }
    }
}

function _learninglab_get_lastupdate() {
    $sql = 'SELECT max(changed) as last_update from {node} WHERE type = "sharepoint_pages"';
    $result = db_query('SELECT max(changed) as last_update from {node} WHERE type = :type', array(':type' => "sharepoint_pages"));
    $result_obj = db_fetch_object($result);

    return ($result_obj->last_update) ? $result_obj->last_update : strtotime(date('Y-m-d'));
}

function _learninglab_audit_log_progress_status() {
    return drupal_json_output(AuditLogQueue::progress_status());
}

function _learninglab_progress_audit_log() {
    AuditLogQueue::process_queue();
}

function _learninglab_reset_audit_log_queue() {
    AuditLogQueue::reset_queue();
}

function _learninglab_get_audit_log_html() {
    AuditLogQueue::get_audit_log_file();
}

function _learninglab_get_audit_log_report($file) {
    $file_path = 'sites/default/files/audit_log/' . $file;

    drupal_add_http_header('Last-Modified', gmdate('D,d M YH:i:s') . ' GMT');
    drupal_add_http_header('Cache-Control', 'private, max-age=0, must-reavalidate');
    drupal_add_http_header('Pragma', 'private');
    drupal_add_http_header('Content-Type', 'text/csv; charset=UTF-8');
    drupal_add_http_header('Content-Disposition', 'attachment; filename="' . $file . '"');
    drupal_add_http_header('Content-Transfer-Encoding', 'binary');

    readfile($file_path);
    exit;
}

/**
 * Unpublish events when expired and deny access
 */
/*
  function _learninglab_check_expired_contents(&$node) {
  if ($node->field_publish_content[0]['value'] != 1) {
  if (arg(2) != 'edit') {
  $node->status = 0;
  node_save($node);
  }
  }
  else {
  $end_date = $node->field_event_end_date[0]['value'];
  if (!empty($end_date)) {
  $today = strtotime(date('Y-m-d 00:00:00'));
  if ($today > strtotime($end_date)) {
  if (arg(2) != 'edit') {
  $node->status = 0;
  node_save($node);
  }
  }
  }
  }
  }
 */

function _learninglab_event_form_validate($form, &$form_state) {
    $start_time = strtotime($form_state['values']['field_event_start_date'][0]['value']);
    $end_time = strtotime($form_state['values']['field_event_end_date'][0]['value']);

    if ($end_time < $start_time) {
        form_set_error('field_event_end_date', 'The Event End Date must be later or equal than the Event Start Date.');
    }

    if (($form_state['values']['field_publish_content']['0']['value'] == 1) && (!empty($form_state['values']['field_event_end_date'][0]['value']))) {
        $today = strtotime(date('Y-m-d 00:00:00'));
        if ($end_time < $today) {
            form_set_error('field_event_end_date', 'The Event End Date must be later or equal than today.');
        }
    }
}

function _learninglab_get_all_product_and_url($to_array = FALSE) {
    /* [D7_MODULE_ADAPTATION BEGIN]
      //static cache (only in same request)
      static $products_array;
      static $products_string;

      if ($to_array && is_array($products_array)) {
      return $products_array;
      }
      else if (!$to_array && $products_string !== FALSE && !is_null($products_string)) {
      return $products_string;
      }

      $db_result = array();
      $products = array();

      $sql = 'SELECT field_product_name_value AS product_name,
      field_product_base_url_value AS url
      FROM node n INNER JOIN content_type_product_page pp ON n.vid = pp.vid ORDER BY product_name';
      $db_result = db_query($sql);

      while ($product = db_fetch_object($db_result)) {
      $products[] = $product;
      }

      $db_result = $products;

      if ($to_array) {
      $products_array = array();
      foreach ($db_result as $key => $product) {
      $products_array[$product->url] = $product->product_name;
      }
      return $products_array;
      }
      else {
      $products_string = FALSE;
      foreach ($db_result as $key => $product) {
      $products_string .= $product->url . '|' . $product->product_name . PHP_EOL;
      }
      return $products_string;
      }
     * [D7_MODULE_ADAPTATION END]
     */
}

function _learninglab_get_all_product_name($to_array = FALSE) {
    static $products_array;
    static $products_string;

    //static cache (only in same request)
    if ($to_array && !empty($products_array)) {
        return $products_array;
    }
    else if (!$to_array && $products_string !== FALSE && !is_null($products_string)) {
        return $products_string;
    }

    $sql = 'SELECT field_product_name_value AS product_name
         FROM node n INNER JOIN content_type_product_page pp ON n.vid = pp.vid ORDER BY product_name';
    $sql_result = db_query($sql);

    if ($to_array) {
        $products_array = array();
        while ($product = db_fetch_object($sql_result)) {
            $products_array[$product->product_name] = $product->product_name;
        }
        return $products_array;
    }
    else {
        $products_string = FALSE;
        while ($product = db_fetch_object($sql_result)) {
            $products_string .= $product->product_name . '|' . $product->product_name . PHP_EOL;
        }
        return $products_string;
    }
}

/**
 * Function to get all the created producs and return a string
 * with "|" separator.
 */
function _learninglab_get_all_products_with_pipe() {
    $aux_cont = 0;
    $string_produts = '';
    //Get all products
    $products = array_merge(array('home' => 'Home'), _learninglab_get_all_product_and_url(TRUE));
    foreach ($products as $product_key => $product_name) {
        $aux_cont++;
        if ($aux_cont == count($products)) {
            $string_produts .= "$product_key|$product_name";
        }
        else {
            $string_produts .= "$product_key|$product_name|" . PHP_EOL;
        }
    }
    return $string_produts;
}

function _learninglab_custom_block($row) {
    $args['subject'] = $row->title;
    $args['url'] = $row->field_widget_url_value;
    return theme('block-aggregator', array('block' => $args));
}

function _learninglab_news_form_validate($form, &$form_state) {
    if (strpos($form_state['values']['title'], '#') !== FALSE) {
        form_set_error('title', 'Invalid character on the field Title. The character Number sign (#) is not allowed.');
    }

    if (strpos($form_state['values']['title'], "'") !== FALSE) {
        form_set_error('title', "Invalid character on the field Title. The character apostrophe (') is not allowed.");
    }
}

function _learninglab_news_form_submit($form, &$form_state) {
    //$form_state['values']['title'] = $form_state['clicked_button']['#post']['title'] .'#'. $form_state['clicked_button']['#post']['product'];
    $form_state['values']['title'] = $form_state['clicked_button']['#post']['title'];
}

function _learninglab_announcement_content() {

    $path = drupal_lookup_path('source', arg(2));

    if ($path === false) {
        return drupal_not_found();
        //return drupal_access_denied();
    }

    if (_learninglab_product_exists(arg(1)) == null && arg(1) != "home") {
        return drupal_not_found();
    }

    $page = explode('/', $path);
    $announcement_node = node_load($page['1']);

    if ($announcement_node->status == 0) {
        $_SESSION['RETIRED_CONTENT_BREADCRUMB'] = TRUE;
        $path = drupal_get_normal_path(variable_get('retired_content_page_url', 'retired-content'));
        $path = explode('/', $path);
        $nid_removed = end($path);
        $removed_content = node_load($nid_removed);
        drupal_set_title($removed_content->title);
        return $removed_content->body[LANGUAGE_NONE][0]['value'];
    }

    return node_page_view($announcement_node);
}

/**
 * Function to show retired contet page when the content is obsolete.
 */
function _learninglab_retired_content() {
    // [D7 OK]
    // Check if user is loggen in, and if so, don't displau retired content page
    if (user_is_logged_in()) {
        return;
    }

    $url_types = array('node', 'file');

    // Do not process retired content on maintenance mode
    if (variable_get('maintenance_mode', 0)) {
        return;
    }

    if (in_array(arg(0), $url_types) && is_numeric(arg(1))) {
        $result = db_query('SELECT type, status
            FROM {node}
            WHERE nid = :nid', array(':nid' => arg(1)));
        $node = $result->fetchObject();

        if ($node) {
            if ($node->status == 0 && !(
                arg(2) == 'edit' ||
                arg(2) == 'delete' ||
                arg(2) == 'moderation' ||
                arg(2) == 'revisions' ||
                arg(2) == 'current-revision'
                )
            ) {

                _learninglab_display_disclaimer(TRUE);
                _learninglab_show_retired_content();
            }
        }
    }
}

function _learninglab_rems_badge_widget() {
    $args = array();
    $product = _learninglab_get_current_page();
    $product_info = _learninglab_get_product($product);
    $args['url'] = $product_info->field_rems_information_value;

    if (($product == 'home' || empty($args['url'])) && request_uri() != '/admin_menu/side_bar') {
        return '';
    }

    $args['top_content'] = $product_info->field_rems_top_text_value;
    $args['bottom_content'] = $product_info->field_rems_bottom_text_value;

    $args['hide_badge'] = $product_info->field_hide_rems_badge_value;

    if (request_uri() == '/admin_menu/side_bar') {
        return theme('rems_badge_widget', array('rems' => $args));
    }

    return theme('rems_badge_widget', array('rems' => $args));
}

/**
 * Function needed to bypass the hardcoded value "5" in module aggregator, when inserting new feeds.
 * This value is responsible to limit the display of itens in the block
 */
function _learninglab_aggregator_form_category_submit($form_id, &$form_values) {

    if (!isset($form_values['values']['delete'])) {

        $cid = db_query('SELECT MAX(cid) as cid FROM {aggregator_category}')->fetchField();
        // TODO Please review the conversion of this statement to the D7 database API syntax.
        /* db_query('UPDATE {aggregator_category} SET block = %d WHERE cid = %d', variable_get('max_news_to_show_on_news_list', 4), $cid) */
        db_update('aggregator_category')
            ->fields(array(
              'block' => variable_get('max_news_to_show_on_news_list', 4),
            ))
            ->condition('cid', $cid)
            ->execute();

        // Get selected products
        if (isset($form_values['clicked_button']['#post']['product'])) {
            $products = $form_values['clicked_button']['#post']['product'];
            $selected_products = '"' . implode('","', $products) . '"';
            // TODO Please convert this statement to the D7 database API syntax.
            /* db_query("INSERT INTO {aggregator_category_product} VALUES (%d,'%s')", $cid, $selected_products) */
            NULL;

            // Creating new block to display the feed
            $pages_to_display = "<?php if ((request_uri() == '/admin_menu/side_bar') ||
                            ((variable_get('block_b-category-' . $cid, 'enable') == 'enable') &&
                            (in_array(_learninglab_get_current_page(),array($selected_products))))) {
                            return TRUE;
                          } ?>";

            $sql = "INSERT INTO {block} (module,delta,theme,status,region,visibility,pages) VALUES ('%s','%s','%s',%d,'%s',%d,'%s')";
            // TODO Please review the conversion of this statement to the D7 database API syntax.
            /* db_query($sql, "aggregator", " $cid", "learninglab_web_theme", 1, "sidebar", 2, $pages_to_display) */
            $id = db_insert('block')
                ->fields(array(
                  'module' => "aggregator",
                  'delta' => " $cid",
                  'theme' => "learninglab_web_theme",
                  'status' => 1,
                  'region' => "sidebar",
                  'visibility' => 2,
                  'pages' => $pages_to_display,
                ))
                ->execute();

            // Update the blocks
            _learninglab_sidebar();
        }
    }
    else {

        $cid = $form_values['values']['cid'];
        if ($cid <= 0) {
            watchdog('Aggregator', 'Error, "cid" not found. Data: ' . print_r($form_values, TRUE));
            return;
        }

        //$sql = "UPDATE {block} SET pages = '' WHERE delta = 'category-%s'";
        $sql = "DELETE FROM {block} WHERE delta = 'category-%s'";
        // TODO Please review the conversion of this statement to the D7 database API syntax.
        /* db_query($sql, $cid) */
        db_delete('block')
            ->condition('delta', $cid)
            ->execute();

        if ($form_values['values']['op'] == 'Delete') {
            // Delete the aggregator_category_product association
            $sql = "DELETE FROM {aggregator_category_product} WHERE cid = %d ";
            // TODO Please review the conversion of this statement to the D7 database API syntax.
            /* db_query($sql, $cid) */
            db_delete('aggregator_category_product')
                ->condition('cid', $cid)
                ->execute();
        }
        else {
            // Get selected products
            if (isset($form_values['clicked_button']['#post']['product'])) {
                $products = $form_values['clicked_button']['#post']['product'];
                $selected_products = '"' . implode('", "', $products) . '"';

                // Delete old record
                $sql = "DELETE FROM {aggregator_category_product} WHERE cid = %d ";
                // TODO Please review the conversion of this statement to the D7 database API syntax.
                /* db_query($sql, $cid) */
                db_delete('aggregator_category_product')
                    ->condition('cid', $cid)
                    ->execute();

                // $sql = "UPDATE {aggregator_category_product} SET product_name = '%s' WHERE cid = %d";
                $sql = "INSERT INTO {aggregator_category_product} VALUES (%d,'%s')";
                // TODO Please convert this statement to the D7 database API syntax.
                /* db_query($sql, $cid, $selected_products) */
                NULL;

                // Update the blocks
                _learninglab_sidebar();
            }
        }
    }
}

function get_canonical_url($node_id, $canonical_url) {
    /* [D7_MODULE_ADAPTATION]
      $base_path = url('<front>', array('absolute' => TRUE));

      $url = drupal_lookup_path('alias', $_GET['q']);
      $product = explode('/', $url);
      if (is_array($product)) {
      if (!empty($product[0])) {
      $product_home_node_alias = drupal_lookup_path('source', $product[0]);
      if ($product_home_node_alias) {
      $node = explode('/', $product_home_node_alias);
      if ($node_id == $node[1]) {
      return $base_path . $product[0];
      }
      }
      }
      }
      return $base_path . $canonical_url;
     *
     */
}

function _learninglab_is_product_home($node_id) {
    static $url;

    if (empty($url)) {
        $url = substr(substr(request_uri(), 0, strpos(request_uri(), '?')), 1);
        if (!$url) {
            $url = substr(request_uri(), 1);
        }
    }
    $current_product = node_load($node_id);
    if ($current_product->type !== SHAREPOINT_CONTENT_TYPE_PAGES || $url == $current_product->field_canonical_url[LANGUAGE_NONE][0]['value']) {
        return FALSE;
    }

    if ($node_id == arg(1)) {
        return TRUE;
    }

    return FALSE;
}

/**
 * Function to shutdown medical dictionary
 */
function _learninglab_medical_dictionary_shutdown() {
    if (connection_status() == CONNECTION_TIMEOUT || (connection_status() == CONNECTION_ABORTED)) {
        variable_set('stop_med_dictinary_import_process', TRUE);
        watchdog('medical dictionary', 'Occurred an error while import the medical dictionary. Try to uploade the file again.', array(), WATCHDOG_ERROR);
        SearchDB::clear_cache(TRUE); //Force search cache clear
    }
}

/**
 * Returns a list of meta tags allowed to be crawled
 */
function _learninglab_allowed_header() {
    $allowed_metatags = array('DC.Title', 'abstract', 'description', 'DC.subject', 'keywords', 'canonical');
    return $allowed_metatags;
}

/**
 * Englobe meta tags not allowed to be crawled with "<!--googleoff: all-->*<!--googleon: all-->"
 * @param string $header_content
 */
function _learninglab_google_off($header_content) {
    $allowed_head = _learninglab_allowed_header();
    preg_match_all('/<.*?\/>/', $header_content, $header_tag);
    if ((is_array($header_tag[0])) && (count($header_tag[0]) > 0)) {
        foreach ($header_tag[0] as $meta_head) {
            preg_match('/<.*(name|rel)="(.*?)".*>/', $meta_head, $meta_name);
            if ((count($meta_name) == 0) || (!in_array($meta_name[2], $allowed_head))) {
                $meta = "<!--googleoff: all-->{$meta_head}<!--googleon: all-->";
                $header_content = str_replace($meta_head, $meta, $header_content);
            }
        }
    }

    return $header_content;
}

/**
 * Return header content
 * @param string $header_content
 * @return string
 */
function _learninglab_hcp_header($header_content) {
    $headers = explode("\n", $header_content);
    foreach ($headers as $h_index => $header) {
        if (strpos($header, 'robots') !== FALSE) {
            unset($headers[$h_index]);
        }
    }

    $headers[] = '<meta name="robots" content="noindex" />';
    $header_content = implode("\n", $headers) . "\n";

    return $header_content;
}

/**
 * Diff 2 given strings
 * @param  string $old old string (before any transformation)
 * @param  string $new new string (after transformations)
 * @return array
 */
function _learninglab_diffstring($old, $new) {
    $maxlen = 0;
    foreach ($old as $oindex => $ovalue) {
        $nkeys = array_keys($new, $ovalue);
        foreach ($nkeys as $nindex) {
            $matrix[$oindex][$nindex] = isset($matrix[$oindex - 1][$nindex - 1]) ?
                $matrix[$oindex - 1][$nindex - 1] + 1 : 1;
            if ($matrix[$oindex][$nindex] > $maxlen) {
                $maxlen = $matrix[$oindex][$nindex];
                $omax = $oindex + 1 - $maxlen;
                $nmax = $nindex + 1 - $maxlen;
            }
        }
    }
    if ($maxlen == 0) {
        return array(array('d' => $old, 'i' => $new));
    }
    return array_merge(
        _learninglab_diffstring(array_slice($old, 0, $omax), array_slice($new, 0, $nmax)), array_slice($new, $nmax, $maxlen), _learninglab_diffstring(array_slice($old, $omax + $maxlen), array_slice($new, $nmax + $maxlen)));
}

/**
 * Generate a diff btween 2 given strings
 * @param  string  $old           old string (before transformation)
 * @param  string  $new           new string (afetr transformation)
 * @param  boolean $keep_old      flag to determine if replaced strings should be displayed
 * @param  string  $highlight_tag the tag that will encapsule the changed words
 * @param  string  $removed_tag   the tag that will encapsule the removed words
 * @return string
 */
function _learninglab_html_diffstring($old, $new) {
    //Compare the diffs
    $diff = new diff_match_patch();
    $dif_match = $diff->diff_main($old, $new);
    $diff->diff_cleanupSemantic($dif_match);
    $suggestion = $diff->diff_prettySuggestion($dif_match);

    return $suggestion;
}

/**
 * Decode a string encode by drupal_urlencode
 * @param  string $string The encoded string
 * @return string
 */
function _learninglab_drupal_urldecode($text) {
    return decode_entities($text);
}

/*
 * Actions mapping.
 */

/**
 * @todo Please document this function.
 * @see http://drupal.org/node/1354
 */
function learninglab_action_info() {
    return array(
      'quick_links_action' => array(
        'label' => t('Quick Links Table Mapping'),
        'type' => 'user',
        'configurable' => FALSE,
        'triggers' => array('any' => FALSE),
      ),
      'remove_disclaimer_action' => array(
        'label' => t('Remove Disclaimer Table Mapping'),
        'type' => 'user',
        'configurable' => FALSE,
        'triggers' => array('any' => FALSE),
      ),
      'flush_block_cache_action' => array(
        'label' => t('Flush block cache'),
        'type' => 'user',
        'configurable' => FALSE,
        'triggers' => array('any' => FALSE),
      ),
      'save_quick_information_action' => array(
        'type' => 'node',
        'label' => t('Save Quick Information into "quick_links_map" table'),
        'configurable' => FALSE,
        'triggers' => array(
          'nodeapi_insert',
          'nodeapi_update',
          'workflow_insert',
          'workflow_update',
        ),
      ),
      'exclude_quick_information_action' => array(
        'type' => 'node',
        'label' => t('Exclude Quick Information from "quick_links_map" table'),
        'configurable' => FALSE,
        'triggers' => array(
          'nodeapi_delete',
          'workflow_delete',
        ),
      ),
      'clear_cache_action' => array(
        'type' => 'node',
        'label' => t('Clear Drupal cache after workflow approval'),
        'configurable' => FALSE,
        'triggers' => array('any' => FALSE),
      ),
    );
}

/*
 * Function to get the latest vid from a specific node.
 * @param node :: node id
 */

function _learninglab_get_correct_revision($node) {
    $vid_to_load = revisioning_get_latest_revision_id($node);
    $node = node_load($node, $vid_to_load);
    return $node->vid;
}

function _learninglab_ql_validate(&$form, &$form_state) {
    $ql = $form_state['values']['field_ext_ql'][0]['value'];
    $ql = trim($ql);
    $product = $form_state['values']['field_product_ext_ql'][0]['value'];

    $nid = $form_state['values']['nid'];

    /* [D7_MODULE_ADAPTATION]
      if (_learninglab_is_ql_exists($ql, $product, $nid)) {
      form_set_error('field_ext_ql][0][value', 'Invalid URL. The URL is already published as Quick Link on the same product.');
      }
     *
     */

    form_set_value($form['field_ext_ql'][0]['value'], $ql, $form_state);
}

/**
 * Remove the H1 inside the content and append it as the first element of the content
 * @param strint $content reference
 */
function _learninglab_blue_bar_product_home(&$content) {
    preg_match('/<h1.*?>.*?<\/h1>/is', $content, $h1_tag, PREG_OFFSET_CAPTURE);
    if (count($h1_tag) > 0) {
        $content_with_blue_bar = $h1_tag[0][0];
        $content_with_blue_bar .= substr_replace($content, '', $h1_tag[0][1], strlen($h1_tag[0][0]));

        //Update the content with the reorganized content
        $content = $content_with_blue_bar;
    }
}

/**
 * Append the H2 element with "Quick Information content_type title" in the start of the content
 * @param strint $content reference
 */
function _learninglab_blue_bar_browseable_product(&$content) {
    //If the user is on MI Area, we must keep Mi Layout.
    if (MedicalInformationArea::get_status() === TRUE) {
        return;
    }

    $quick_information_title = node_type_get_name(QUICKLINK_CONTENT_TYPE);
    $content_with_blue_bar = sprintf('<!--googleoff: all--><h2 class="blue-bar">%s</h2><!--googleon: all-->', $quick_information_title);
    $content_with_blue_bar .= $content;

    //Update the content with the reorganized content
    $content = $content_with_blue_bar;
}

/**
 * Function to verify node content type
 * @param stdClass $node
 * @param string $content_type
 * @return bool TRUE/FALSE
 */
function _learninglab_verify_content_type($node, $content_type) {
    if (!isset($node->type)) {
        return FALSE;
    }
    else {
        return ($node->type == $content_type) ? TRUE : FALSE;
    }
}

/**
 * Function to redirect the final user to product home when he try access by the generic product name
 */
function _learninglab_redirect_product_generic_name() {
    $args = arg();
    $n_args = count($args);
    $node = menu_get_object();

    if (($n_args == 1) && ($node == NULL)) {
        $possible_generic_name = trim(preg_replace(array('/\-{1,}/', '/\_{1,}/', '/\ {1,}/'), ' ', $args[0]));
        if (!empty($possible_generic_name)) {
            $result = db_query("SELECT pp.field_product_base_url_value FROM {content_type_product_page} pp INNER JOIN {node} n ON n.vid = pp.vid WHERE pp.field_generic_name_value = :pp.field_generic_name_value", array(':pp.field_generic_name_value' => $possible_generic_name));
            $product = db_fetch_object($result);
            if ($product) {
                $product_url = url('<front>', array('absolute' => TRUE, 'prefix' => $product->field_product_base_url_value));
                drupal_goto($product_url);
            }
        }
    }
}

/**
 * Function to try catch the current product by the function request_uri()
 * @return if found, return the current product otherwise FALSE
 */
function _learninglab_get_product_by_querystring() {
    // [D7 OK]
    $products = _learninglab_get_products();
    $query_string_product = request_uri();

    if (strpos($query_string_product, '/') !== FALSE) {
        $query_string_product = substr($query_string_product, strpos($query_string_product, '/') + 1);
        $query_string_product = explode('/', $query_string_product);
        $query_string_product = $query_string_product[0];
    }

    if (strpos($query_string_product, '?') !== FALSE) {
        $query_string_product = substr($query_string_product, 0, strpos($query_string_product, '?'));
    }
    elseif (strpos($query_string_product, '#') !== FALSE) {
        $query_string_product = substr($query_string_product, 0, strpos($query_string_product, '#'));
    }

    if (in_array($query_string_product, $products)) {
        return $query_string_product;
    }

    return FALSE;
}

/**
 * Download audit log file
 */
function _learninglab_download_audit_log() {

    $base_path = url('<front>', array('absolute' => FALSE));
    $file_path = _learninglab_file_directory_path() . '/audit_log/';
    $file = variable_get('audit_log_file', 'audit-log');
    $zip_file = $file_path . 'audit_log.zip';
    $full_path = $_SERVER['DOCUMENT_ROOT'] . $base_path . $zip_file;

    if (file_exists($full_path)) {
        drupal_add_http_header('Location', $base_path . $zip_file);
        drupal_exit();
    }
    else {
        return 'File not found';
    }
}

function _learninglab_redirect_to_imce_upload() {
    drupal_goto('imce');
}

/**
 * alter rehash function.
 *
 * This function is called during hook_flush_caches()
 * so the cache settings are updated.
 */
function learninglab_rehash() {
    // TODO Please review the conversion of this statement to the D7 database API syntax.
    /* db_query("UPDATE {block} SET cache = %d WHERE module = '%s'", 1, 'learninglab') */
    db_update('block')
        ->fields(array(
          'cache' => 1,
        ))
        ->condition('module', 'learninglab')
        ->execute();
}

/**
 * Implements hook_flush_caches().
 */
function learninglab_flush_caches() {
    learninglab_rehash();
}

/**
 * Implements hook_file_insert().
 * This hook is called when any file is inserted
 */
function learninglab_file_insert($file) {
    _learninglab_hecor_tools_file_insert($file);
}

/**
 * Implements hook_file_delete().
 * This hook is called after any file is deleted.
 */
function learninglab_file_delete($file) {
    _learninglab_hecor_tools_file_delete($file);
}

function _learninglab_is_pdf($file_path) {

    if (function_exists('mime_content_type')) {
        $mime = mime_content_type($file_path);

        //@todo: REMOVE DEBUG.
        #watchdog('IS PDF', $mime);

        if ($mime) {
            if (strpos(strtolower($mime), 'pdf') !== FALSE) {
                return TRUE;
            }
            else {
                return FALSE;
            }
        }
    }

    // Will reach here only if mime_content_type doesn't exist or returns a non valid value
    $file_ext = end(explode(".", $file_path));
    return (strtolower($file_ext) == 'pdf');
}

function _learninglab_external_search_result($sresult) {
    $file_url = $sresult->file_url;
    $audit_log_id_arr = array();
    if (strpos($_SERVER['HTTP_USER_AGENT'], 'Trident/7.0; rv:11.0') !== false) {
        $sql_for_ie = db_query("SELECT * FROM drupal_audit_log WHERE user_track_id = '" . $_SESSION['InquiryID'] . "' order by id");
        while ($sql_for_ie_res = $sql_for_ie->fetchObject()) {
            if (isset($sql_for_ie_res->page_json) && !empty($sql_for_ie_res->page_json)) {
                $page_json_custom_arr = json_decode(gzinflate($sql_for_ie_res->page_json));

                if (($file_url == $page_json_custom_arr->accessed_url) && ($_SERVER['HTTP_REFERER'] == $page_json_custom_arr->url_referer)) {
                    if (isset($audit_log_id_arr['log_time']) && (((strtotime($sql_for_ie_res->searchdate)) - ($audit_log_id_arr['log_time'])) <= 2)) {
                        db_query("DELETE FROM drupal_audit_log WHERE id= '" . $sql_for_ie_res->id . "'");
                        break;
                    }
                    $audit_log_id_arr['log_time'] = strtotime($sql_for_ie_res->searchdate);
                    $audit_log_id_arr['id'] = strtotime($sql_for_ie_res->id);
                }
            }
        }
    }

    // watchdog("External Search Result", sprintf("Redirecting to %s", $file_url));
    drupal_goto($file_url);
    exit;
}

/**
 * Receiveds an encoded search result URL
 * and return an object with file informations
 *
 * @param encoded external search result URL
 */
function sresult_load($enc_file_path = NULL) {
    $vars = explode(STRING_EXTERNAL_URL_SEPARATOR, $enc_file_path);

    $file_url = _learninglab_decrypt($vars[0]);
    $category = _learninglab_decrypt($vars[1]);
    $subcategory = _learninglab_decrypt($vars[2]);

    $product_name = arg(1);

    $sresult = array(
      'file_url' => $file_url,
      'field_product' => array(LANGUAGE_NONE => array(array('value' => $product_name))),
      'nid' => NULL,
      'vid' => NULL,
      'type' => EXTERNAL_SEARCH_RESULT_CONTENT_TYPE,
      'field_category' => array(LANGUAGE_NONE => array(array('value' => $category))),
      'field_subcategory' => array(LANGUAGE_NONE => array(array('value' => $subcategory))),
    );

    $sresult = (object) $sresult;

    return $sresult;
}

function _learninglab_encrypt($sData, $sKey = 'f48a1f1dedec') {
    $sResult = '';
    for ($i = 0; $i < strlen($sData); $i++) {
        $sChar = substr($sData, $i, 1);
        $sKeyChar = substr($sKey, ($i % strlen($sKey)) - 1, 1);
        $sChar = chr(ord($sChar) + ord($sKeyChar));
        $sResult .= $sChar;
    }
    return _learninglab_encode_base64($sResult);
}

function _learninglab_decrypt($sData, $sKey = 'f48a1f1dedec') {
    $sResult = '';
    $sData = _learninglab_decode_base64($sData);
    for ($i = 0; $i < strlen($sData); $i++) {
        $sChar = substr($sData, $i, 1);
        $sKeyChar = substr($sKey, ($i % strlen($sKey)) - 1, 1);
        $sChar = chr(ord($sChar) - ord($sKeyChar));
        $sResult .= $sChar;
    }
    return $sResult;
}

function _learninglab_encode_base64($sData) {
    $sBase64 = base64_encode($sData);
    return strtr($sBase64, '+/', '-_');
}

function _learninglab_decode_base64($sData) {
    $sBase64 = strtr($sData, '-_', '+/');
    return base64_decode($sBase64);
}

function _learninglab_is_hcp_form_filled() {
    $filled = FALSE;
    if (isset($_SESSION['HCP'])) {
        if (isset($_SESSION['HCP']['display'])) {
            $filled = TRUE;
        }
    }

    $arr_filled = array(
      'filled' => $filled,
    );

    echo json_encode($arr_filled);
    exit;
}

function _learninglab_audit_log_mailer($origin = null) {

    if ($origin == 'CRON') {
        _learninglablog_message("Starting to process CIA Mail queue via Cron..");
    }

    // Call function to send the emails
    Audit_Log_Mailer_Send_Data::get_files_to_send("SEND_EMAIL");
}

function _learninglab_get_referer() {
    if (isset($_SERVER['HTTP_REFERER'])) {
        if (!empty($_SESSION["LAST_PAGE"]) && $_COOKIE['blank_link']) {

            $_COOKIE['blank_link'] = NULL;
            setcookie('blank_link', '', time() - 3600, '/');
            unset($_COOKIE['blank_link']);
            return $_SESSION["LAST_PAGE"];
        }

        return $_SERVER['HTTP_REFERER'];
    }
    return FALSE;
}

function _learninglab_normalize($text, $type = 'underscore') {
    switch ($type) {
        case 'underscore':
            $text = str_replace(' ', '_', strtolower($text));
            break;
    }

    return $text;
}

function _learninglab_is_ajax() {
    if (!empty($_SERVER['HTTP_X_REQUESTED_WITH']) && strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) == 'xmlhttprequest') {
        return TRUE;
    }

    return FALSE;
}

/**
 * Here's a simple recursive function to copy entire directories
 * Note to do your own check to make sure the directory exists that you first call it on.
 *
 */
function _learninglab_recursive_copy($src, $dst) {
    $dir = opendir($src);
    @mkdir($dst);
    while (false !== ( $file = readdir($dir))) {
        if (( $file != '.' ) && ( $file != '..' )) {
            if (is_dir($src . DS . $file)) {
                _learninglab_recursive_copy($src . DS . $file, $dst . DS . $file);
            }
            else {
                copy($src . DS . $file, $dst . DS . $file);
            }
        }
    }
    closedir($dir);
}

/**
 * Recursively delete directories.
 */
function _learninglab_recursive_delete_dir($dir) {
    foreach (glob($dir . '/*') as $file) {
        if (is_dir($file)) {
            _learninglab_recursive_delete_dir($file);
        }
        else {
            unlink($file);
        }
    }
    rmdir($dir);
}

function _learninglab_show_border_top() {
    $show = (HecorSettings::is_download_form_page() || HecorSettings::is_thank_you_page()
        );

    return $show;
}

function _learninglab_show_drupal_messages() {
    $show = FALSE;
    return $show;
}

function _learninglab_valid_zip_code($zip_code) {
    $regex = '/^(\d{5}-\d{4}|\d{5}|\d{9})$/';
    if (preg_match($regex, $zip_code) == 0) {
        return FALSE;
    }
    else {
        return TRUE;
    }
}

function _learninglab_valid_phone_code($phone) {
    $regex = '/^(\+?1-?)?(\([2-9]\d{2}\)|[2-9]\d{2})-?[2-9]\d{2}-?\d{4}$/';
    if (preg_match($regex, $phone) == 0) {
        return FALSE;
    }
    else {
        return TRUE;
    }
}

/**
 * Enable PI navigations
 * @param type $node
 * @return boolean
 */
function _learninglab_enable_pi_navigation($node) {
    if (_learninglab_is_product_home($node->nid)) {
        if (isset($node->field_anchor_navigation[LANGUAGE_NONE][0]['value']) && !empty($node->field_anchor_navigation[LANGUAGE_NONE][0]['value'])) {
            return TRUE;
        }
    }
    else {
        return FALSE;
    }
}

/**
 * Pi Navigation
 * @param type $device
 * @return type
 */
function _learninglab_pi_navigation($device = '') {

    $node = menu_get_object();

    if ($node && _learninglab_enable_pi_navigation($node)) {

        //$anchor_map = unserialize(base64_decode($node->field_anchor_navigation[LANGUAGE_NONE][0]['value']));
        $anchor_map = $node->field_anchor_navigation[LANGUAGE_NONE][0]['value'];
        $button_label = variable_get('pi_nav_topic_button_label', t('Topics'));

        if (!empty($anchor_map)) {
            return theme('pi_navigation', array('anchor_map' => $anchor_map, 'button_label' => $button_label));
            /* if ($device == 'mobile') {
              return theme('pi_navigation_mobile', array('anchor_map' => $anchor_map));
              }
              else {
              return theme('pi_navigation', array('anchor_map' => $anchor_map, 'button_label' => $button_label));
              } */
        }
    }
}

/**
 * Pi navigation content back to top
 * @param type $node
 * @return string
 */
function _learninglab_pi_navigation_back_to_top($node) {
    $html = '';

    $button_title = variable_get('pi_nav_back_to_top_button_label', t('Top'));

    $html = '<div id="pi-navigation-back-to-top" class="default" style="visibility: hidden;">';
    $html .= '<a href="#navbar">%s</a>';
    $html .= '</div>';

    $html .= '<div id="pi-navigation-back-to-top-stopped" class="fixed stopped" style="visibility: hidden;">';
    $html .= '<a href="#navbar">%s</a>';
    $html .= '</div>';

    $html = sprintf($html, $button_title, $button_title);
    $html = '<!--googleoff: all-->' . $html . '<!--googleon: all-->';

    return $html;
}

/**
 * Brightcove JS addition
 */
function _learninglab_add_brightcove_js() {
    $node = menu_get_object();
    if (isset($node)) {
        if ($node->type == SHAREPOINT_CONTENT_TYPE_PAGES || $node->type == MULTIMEDIA_NODE) {
            drupal_add_js('https://sadmin.brightcove.com/js/BrightcoveExperiences.js?r', array('type' => 'external'));
        }
    }
}

/**
 * Top content addition
 * @return type
 */
function _learninglab_back_to_top_content() {
    $title = variable_get('back_to_very_top', 'Back to the top of the page');

    $content = sprintf('<div id="back-to-top-page"><a href="javascript: PiNav.back_to_very_top();">%s</a></div>', $title);

    return $content;
}

/**
 * Methods to implement multimedia replace
 * @param type $content
 * @return type
 */
function _learninglab_multimedia_replace(&$content) {
    /* Excluding special characters before XML conversion */
    $content = str_replace("&lt;", "*JMD_LESS_THAN*", $content);
    $content = str_replace("&amp;", "*JMD_AND*", $content);
    $content = str_replace("&copy;", "*JMD_COPY*", $content);

    $content = html_entity_decode($content);

    $doc = new DOMDocument();
    $doc->loadXML('<content>' . $content . '</content>');

    $xpath = new DOMXPath($doc);
    $multimedias = $xpath->query("//jmdvideo");

    if ($multimedias->length > 0) {
        foreach ($multimedias as $multimedia) {
            $multimedia_url = $multimedia->getAttributeNode("videoid")->value;
            if ($multimedia_url == NULL) {
                $multimedia_url = $multimedia->getAttributeNode("videoId")->value;
            }

            $embbed_multimedia = _learninglab_get_embbed_multimedia($multimedia_url);

            if ($embbed_multimedia && !empty($embbed_multimedia)) {
                $embbed_doc = new DOMDocument();
                $embbed_doc->loadXML($embbed_multimedia);

                $multimedia->parentNode->replaceChild($doc->importNode($embbed_doc->getElementsByTagName('div')->item(0), TRUE), $multimedia);
            }
        }
    }

    $xml = $doc->saveXML();

    $new_xml = new DOMDocument();
    $new_xml->loadXML($xml);
    $output_xml = $new_xml->saveXML($new_xml->documentElement);

    $replace = array('<content>', '</content>');
    $html = trim(str_replace($replace, '', $output_xml));

    /* Reverting back special characters after XML conversion */
    $html = str_replace("*JMD_LESS_THAN*", "&lt;", $html);
    $html = str_replace("*JMD_AND*", "&amp;", $html);
    $html = str_replace("*JMD_COPY*", "&copy;", $html);

    $content = $html;
    return $content;
}

function _learninglab_get_embbed_multimedia($multimedia_url) {

    // Check now witch type is the multimedia and replace it
    $path = drupal_lookup_path('source', $multimedia_url);
    $nid = explode('/', $path);
    $nid = $nid[1];

    $multimedia_node = node_load($nid);

    if ($multimedia_node->field_mm_type[LANGUAGE_NONE][0]['value'] == MULTIMEDIA_VIDEO) {

        // Generates Brightcove HTML
        $html = _learninglab_get_brightcove_embbed_html();
        $html = str_replace('[@video_id@]', $multimedia_node->field_mm_brightcove_id[LANGUAGE_NONE][0]['value'], $html);
    }
    else if ($multimedia_node->field_mm_type[LANGUAGE_NONE][0]['value'] == MULTIMEDIA_CAPTIVATE) {

        // Get captivate attributes from node
        /* REMOVED JMDR-2167
          $captivate_type = $multimedia_node->field_mm_display_thumbnail[LANGUAGE_NONE][0]['value'];
         */
        $captivate_title = $multimedia_node->field_mm_title[LANGUAGE_NONE][0]['value'];

        $file_id = $multimedia_node->field_mm_file[LANGUAGE_NONE][0]['fid'];
        $captivate_file = file_load($file_id);
        $captivate_folder = '/' . _learninglab_file_directory_path() . '/multimedia/' .
            str_replace('.zip', '', $captivate_file->filename) . '/index.html';

        // If thumbnail is set to be displayed
        /* REMOVED JMDR-2167
          if ($captivate_type == '1') {
          $html = _learninglab_get_captivate_embbed_html($captivate_type);
          $html = str_replace('[@multimedia_url@]', $multimedia_url , $html);
          $html = str_replace('[@multimedia_title@]', $captivate_title , $html);
          $html = str_replace('[@multimedia_image_url@]', file_create_url($multimedia_node->field_mm_thumbnail[LANGUAGE_NONE][0]['uri']) , $html);
          $html = str_replace('[@multimedia_image_alt@]', $multimedia_node->field_mm_thumbnail[LANGUAGE_NONE][0]['alt'] , $html);
          $html = str_replace('[@multimedia_image_title@]', $multimedia_node->field_mm_thumbnail[LANGUAGE_NONE][0]['title'] , $html);
          }
          else if ($captivate_type == '0') {
         */
        $html = _learninglab_get_captivate_embbed_html($captivate_type);
        $html = str_replace('[@multimedia_url@]', $multimedia_url, $html);
        $html = str_replace('[@multimedia_folder@]', $captivate_folder, $html);
        /* $html .=  "<script type='text/javascript' src='/sites/all/themes/jmd_subtheme/scripts/pym.js'></script><script>
          var pymParent = new pym.Parent('captivate-embbeded', '".$captivate_folder."', {});
          alert(pymParent);
          </script>"; */
        // echo "<pre>"; print_r($html); exit;
        /* REMOVED JMDR-2167
          }
         */
        //echo $captivate_folder;exit;
        /* $html = '
          <script type="text/javascript" src="/sites/all/themes/jmd_subtheme/scripts/pym.js"></script>
          <div class="captivate-embbeded"></div>
          <script>
          var pymParent = new pym.Parent("captivate-embbeded", "'.$captivate_folder.'", {});
          </script>

          '; */
    }

    return $html;
}

function _learninglab_get_brightcove_embbed_html() {
    $default_html = '
          <div class="brightcoveDesktop">
          <object id="myExperience[@video_id@]" class="BrightcoveExperience">
                <param name="bgcolor" value="#FFFFFF" />
                <param name="width" value="620" />
                <param name="height" value="270" />
                <param name="playerID" value="2893109391001" />
                <param name="playerKey" value="AQ~~,AAABSxB-BAk~,Z07GqU_uHp3xkynUKlIAVgBB4T-w77FV" />
                <param name="isVid" value="true" />
                <param name="isUI" value="true" />
                <param name="wmode" value="transparent" />
                <param name="dynamicStreaming" value="true" />
                <param name="includeAPI" value="true" />
                <param name="templateLoadHandler" value="BCL.onTemplateLoad" />
                <param name="templateReadyHandler" value="BCL.onTemplateReady" />
                <param name="secureConnections" value="true" />
                <param name="secureHTMLConnections" value="true" />
                <param name="@videoPlayer" value="[@video_id@]" />
          </object>
          <script language="JavaScript" type="text/javascript">brightcove.createExperiences();</script>
          </div>';
    $html = variable_get('brightcove_embbed_desktop', $default_html);
    return trim($html);
}

function _learninglab_get_captivate_embbed_html($type) {

    // Thumbnail
    /* REMOVED JMDR-2167
      if ($type == '1') {
      $default_html = '
      <div class="captivate-image-link">
      <a class="captivate-url" target="_blank" href="/[@multimedia_url@]" title="[@multimedia_title@]">
      <img src="[@multimedia_image_url@]" alt="[@multimedia_image_alt@]" title="[@multimedia_image_title@]" class="captivate-image captivate"/>
      </a>
      </div>';
      $html  = variable_get('captivate_embbed_image', $default_html);
      }
      // Embbeded
      else if ($type == '0') {
     */
    $default_html = '
          <div class="captivate-embbeded">
            <iframe style="width:100%;height:200px; visibility:hidden;" class="captivate-iframe" id="capframe" src="[@multimedia_folder@]">
            </iframe>
          </div>';
    $html = variable_get('captivate_embbed_iframe', $default_html);
    /* REMOVED JMDR-2167
      }
     */

    return trim($html);
}

/**
 * Remove a published product from this channel.
 * Also removes all its topics.
 * @param int $product_nid (Product NodeID)
 */
function _learninglab_unpublish_product($product_nid) {
    $nodes_to_delete = array();

    // First we get product base URL from product
    $product_node = node_load($product_nid);
    $product = $product_node->field_product_base_url[LANGUAGE_NONE][0]['value'];

    watchdog('Unpub-Product', sprintf('Removing product %s (%s)...', $product, $product_nid));

    // Now we get every node that uses this product as field product
    $query = new EntityFieldQuery();
    $query->entityCondition('entity_type', 'node')
        ->entityCondition('bundle', 'sharepoint_pages')
        ->fieldCondition('field_product', 'value', $product, '=');
    $result = $query->execute();

    if (isset($result['node'])) {
        $sharepoint_pages = array_keys($result['node']);

        foreach ($sharepoint_pages as $sharepoint_pages_node_ids) {
            $nodes_to_delete[] = $sharepoint_pages_node_ids;
        }
    }

    $nodes_to_delete[] = $product_nid;

    // Delete the Topics and the Product Node
    foreach ($nodes_to_delete as $node_del) {
        node_delete($node_del);
    }

    // Delete Product Files
    if (strlen($product_node->field_product_base_url[LANGUAGE_NONE][0]['value']) > 3) {
        module_load_include('inc', 'learninglab', 'custom_service/custom_service');
        $path = _learninglab_file_directory_path() . '/' . $product_node->field_product_base_url[LANGUAGE_NONE][0]['value'];
        $deleted = deleteAll($path, TRUE);
    }

    watchdog('Unpub-Product', sprintf('Total %s nodes deleted: %s', count($nodes_to_delete), implode(', ', $nodes_to_delete)));

    return $nodes_to_delete;
}

/**
 * Function to check the URLs from MenuRouter table
 */
function check_menu_router() {

    // Get status
    $site_url = 'http://web.llab/';
    $count = 0;
    $sql = "SELECT path FROM {menu_router_prod}";
    $query = db_query($sql);

    while ($menu = db_fetch_object($query)) {
        $count++;

        $url = $menu->path;
        $url = $site_url . str_replace('%', '1', $url);

        //$response  = file_get_contents($url);
        $response = get_headers($url);
        $res_status = $response[0];
        $status_num = substr($res_status, strlen('HTTP/1.1 '), 3);

        if (!isset($status[$status_num])) {
            $status[$status_num] = array();
        }

        $status[$status_num][] = array(
          'status' => $res_status,
          'url' => $url,
        );

        /*
          if ($count >= 100) {
          break;
          }
         */
    }

    // Print Status
    echo "<pre>";
    $s_keys = array_keys($status);
    echo "<h2>Total $count URLs</h2>";

    foreach ($s_keys as $s_key) {
        echo "<h3>Status $s_key</h3>";
        echo str_pad("Status", 30, " ", STR_PAD_RIGHT) . "| URL\n";

        foreach ($status[$s_key] as $s) {
            $st = $s['status'];
            $url = $s['url'];

            echo sprintf("%s| %s\n", str_pad($st, 30, " ", STR_PAD_RIGHT), $url);
        }
    }

    exit;
}

function _learninglab_logout_hcp() {
    session_unset();
    session_destroy();
    session_regenerate_id();

    drupal_set_message('You have been unlogged from HCP area');
    drupal_goto('<front>');
}

/**
 * Implements hook_admin_menu_output_build() to create an admin_menu link
 */
function learninglab_admin_menu_output_build(&$content) {
    global $user;

    /**
     * BASE MENU
     */
    $content['menu']['jmd_content'] = array(
      '#title' => 'JMD Content',
      '#href' => 'jmd_content',
      '#weight' => 46,
    );

    $content['icon']['icon']['learninglab_cron'] = array(
      '#title' => t('Run cron'),
      '#access' => user_access('run cron') && (isset($user->uid) && ($user->uid != 1)),
      '#href' => 'admin_menu/run-cron',
    );

    /* JanssenMDâ¢ Options start */
    if (user_access('administer site configuration')) {
        $content['menu']['admin/settings/Projmd'] = array(
          '#title' => 'JanssenMDÂ® Options',
          '#href' => "admin_menu/settings/Projmd",
          '#weight' => 0,
        );

        /* $content['menu']['admin/settings/Projmd']['admin_menu/config/google_appliance_feed'] = array(
          '#title' => 'Google Appliance Feed',
          '#href' => 'admin_menu/config/google_appliance_feed',
          '#weight' => 1,
          ); */

        /* $content['menu']['admin/settings/Projmd']['admin_menu/config/google_appliance_feed']['admin_menu/config/google_appliance_feed/settings'] = array(
          '#title' => 'Settings',
          '#href' => 'admin_menu/config/google_appliance_feed/settings',
          '#weight' => 1,
          ); */

        /* $content['menu']['admin/settings/Projmd']['admin_menu/config/google_appliance_feed']['admin_menu/config/google_appliance_feed/update'] = array(
          '#title' => 'Update',
          '#href' => 'admin_menu/config/google_appliance_feed/update',
          '#weight' => 2,
          ); */

        $content['menu']['admin/settings/Projmd']['admin_menu/settings/Projmd/maintenance'] = array(
          '#title' => 'Maintenance',
          '#href' => 'admin_menu/settings/Projmd/maintenance',
          '#weight' => 2,
        );

        $content['menu']['admin/settings/Projmd']['admin_menu/settings/Projmd/admin'] = array(
          '#title' => 'Administrator Settings',
          '#href' => 'admin_menu/settings/Projmd/admin',
          '#weight' => 3,
        );

        $content['menu']['admin/settings/Projmd']['admin_menu/settings/Projmd/api-settings'] = array(
          '#title' => 'Jmd Api Settings',
          '#href' => 'admin_menu/settings/Projmd/api-settings',
          '#weight' => 3,
        );
        $content['menu']['admin/settings/Projmd']['admin_menu/settings/Projmd/synonym-list'] = array(
          '#title' => 'Jmd Synonym Settings',
          '#href' => 'admin_menu/settings/Projmd/synonym-list',
          '#weight' => 3,
        );
        $content['menu']['admin/settings/Projmd']['admin_menu/settings/Projmd/ta-settings'] = array(
          '#title' => 'Jmd TA Settings',
          '#href' => 'admin_menu/settings/Projmd/ta-settings',
          '#weight' => 3,
        );

        $content['menu']['admin/settings/Projmd']['admin_menu/settings/Projmd/keywords'] = array(
          '#title' => 'Products Keywords Search Settings',
          '#href' => 'admin_menu/settings/Projmd/keywords',
          '#weight' => 4,
        );

        $content['menu']['admin/settings/Projmd']['admin_menu/gsa_search_limit'] = array(
          '#title' => 'SOLR Search Limit/Search Cache',
          '#href' => 'admin_menu/gsa_search_limit',
          '#weight' => 5,
        );

        $content['menu']['admin/settings/Projmd']['admin/reports/audit-log'] = array(
          '#title' => 'Audit Log',
          '#href' => 'admin/reports/audit-log',
          '#weight' => 6,
        );

        $content['menu']['admin/settings/Projmd']['admin_menu/reports/audit-log-mailer-settings'] = array(
          '#title' => 'Audit Log Mailer Settings',
          '#href' => 'admin_menu/reports/audit-log-mailer-settings',
          '#weight' => 15,
        );
    }

    /**
     * VIEW CONTENT MENU
     */
    $content['menu']['jmd_content']['jmd_content/view_content'] = array(
      '#title' => 'View Content',
      '#href' => 'jmd_content/view_content',
      '#weight' => 0,
    );

    /**
     * SHAREPOINT CONTENT BASE MENU
     */
    $content['menu']['jmd_content']['jmd_content/view_content']['jmd_content/view_content/sharepoint_content'] = array(
      '#title' => 'Sharepoint Content',
      '#href' => 'jmd_content/view_content/sharepoint_content',
      '#weight' => 0,
    );

    /**
     * PRODUCT PAGE CONTENT
     */
    $content['menu']['jmd_content']['jmd_content/view_content']['jmd_content/view_content/sharepoint_content']['jmd_content/view_content/sharepoint_content/product_page'] = array(
      '#title' => 'Product Page',
      '#href' => 'jmd_content/view_content/sharepoint_content/product_page',
      '#weight' => 0,
    );

    /**
     * SHAREPOINT PAGE CONTENT
     */
    $content['menu']['jmd_content']['jmd_content/view_content']['jmd_content/view_content/sharepoint_content']['jmd_content/view_content/sharepoint_content/sharepoint_page'] = array(
      '#title' => 'Sharepoint Page',
      '#href' => 'jmd_content/view_content/sharepoint_content/sharepoint_page',
      '#weight' => 0,
    );

    /**
     * DRUPAL CONTENT BASE MENU
     */
    $content['menu']['jmd_content']['jmd_content/view_content']['jmd_content/view_content/drupal_content'] = array(
      '#title' => 'Drupal Content',
      '#href' => 'jmd_content/view_content/drupal_content',
      '#weight' => 1,
    );

    /**
     * DRUPAL CONTENT LISTING
     */
    $content['menu']['jmd_content']['jmd_content/view_content']['jmd_content/view_content/drupal_content']['jmd_content/view_content/drupal_content/announcement'] = array(
      '#title' => 'Announcement',
      '#href' => 'jmd_content/view_content/drupal_content/announcement',
      '#weight' => 0,
    );

    $content['menu']['jmd_content']['jmd_content/view_content']['jmd_content/view_content/drupal_content']['jmd_content/view_content/drupal_content/page'] = array(
      '#title' => 'Page',
      '#href' => 'jmd_content/view_content/drupal_content/page',
      '#weight' => 1,
    );

    $content['menu']['jmd_content']['jmd_content/view_content']['jmd_content/view_content/drupal_content']['jmd_content/view_content/drupal_content/product_disclaimer'] = array(
      '#title' => 'Product Disclaimer',
      '#href' => 'jmd_content/view_content/drupal_content/product_disclaimer',
      '#weight' => 2,
    );

    $content['menu']['jmd_content']['jmd_content/view_content']['jmd_content/view_content/drupal_content']['jmd_content/view_content/drupal_content/navigation_items'] = array(
      '#title' => 'Navigation Items',
      '#href' => 'jmd_content/view_content/drupal_content/navigation_items',
      '#weight' => 3,
    );

    $content['menu']['jmd_content']['jmd_content/view_content']['jmd_content/view_content/drupal_content']['jmd_content/view_content/drupal_content/tools'] = array(
      '#title' => 'Tools',
      '#href' => 'jmd_content/view_content/drupal_content/tools',
      '#weight' => 4,
    );

    $content['menu']['jmd_content']['jmd_content/view_content']['jmd_content/view_content/drupal_content']['jmd_content/view_content/drupal_content/report-an-ae-pqc'] = array(
      '#title' => 'Report an AE/PQC',
      '#href' => 'jmd_content/view_content/drupal_content/report-an-ae-pqc',
      '#weight' => 5,
    );

    $content['menu']['jmd_content']['jmd_content/view_content']['jmd_content/view_content/drupal_content']
        ['jmd_content/view_content/drupal_content/resources'] = array(
      '#title' => 'Resources',
      '#href' => 'jmd_content/view_content/drupal_content/resources',
      '#weight' => 6,
    );

    $content['menu']['jmd_content']['jmd_content/view_content']['jmd_content/view_content/drupal_content']
        ['jmd_content/view_content/drupal_content/multimedia'] = array(
      '#title' => 'Multimedia',
      '#href' => 'jmd_content/view_content/drupal_content/multimedia',
      '#weight' => 7,
    );

    /**
     * CREATE CONTENT MENU
     */
    $content['menu']['jmd_content']['jmd_content/create_content'] = array(
      '#title' => 'Create Content',
      '#href' => 'jmd_content/create_content',
      '#weight' => 1,
    );

    /**
     * CREATE ANNOUNCEMENT
     */
    $content['menu']['jmd_content']['jmd_content/create_content']['jmd_content/create_content/announcement'] = array(
      '#title' => 'Announcement',
      '#href' => 'jmd_content/create_content/announcement',
      '#weight' => 0,
    );

    /**
     * CREATE PAGE
     */
    $content['menu']['jmd_content']['jmd_content/create_content']['jmd_content/create_content/page'] = array(
      '#title' => 'Page',
      '#href' => 'jmd_content/create_content/page',
      '#weight' => 1,
    );

    /**
     * CREATE PRODUCT DISCLAIMER
     */
    $content['menu']['jmd_content']['jmd_content/create_content']['jmd_content/create_content/product_disclaimer'] = array(
      '#title' => 'Product Disclaimer',
      '#href' => 'jmd_content/create_content/product_disclaimer',
      '#weight' => 2,
    );

    /**
     * CREATE TOOLS
     */
    $content['menu']['jmd_content']['jmd_content/create_content']['jmd_content/create_content/tools'] = array(
      '#title' => 'Tools',
      '#href' => 'jmd_content/create_content/tools',
      '#weight' => 3,
    );

    /**
     * CREATE AE PQC
     */
    $content['menu']['jmd_content']['jmd_content/create_content']['jmd_content/create_content/report-an-ae-pqc'] = array(
      '#title' => 'Report an AE/PQC',
      '#href' => 'jmd_content/create_content/report-an-ae-pqc',
      '#weight' => 4,
    );

    /**
     * CREATE RESOURCES
     */
    $content['menu']['jmd_content']['jmd_content/create_content']['jmd_content/create_content/resources'] = array(
      '#title' => 'Resources',
      '#href' => 'node/add/resources',
      '#weight' => 5,
    );

    /**
     * CREATE MULTIMEDIA
     */
    $content['menu']['jmd_content']['jmd_content/create_content']['jmd_content/create_content/multimedia'] = array(
      '#title' => 'Multimedia',
      '#href' => 'node/add/multimedia',
      '#weight' => 6,
    );

    $content['menu']['jmd_content']['content_repo'] = array(
      '#title' => 'Content Repo',
      '#href' => 'admin/content/jcr',
      '#weight' => 2,
    );

    $content['menu']['jmd_content']['content_repo']['break_lock'] = array(
      '#title' => 'Break Lock',
      '#href' => 'admin/content/jcr/break-lock',
      '#weight' => 2,
    );

    $content['menu']['jmd_content']['configure_content'] = array(
      '#title' => 'Configure Content',
      '#href' => 'jmd_content/configure_content',
      '#weight' => 2,
    );

    $content['menu']['jmd_content']['site_messages'] = array(
      '#title' => 'Site Messages',
      '#href' => 'jmd_content/site_messages',
      '#weight' => 3,
    );

    $content['menu']['jmd_content']['pdf_uploader'] = array(
      '#title' => 'PDF Uploader',
      '#href' => 'jmd_content/pdf_uploader',
      '#weight' => 4,
    );

    $content['menu']['jmd_content']['jmd_content/audit_log'] = array(
      '#title' => 'Audit Log',
      '#href' => 'jmd_content/audit_log',
      '#weight' => 5,
    );

    $content['menu']['jmd_content']['jmd_content/breadcrumb'] = array(
      '#title' => 'Breadcrumb settings',
      '#href' => 'jmd_content/breadcrumb',
      '#weight' => 5,
    );

    $content['menu']['widget_config'] = array(
      '#title' => 'Widget Config',
      '#href' => 'widget_config',
      '#weight' => 48,
    );

    $content['menu']['widget_config']['announcement'] = array(
      '#title' => 'Announcement Widget Config',
      '#href' => 'widget_config/announcement',
      '#weight' => 0,
    );

    $content['menu']['widget_config']['topic_nav'] = array(
      '#title' => 'Topics Title for PI Navigation',
      '#href' => 'widget_config/topic_nav',
      '#weight' => 1,
    );

    $content['menu']['widget_config']['tools'] = array(
      '#title' => 'Tools Widget Settings',
      '#href' => 'widget_config/tools',
      '#weight' => 2,
    );

    $content['menu']['widget_config']['resources'] = array(
      '#title' => 'Resources Widget Config',
      '#href' => 'widget_config/resources',
      '#weight' => 3,
    );

    $content['menu']['widget_config']['audit-log-mailer-settings'] = array(
      '#title' => t('Audit Log Mailer Settings'),
      '#href' => 'admin_menu/reports/audit-log-mailer-settings',
      '#weight' => 4,
    );

    $content['menu']['widget_config']['client-remember-me-config'] = array(
      '#title' => t('JnJ RememberMe Settings'),
      '#href' => 'admin/config/client_remember_me',
      '#weight' => 5,
    );

    $content['menu']['widget_config']['exit-disclaimer'] = array(
      '#title' => t('Exit disclaimer'),
      '#href' => 'admin/config/user-interface/extlink',
      '#weight' => 6,
    );

    $content['menu']['flush_all_caches'] = array(
      '#title' => 'Flush All Caches',
      '#href' => 'flush_all_caches',
      '#weight' => 92,
    );

    /**
     * GSA Configuration Messages
     */
    $content['menu']['search_conf'] = array(
      '#title' => 'Search',
      '#href' => 'search_conf',
      '#weight' => 48,
    );

    $content['menu']['search_conf']['search_conf/product_keyword_search_settings'] = array(
      '#title' => 'Products Keywords Search Settings',
      '#href' => 'admin_menu/settings/Projmd/keywords',
      '#weight' => 1,
    );

    $content['menu']['search_conf']['search_conf/serp_config'] = array(
      '#title' => 'SERP Config',
      '#href' => 'search_conf/serp_config',
      '#weight' => 2,
    );

    $content['menu']['search_conf']['search_conf/gsa_stop_words'] = array(
      '#title' => 'SOLR Stop Words',
      '#href' => 'search_conf/gsa_stop_words',
      '#weight' => 3,
    );

    $content['menu']['search_conf']['search_conf/gsa_messages'] = array(
      '#title' => 'SOLR Messages',
      '#href' => 'search_conf/gsa_messages',
      '#weight' => 4,
    );

    $content['menu']['search_conf']['search_conf/search_results_limit'] = array(
      '#title' => 'Search Results Limit',
      '#href' => 'admin_menu/gsa_search_limit',
      '#weight' => 5,
    );

    $content['menu']['search_conf']['search_conf/solr_search'] = array(
      '#title' => 'Apache Solr Search',
      '#href' => 'admin/config/search/apachesolr',
      '#weight' => 6,
    );

    $content['menu']['search_conf']['search_conf/solr_search']['search_conf/solr_search/attachments'] = array(
      '#title' => 'Attachments',
      '#href' => 'admin/config/search/apachesolr/attachments',
      '#weight' => 7,
    );
    $content['menu']['search_conf']['search_conf/solr_search']['search_conf/solr_search/search-pages'] = array(
      '#title' => 'Pages/Blocks',
      '#href' => 'admin/config/search/apachesolr/search-pages',
      '#weight' => 8,
    );
    $content['menu']['search_conf']['search_conf/solr_search']['search_conf/solr_search/settings'] = array(
      '#title' => 'Settings',
      '#href' => 'admin/config/search/apachesolr/settings',
      '#weight' => 9,
    );

    $content['menu']['search_conf']['search_conf/solr_report'] = array(
      '#title' => 'Solr Index Report',
      '#href' => 'admin/reports/solr-index-report',
      '#weight' => 10,
    );
    return $content;
}

/**
 * Reimplement function menu https://api.drupal.org/api/drupal/includes%21menu.inc/function/menu_local_tasks/7
 *
 */
function _learninglab_menu_local_tasks($level = 0) {
    $data = array();
    $root_path = '';
    $empty = array(
      'tabs' => array(
        'count' => 0,
        'output' => array(),
      ),
      'actions' => array(
        'count' => 0,
        'output' => array(),
      ),
      'root_path' => &$root_path,
    );

    // Set defaults in case there are no actions or tabs.
    $actions = $empty['actions'];
    $tabs = array();

    $path = drupal_lookup_path('source', arg(2));
    if ($path === FALSE) {
        return $empty;
    }

    $router_item = menu_get_item($path);

    // If this router item points to its parent, start from the parents to
    // compute tabs and actions.
    if ($router_item && ($router_item['type'] & MENU_LINKS_TO_PARENT)) {
        $router_item = menu_get_item($router_item['tab_parent_href']);
    }

    // If we failed to fetch a router item or the current user doesn't have
    // access to it, don't bother computing the tabs.
    if (!$router_item || !$router_item['access']) {
        return $empty;
    }

    // Get all tabs (also known as local tasks) and the root page.
    $cid = 'local_tasks:' . $router_item['tab_root'];
    if ($cache = cache_get($cid, 'cache_menu')) {
        $result = $cache->data;
    }
    else {
        $result = db_select('menu_router', NULL, array('fetch' => PDO::FETCH_ASSOC))->fields('menu_router')->condition('tab_root', $router_item['tab_root'])->condition('context', MENU_CONTEXT_INLINE, '<>')->orderBy('weight')->orderBy('title')->execute()->fetchAll();
        cache_set($cid, $result, 'cache_menu');
    }
    $map = $router_item['original_map'];
    $children = array();
    $tasks = array();
    $root_path = $router_item['path'];

    foreach ($result as $item) {
        _menu_translate($item, $map, TRUE);
        if ($item['tab_parent']) {
            // All tabs, but not the root page.
            $children[$item['tab_parent']][$item['path']] = $item;
        }
        // Store the translated item for later use.
        $tasks[$item['path']] = $item;
    }

    // Find all tabs below the current path.
    $path = $router_item['path'];
    // Tab parenting may skip levels, so the number of parts in the path may not
    // equal the depth. Thus we use the $depth counter (offset by 1000 for ksort).
    $depth = 1001;
    $actions['count'] = 0;
    $actions['output'] = array();
    while (isset($children[$path])) {
        $tabs_current = array();
        $actions_current = array();
        $next_path = '';
        $tab_count = 0;
        $action_count = 0;
        foreach ($children[$path] as $item) {
            // Local tasks can be normal items too, so bitmask with
            // MENU_IS_LOCAL_TASK before checking.
            if (!($item['type'] & MENU_IS_LOCAL_TASK)) {
                // This item is not a tab, skip it.
                continue;
            }
            if ($item['access']) {
                $link = $item;
                // The default task is always active. As tabs can be normal items
                // too, so bitmask with MENU_LINKS_TO_PARENT before checking.
                if (($item['type'] & MENU_LINKS_TO_PARENT) == MENU_LINKS_TO_PARENT) {
                    // Find the first parent which is not a default local task or action.
                    for ($p = $item['tab_parent']; ($tasks[$p]['type'] & MENU_LINKS_TO_PARENT) == MENU_LINKS_TO_PARENT; $p = $tasks[$p]['tab_parent'])
                        ;
                    // Use the path of the parent instead.
                    $link['href'] = $tasks[$p]['href'];
                    // Mark the link as active, if the current path happens to be the
                    // path of the default local task itself (i.e., instead of its
                    // tab_parent_href or tab_root_href). Normally, links for default
                    // local tasks link to their parent, but the path of default local
                    // tasks can still be accessed directly, in which case this link
                    // would not be marked as active, since l() only compares the href
                    // with $_GET['q'].
                    if ($link['href'] != $_GET['q']) {
                        $link['localized_options']['attributes']['class'][] = 'active';
                    }
                    $tabs_current[] = array(
                      '#theme' => 'menu_local_task',
                      '#link' => $link,
                      '#active' => TRUE,
                    );
                    $next_path = $item['path'];
                    $tab_count++;
                }
                else {
                    // Actions can be normal items too, so bitmask with
                    // MENU_IS_LOCAL_ACTION before checking.
                    if (($item['type'] & MENU_IS_LOCAL_ACTION) == MENU_IS_LOCAL_ACTION) {
                        // The item is an action, display it as such.
                        $actions_current[] = array(
                          '#theme' => 'menu_local_action',
                          '#link' => $link,
                        );
                        $action_count++;
                    }
                    else {
                        // Otherwise, it's a normal tab.
                        $tabs_current[] = array(
                          '#theme' => 'menu_local_task',
                          '#link' => $link,
                        );
                        $tab_count++;
                    }
                }
            }
        }
        $path = $next_path;
        $tabs[$depth]['count'] = $tab_count;
        $tabs[$depth]['output'] = $tabs_current;
        $actions['count'] += $action_count;
        $actions['output'] = array_merge($actions['output'], $actions_current);
        $depth++;
    }
    $data['actions'] = $actions;
    // Find all tabs at the same level or above the current one.
    $parent = $router_item['tab_parent'];
    $path = $router_item['path'];
    $current = $router_item;
    $depth = 1000;
    while (isset($children[$parent])) {
        $tabs_current = array();
        $next_path = '';
        $next_parent = '';
        $count = 0;
        foreach ($children[$parent] as $item) {
            // Skip local actions.
            if ($item['type'] & MENU_IS_LOCAL_ACTION) {
                continue;
            }
            if ($item['access']) {
                $count++;
                $link = $item;
                // Local tasks can be normal items too, so bitmask with
                // MENU_LINKS_TO_PARENT before checking.
                if (($item['type'] & MENU_LINKS_TO_PARENT) == MENU_LINKS_TO_PARENT) {
                    // Find the first parent which is not a default local task.
                    for ($p = $item['tab_parent']; ($tasks[$p]['type'] & MENU_LINKS_TO_PARENT) == MENU_LINKS_TO_PARENT; $p = $tasks[$p]['tab_parent'])
                        ;
                    // Use the path of the parent instead.
                    $link['href'] = $tasks[$p]['href'];
                    if ($item['path'] == $router_item['path']) {
                        $root_path = $tasks[$p]['path'];
                    }
                }
                // We check for the active tab.
                if ($item['path'] == $path) {
                    // Mark the link as active, if the current path is a (second-level)
                    // local task of a default local task. Since this default local task
                    // links to its parent, l() will not mark it as active, as it only
                    // compares the link's href to $_GET['q'].
                    if ($link['href'] != $_GET['q']) {
                        $link['localized_options']['attributes']['class'][] = 'active';
                    }
                    $tabs_current[] = array(
                      '#theme' => 'menu_local_task',
                      '#link' => $link,
                      '#active' => TRUE,
                    );
                    $next_path = $item['tab_parent'];
                    if (isset($tasks[$next_path])) {
                        $next_parent = $tasks[$next_path]['tab_parent'];
                    }
                }
                else {
                    $tabs_current[] = array(
                      '#theme' => 'menu_local_task',
                      '#link' => $link,
                    );
                }
            }
        }
        $path = $next_path;
        $parent = $next_parent;
        $tabs[$depth]['count'] = $count;
        $tabs[$depth]['output'] = $tabs_current;
        $depth--;
    }
    // Sort by depth.
    ksort($tabs);
    // Remove the depth, we are interested only in their relative placement.
    $tabs = array_values($tabs);
    $data['tabs'] = $tabs;


    if (isset($data['tabs'][$level])) {
        return array(
          'tabs' => $data['tabs'][$level],
          'actions' => $data['actions'],
          'root_path' => $root_path,
        );
    }
    // @todo If there are no tabs, then there still can be actions; for example,
    //   when added via hook_menu_local_tasks_alter().
    elseif (!empty($data['actions']['output'])) {
        return array('actions' => $data['actions']) + $empty;
    }
    return $empty;
}

/**
 * Implements hook_print_pdf_mpdf_alter to set custom values for mpdf
 *
 * @param $mpdf
 *   Current mpdf values and configs
 *
 * @param $html
 *   Current html used to generate the pdf
 *
 */
function learninglab_print_pdf_mpdf_alter(&$mpdf, &$html, $meta) {
    // Set margins
    $mpdf->DeflMargin = 10;
    $mpdf->DefrMargin = 10;
    $mpdf->SetMargins(10, 10, 10);

    // Replace absolute paths to real paths of the files in the filesystem, mpdf
    // needs to access the files disregarding basic authentication
    $base_path = url('', $options = array('absolute' => TRUE));
    $html = str_replace('src="' . $base_path, 'src="file://' . realpath('') . '/', $html);
    $html = str_replace('src=\'' . $base_path, 'src=\'file://' . realpath('') . '/', $html);
    $html = preg_replace('/<alink.*?>/', '', $html);
    $html = preg_replace('/<\/alink>/', '', $html);
    $ar = replaceHref($html);
    foreach ($ar as $val) {
        $val = ">" . $val;
        $tag = implode("<br/>", str_split(strip_tags($val), 65));
        $html = str_replace(strip_tags($val), "" . $tag . "", $html);
    }
    $html = preg_replace('/<table/', '<table style="width: 100%;"', $html . "");
    $html = preg_replace('/<\/table>/', '</table><br/><div style="clear:both;"></div>', $html . "");
    $html = str_replace('\\', '/', $html);

    return $mpdf;
}

/**
 * Implements replaceHref
 */
function replaceHref($html) {
    $match = array();
    $testar = array();

    $value = preg_match_all('/<div class=\"block-to-hide\">(.*?)<\/div>/s', $html, $estimates);
    $html2 = array_filter($estimates[1]);
    $url = preg_match_all('/<a .*?>(.*?)<\/a>/', $html2[0], $match);
    $testar = array_filter($match[1]);
    return $testar;
}

/**
 * Implements hook_pathauto for admin page: admin/config/search/path/patterns
 * Copy node_pathauto() from pathauto.module because it was not triggered by
 * module_invoke_all.
 */
function learninglab_pathauto($op) {
    switch ($op) {
        case 'settings':
            $settings = array();
            $settings['module'] = 'node';
            $settings['token_type'] = 'node';
            $settings['groupheader'] = t('Content paths');
            $settings['patterndescr'] = t('Default path pattern (applies to all content types with blank patterns below)');
            $settings['patterndefault'] = 'content/[node:title]';
            $settings['batch_update_callback'] = 'node_pathauto_bulk_update_batch_process';
            $settings['batch_file'] = drupal_get_path('module', 'pathauto') . '/pathauto.pathauto.inc';

            $languages = array();
            if (module_exists('locale')) {
                $languages = array(LANGUAGE_NONE => t('language neutral')) + locale_language_list('name');
            }

            foreach (node_type_get_names() as $node_type => $node_name) {
                if (count($languages) && variable_get('language_content_type_' . $node_type, 0)) {
                    $settings['patternitems'][$node_type] = t('Default path pattern for @node_type (applies to all @node_type content types with blank patterns below)', array('@node_type' => $node_name));
                    foreach ($languages as $lang_code => $lang_name) {
                        $settings['patternitems'][$node_type . '_' . $lang_code] = t('Pattern for all @language @node_type paths', array('@node_type' => $node_name, '@language' => $lang_name));
                    }
                }
                else {
                    $settings['patternitems'][$node_type] = t('Pattern for all @node_type paths', array('@node_type' => $node_name));
                }
            }
            return (object) $settings;
        default:
            break;
    }
}

/**
 * Implements hook_custom_theme.
 */
function learninglab_custom_theme() {
    if (arg(0) == 'widget_config' || (arg(0) == 'jmd_content' || arg(0) == 'admin_menu' || arg(0) == 'search_conf') && user_access('content admin')) {
        global $conf;
        return $conf['admin_theme'];
    }
}

/*
 * Implements hook_form_builder_types to add '#type' = 'markup' and 'item' for Contact Us forms.
 */

function learninglab_form_builder_types() {
    return array(
      'contactus' => array(
        'item' => array(
          'title' => 'Item',
          'properties' => array(
            'title',
            'key',
            'markup',
            'field_prefix',
            'field_suffix',
            'required',
          ),
          'default' => array(
            '#type' => 'item',
          ),
        ),
        'label' => array(
          'title' => 'Label',
          'properties' => array(
            'title',
            'key',
            'markup',
            'field_prefix',
            'field_suffix',
          ),
          'default' => array(
            '#type' => 'markup',
          ),
        ),
      )
    );
}

/**
 * hook_validate info
 * @param type $form
 * @param type $form_state
 */
function _learninglab_tools_form_validate($form, &$form_state) {
    //drupal_add_js(drupal_get_path('module', 'learninglab') . '/jscripts/tools.js');

    $values = $form_state['values'];

    switch ($values['field_tool_category']['und'][0]['value']) {
        case 'clinical-outcomes-tools':
        case 'rems-tools':
            if (isset($values['field_tool_type']['und'][0]['value'])) {
                if ($values['field_tool_type']['und'][0]['value'] == 0) {
                    //Opt 1 - Web External Hosted
                    if (empty($values['field_external_link_label']['und'][0]['value'])) {
                        form_set_error('field_external_link_label', t('External Link Label field is required.'));
                    }
                    if (empty($values['field_external_link_url']['und'][0]['value'])) {
                        form_set_error('field_external_link_url', t('External Link Url field is required.'));
                    }
                }
                elseif ($values['field_tool_type']['und'][0]['value'] == 1) {
                    //Opt 2 - Web Internal Hosted
                    if (empty($values['field_html_link_label']['und'][0]['value'])) {
                        form_set_error('field_html_link_label', t('HTML Link Label field is required.'));
                    }
                    if ($values['field_file_package']['und'][0]['fid'] == 0) {
                        form_set_error('field_file_package', t('File Package field is required.'));
                    }
                }
                else {
                    //Opt 3 - Download File
                    if (empty($values['field_tool_link_text']['und'][0]['value'])) {
                        form_set_error('field_tool_link_text', t('Tool Link Text field is required.'));
                    }
                    if ($values['field_tool_executable']['und'][0]['fid'] == 0) {
                        form_set_error('field_tool_executable', t('Tool Executable field is required.'));
                    }
                }
            }
            break;
        case 'product-tools':
            if ($values['field_tool_type']['und'][0]['value'] == 0) {
                //Web External Hosted
                if (empty($values['field_external_link_label']['und'][0]['value'])) {
                    form_set_error('field_external_link_label', t('External Link Label field is required.'));
                }
                if (empty($values['field_external_link_url']['und'][0]['value'])) {
                    form_set_error('field_external_link_url', t('External Link Url field is required.'));
                }
            }
            break;
        default:
            break;
    }
}

/**
 * Hook_info implements
 * @return string
 */
function learninglab_libraries_info() {
    $libraries['phpqrcode'] = array(
      'name' => 'phpqrcode',
      'version' => '1',
      'vendor url' => 'http://sourceforge.net/projects/phpqrcode/',
      'download url' => 'http://sourceforge.net/apps/mediawiki/phpqrcode/index.php?title=Main_Page',
      'version arguments' => array(
        'file' => 'VERSION',
        'pattern' => '/(\d+)/',
        'lines' => 1,
      ),
      'files' => array(
        'php' => array(
          'phpqrcode.php',
        ),
      ),
    );

    return $libraries;
}

function _learninglab_get_right_general_tools() {
    // Tool Category Field
    $vid = taxonomy_vocabulary_machine_name_load('tool_category')->vid;
    $options_source = taxonomy_get_tree($vid);

    $special_chars = array('?', ':', '&', '@', '~', '+', '_', '"', "'", ';', '.');

    $options = array();
    foreach ($options_source as $item) {
        $id = str_replace($special_chars, '', $item->name);
        $id = preg_replace('/\s+/', ' ', $id);
        $id = str_replace(' ', '-', $id);
        $id = explode('-', strtolower($id));
        $id = $id[0];
        $options[$id] = $item->name;
    }

    return theme('display_right_general_tools', array('tools' => $options));
}

/**
 * 1. Remove the .zip packaged.
 * 2. Copy the extracted folder from temp_path to default_files path
 * 3. DONE :)
 */
function _learninglab_hecor_tools_file_insert($file) {
    if (isset($file->source) && $file->source == 'field_file_package_und_0') {
        $temp_path = HecorToolWebInternal::get_temp_path_by_file($file);
        $extracted_path = HecorToolWebInternal::get_extracted_path($file->destination);

        _learninglab_recursive_copy($temp_path, $extracted_path);

        HecorSettings::log(sprintf(
                "New file has just been added.
          <ul>
            <li>TempPath: %s</li>s
            <li>Extracted Path: %s</li>
            <li>Backup Path: %s</li>
          </ul>", $temp_path, $extracted_path, $file->destination
        ));
    }
}

/**
 * 1. When a .zip file is deleted, this hook will delete the extracted folder also.
 */
function _learninglab_hecor_tools_file_delete($file) {

    if (strpos($file->uri, 'hecor-files') !== FALSE) {

        // creates now a true path for the file
        $file_url = drupal_realpath($file->uri);

        $extracted_path = HecorToolWebInternal::get_extracted_path($file_url);
        if ($path_exists = file_exists($extracted_path)) {
            _learninglab_recursive_delete_dir($extracted_path);
        }

        HecorSettings::log(sprintf(
                "A file has just been deleted.
      <ul>
        <li>FID: %s</li>
        <li>Extracted Path: %s</li>
        <li>Backup Path: %s</li>
        <li>Backup Path Exists: %s</li>
      </ul>", $file->fid, $extracted_path, $file->uri, $path_exists
        ));
    }
}

function learninglab_get_all_therapeutic_area_list() {
    return _learninglab_get_all_therapeutic_area();
}

function learninglab_get_products_list() {
    // Products: visible only for Product Tools category
    $options_source = _learninglab_get_products();
    $options = array();
    foreach ($options_source as $key => $value) {
        $id = str_replace(' ', '-', $value);
        $options[$id] = $value;
    }
    return $options;
}

function _learninglab_field_tool_category_list() {
    // Tool Category Field
    $vid = taxonomy_vocabulary_machine_name_load('tool_category')->vid;
    $options_source = taxonomy_get_tree($vid);

    $special_chars = array('?', ':', '&', '@', '~', '+', '_', '"', "'", ';', '.');

    $options = array();
    foreach ($options_source as $item) {
        $id = str_replace($special_chars, '', $item->name);
        $id = preg_replace('/\s+/', ' ', $id);
        $id = str_replace(' ', '-', $id);
        $id = strtolower($id);
        $options[$id] = $item->name;
    }
    $options['product-tools'] = t('Product Specific Tools');

    return $options;
}

function learninglab_menu_alter(&$items) {
    //Enable external links configuration be accessed by content admins.
    $items['admin/config/user-interface/extlink']['access arguments'][0] = 'content admin';
}

/**
 * Implements hook_admin_menu_output_alter().
 */
function learninglab_admin_menu_output_alter(&$content) {
    global $user;
    $roles = $user->roles;
    if ((count($user->roles) > 0) && (in_array('content_admin', $roles) === TRUE)) {
        unset($content['menu']['admin/content']);
        unset($content['menu']['admin/config']);
        unset($content['menu']['admin/help']);
    }
}

/**
 * Implements hook_views_query_alter().
 */
function tools_views_views_query_alter(&$view, &$query) {
    if ($view->name == 'tools') {
        $workbench_enabled = module_exists('workbench');

        if ($workbench_enabled) {
            if (isset($query->table_queue['workbench_moderation_node_history'])) {
                $query->table_queue['workbench_moderation_node_history']['join']->type = 'LEFT';
            }
        }
    }
}

/**
 * Function for customize modal exitlink.
 * @author Rafael Rhormens <rrhorme@its.client.com>
 * @see  inc/modal.inc call function theme
 * @return String return modal-exitlink.tpl.php
 */
function _learninglab_modal_exitlink() {
    module_load_include('inc', 'learninglab', 'inc/modals');
    $call_theme = _learninglab_exitlink_call_theme();
    return $call_theme;
}

/**
 * Function for customize modal images.
 * @author Rafael Rhormens <rrhorme@its.client.com>
 * @see  inc/modal.inc Call function theme.
 * @return String return modal-images.tpl.php.
 */
function _learninglab_modal_images() {
    module_load_include('inc', 'learninglab', 'inc/modals');
    $call_theme = _learninglab_images_call_theme();
    return $call_theme;
}

/**
 * Function for customize modal tables.
 * @author Rafael Rhormens <rrhorme@its.client.com>
 * @see  inc/modal.inc Call function theme.
 * @return String return modal-table.tpl.php.
 */
function _learninglab_modal_table() {
    module_load_include('inc', 'learninglab', 'inc/modals');
    $call_theme = _learninglab_table_call_theme();
    return $call_theme;
}

/**
 * Function for customize modal ajax with header and footer.
 * @author Rafael Rhormens <rrhorme@its.client.com>
 * @see  inc/modal.inc Call function theme.
 * @return String return modal-ajax-with-header-footer.tpl.php.
 */
function _learninglab_modal_ajax_with_header_footer() {
    module_load_include('inc', 'learninglab', 'inc/modals');
    $call_theme = _learninglab_ajax_with_header_footer_call_theme();
    return $call_theme;
}

/**
 * Function for customize modal ajax with header.
 * @author Rafael Rhormens <rrhorme@its.client.com>
 * @see  inc/modal.inc Call function theme.
 * @return String return modal-ajax-with-header.tpl.php.
 */
function _learninglab_modal_ajax_with_header() {
    module_load_include('inc', 'learninglab', 'inc/modals');
    $call_theme = _learninglab_ajax_with_header_call_theme();
    return $call_theme;
}

/**
 * Function for customize modal AE/PQC.
 * @author Rafael Rhormens <rrhorme@its.client.com>
 * @see  inc/modal.inc Call function theme.
 * @return String return modal-ae-pqc.tpl.php.
 */
function _learninglab_modal_ae_pqc() {
    module_load_include('inc', 'learninglab', 'inc/modals');
    $call_theme = _learninglab_ae_pqc_call_theme();
    return $call_theme;
}

/**
 * Function for customize modal loader.
 * @author Rafael Rhormens <rrhorme@its.client.com>
 * @see  inc/modal.inc Call function theme.
 * @return String return modal-loader.tpl.php.
 */
function _learninglab_modal_loader() {
    module_load_include('inc', 'learninglab', 'inc/modals');
    $call_theme = _learninglab_loader_call_theme();
    return $call_theme;
}

/**
 * Function for customize modal reference.
 * @author Rafael Rhormens <rrhorme@its.client.com>
 * @see  inc/modal.inc Call function theme.
 * @return String return modal-reference.tpl.php.
 */
function _learninglab_modal_reference() {
    module_load_include('inc', 'learninglab', 'inc/modals');
    $call_theme = _learninglab_reference_call_theme();
    return $call_theme;
}

/**
 * Function for customize modal return to home.
 * @author Rafael Rhormens <rrhorme@its.client.com>
 * @see  inc/modal.inc Call function theme.
 * @return String return modal-retur-to-home.tpl.php.
 */
function _learninglab_modal_return_to_home() {
    module_load_include('inc', 'learninglab', 'inc/modals');
    $call_theme = _learninglab_return_to_home_call_theme();
    return $call_theme;
}

/**
 * Function for customize modal product.
 * @author Rafael Rhormens <rrhorme@its.client.com>
 * @see  inc/modal.inc Call function theme.
 * @return String return modal-product.tpl.php.
 */
function _learninglab_modal_product() {
    module_load_include('inc', 'learninglab', 'inc/modals');
    $call_theme = _learninglab_product_call_theme();
    return $call_theme;
}

/* New method for HCP Form submission in local */

function contactus_list($form, &$form_state, $subject_id = NULL) {

    global $user;

    // $subject_id = 1070;
    $form_id = 'contactus-list-1';

    // list($form_id, $form_elements) = _contactus_get_form_by_subject($subject_id);
    // $form_elements = drupal_get_form('webform_client_form_2457');
    $default_values = array(
      'name' => isset($user->name) ? $user->name : '',
      'email' => isset($user->mail) ? $user->mail : '',
    );
//watchdog('test-hcp', 'test3');
//  _contactus_set_form_elements_default_properties($form_elements, $default_values);



    $attributes = array('id' => drupal_html_id($form_id));
    $form['#attributes'] = (isset($form['#attributes']) && is_array($form['#attributes'])) ? array_merge($form['#attributes'], $attributes) : $attributes;

    $form['#id'] = $form_id;

    $form['before_custom'] = array();

    if (variable_get('contactus_custom_topmiddle', 0) == 1) {
        $form['before']['top_middle'] = array(
          '#type' => 'item',
          '#markup' => variable_get('contactus_custom_content_topmiddle', ''),
          '#prefix' => '<div class="contactus-top-middle">',
          '#suffix' => '</div>',
        );
    }

    $form['before_custom']['subject'] = array(
      '#type' => 'select',
      '#title' => t('Subject'),
      '#options' => $options,
      // '#empty_option' => t('No subject'),
      // '#empty_value' => 'no_subject',
      '#default_value' => $subject_id,
    );

    if (variable_get('contactus_custom_bottommiddle', 0) == 1) {
        $form['before_custom']['bottom_middle_content'] = array(
          '#type' => 'item',
          '#markup' => variable_get('contactus_custom_content_bottommiddle', ''),
          '#prefix' => '<div class="contactus-bottom-middle">',
          '#suffix' => '</div>',
        );
    }

    $query = db_select('node', 'n')
        ->fields('n', array('nid'))
        ->condition('title', 'contactus_list')
        ->condition('type', 'webform');
    $result = $query->execute();
    $data = $result->fetchObject();

    #$nid = 2457;
    $nid = $data->nid;
    $wnode = node_load($nid);
    $hcp_webform = drupal_get_form('webform_client_form_' . $nid, $wnode, array());
    foreach ($hcp_webform['submitted'] as $k => $v) {
        if (substr($k, 0, 1) == "#") {
            unset($hcp_webform['submitted'][$k]);
        }
    }
    $custom_form_elem = array();
    foreach ($hcp_webform['submitted'] as $key => $value) {
        $custom_form_elem[$key]['#type'] = ((!empty($value['#type'])) ? $value['#type'] : 'textfield');
        $custom_form_elem[$key]['#title'] = ((!empty($value['#title'])) ? $value['#title'] : '');
        $custom_form_elem[$key]['#required'] = ((!empty($value['#required'])) ? $value['#required'] : TRUE);
        $custom_form_elem[$key]['#default_value'] = ((!empty($value['#default_value'])) ? $value['#default_value'] : '');
        $custom_form_elem[$key]['#weight'] = ((!empty($value['#weight'])) ? $value['#weight'] : 0);
        if ($custom_form_elem[$key]['#type'] == 'checkboxes') {
            $custom_form_elem[$key]['#options'] = ((!empty($value['#options'])) ? $value['#options'] : '');
        }
        if ($custom_form_elem[$key]['#type'] == 'markup')
            $custom_form_elem[$key]['#markup'] = $value['#markup'];
    }
    $form['custom_form'] = $custom_form_elem;
    $form['after_custom'] = array();
    $form['after_custom']['contact_ok'] = array(
      '#type' => 'submit',
      '#value' => t('Submit'),
    );

    if (variable_get('contactus_custom_bottom', 0) == 1) {
        $form['after_custom']['bottom_content'] = array(
          '#type' => 'item',
          '#markup' => variable_get('contactus_custom_content_bottom', ''),
          '#prefix' => '<div class="contactus-bottom">',
          '#suffix' => '</div>',
        );
    }
    return $form;
}

/**
 * Field transformation
 * @param type $node
 * @return type
 */
function product_page_field_transform($node) {

    /*     * ******Product Home Page SP ID Transformation******** */

    if (isset($node->field_product_home_page[LANGUAGE_NONE][0]['nid']) && !empty($node->field_product_home_page[LANGUAGE_NONE][0]['nid'])) {

        //$node->field_prod_home_sp_id[LANGUAGE_NONE][0]['value'] = trim($node->field_product_home_page[LANGUAGE_NONE][0]['nid']);
        $ref_node = node_load($node->field_product_home_page[LANGUAGE_NONE][0]['nid']);
        $node->field_prod_home_sp_id[LANGUAGE_NONE][0]['value'] = $ref_node->field_sharepoint_id[LANGUAGE_NONE][0]['value'];
    }
    else {

        $node->field_prod_home_sp_id[LANGUAGE_NONE][0]['value'] = "";
    }


    /*     * ******Product Home Page SP ID Transformation End******** */

    /*     * ******Therapeutic Area Transformation******** */

    if (isset($node->field_therapeutic_area['und'][0]['value']) && !empty(trim($node->field_therapeutic_area['und'][0]['value']))) {
        $ta_sql = db_query("SELECT * FROM product_therapeutic_area WHERE product = '" . $node->title . "'");
        $ta_sql_arr = array();
        while ($ta_sql_res = $ta_sql->fetchObject()) {

            $ta_sql_arr[] = $ta_sql_res->therapeutic_area;
        }
        $field_ta_arr = explode(",", trim($node->field_therapeutic_area['und'][0]['value']));
        db_query("DELETE FROM product_therapeutic_area WHERE product = '" . $node->title . "'");
        if (count($ta_sql_arr) > 0) {
            foreach ($ta_sql_arr as $key => $value) {

                $ta_count = db_query("SELECT COUNT(*) cn FROM product_therapeutic_area WHERE therapeutic_area = '" . $value . "'")->fetchObject()->cn;
                if ($ta_count == 0) {

                    db_insert('product_therapeutic_area')
                        ->fields(array(
                          'therapeutic_area' => $value,
                          'product' => '',
                        ))->execute();
                }
            }
        }
        foreach ($field_ta_arr as $ta_value) {

            db_query("DELETE FROM product_therapeutic_area WHERE therapeutic_area = '" . trim($ta_value) . "' AND product=''");
            db_insert('product_therapeutic_area')
                ->fields(array(
                  'therapeutic_area' => trim($ta_value),
                  'product' => $node->title,
                ))->execute();
        }
    }
    else { #When Therapeutic Area is empty (coming from JCR)#
        $ta_sql = db_query("SELECT * FROM product_therapeutic_area WHERE product = '" . $node->title . "'");
        $ta_sql_arr = array();
        while ($ta_sql_res = $ta_sql->fetchObject()) {

            $ta_sql_arr[] = $ta_sql_res->therapeutic_area;
        }
        db_query("DELETE FROM product_therapeutic_area WHERE product = '" . $node->title . "'");
        if (count($ta_sql_arr) > 0) {
            foreach ($ta_sql_arr as $key => $value) {

                $ta_count = db_query("SELECT COUNT(*) cn FROM product_therapeutic_area WHERE therapeutic_area = '" . $value . "'")->fetchObject()->cn;
                if ($ta_count == 0) {

                    db_insert('product_therapeutic_area')
                        ->fields(array(
                          'therapeutic_area' => $value,
                          'product' => '',
                        ))->execute();
                }
            }
        }
    }


    /*     * ******Therapeutic Area Transformation End******** */

    /*     * *****Product Base Url transformation***** */
    if (isset($node->title)) {

        $node->field_product_base_url[LANGUAGE_NONE][0]['value'] = $node->title;
        //field_attach_update('node', $node);
    }

    /*     * *****Product Base Url transformation End***** */
    return $node;
}

/**
 * Page PI transformation
 * @param type $node
 * @return type
 */
function product_page_pi_transform($node) {
    watchdog("PI TEST", "8064");
    if (isset($node->field_pi_pdf['und'][0]['nid']) && !empty($node->field_pi_pdf['und'][0]['nid'])) {
        $node_arr = node_load($node->field_pi_pdf['und'][0]['nid']);


        //update prescribing_link field
        watchdog("File Resource", "In PI PDF");
        $node->field_prescribing_link[LANGUAGE_NONE][0]['value'] = substr(trim(strip_tags($node_arr->body[LANGUAGE_NONE][0]['summary'])), 1);
        //field_attach_update('node', $node);
    }
    /*     * *For PI Guide END.*** */

    return $node;
}

/**
 * Page med guide transformation
 * @param type $node
 * @return type
 */
function product_page_medguide_transform($node) {

    if (isset($node->field_medication_guide_pdf['und'][0]['nid']) && !empty($node->field_medication_guide_pdf['und'][0]['nid'])) {
        $node_arr = node_load($node->field_medication_guide_pdf['und'][0]['nid']);


        //update medication_guide field

        $node->field_medication_guide[LANGUAGE_NONE][0]['value'] = substr(trim(strip_tags($node_arr->body[LANGUAGE_NONE][0]['summary'])), 1);
        //field_attach_update('node', $node);
    }

    return $node;
}

/**
 * PI and Med guide transformation
 * @param type $node
 * @return type
 */
function product_page_pi_medguide_transform($node) {

    /*     * *For Medication Guide*** */

    if (isset($node->field_medication_guide_pdf['und'][0]['nid']) && !empty($node->field_medication_guide_pdf['und'][0]['nid'])) {
        $node_arr = node_load($node->field_medication_guide_pdf['und'][0]['nid']);


        //update medication_guide field

        $node->field_medication_guide[LANGUAGE_NONE][0]['value'] = $node_arr->body[LANGUAGE_NONE][0]['value'];
        //field_attach_update('node', $node);
    }
    /*     * *For Medication Guide END*** */

    /*     * *For PI Guide*** */

    if (isset($node->field_pi_pdf['und'][0]['nid']) && !empty($node->field_pi_pdf['und'][0]['nid'])) {
        $node_arr = node_load($node->field_pi_pdf['und'][0]['nid']);

        //update prescribing_link field

        $node->field_prescribing_link[LANGUAGE_NONE][0]['value'] = $node_arr->body[LANGUAGE_NONE][0]['value'];
        //field_attach_update('node', $node);
    }

    /*     * *For PI Guide END.*** */

    return $node;
}

/**
 * Ta delete form
 * @param type $form
 * @param type $form_state
 * @param type $ta_code
 * @return type
 */
function ta_delete_confirm($form, &$form_state, $ta_code) {
    $ta_code = urldecode($ta_code);
    //echo $_GET['destination'];
//	die();
    $form['_ta'] = array(
      '#type' => 'value',
      '#value' => $ta_code,);

    drupal_set_message($ta_code);

    return confirm_form($form, t('Are you sure you want to delete ' . $ta_code . ' Product?'), isset($_GET['destination']) ? $_GET['destination'] : "products_form", t('This action cannot be undone.'), t('Delete'), t('Cancel'));
}

/**
 * Submit implementation of ta delete
 * @param type $form
 * @param type $form_state
 */
function ta_delete_confirm_submit($form, &$form_state) {
    $destination = trim($_GET['destination']);
    $form_values = $form_state['values'];

    if ($form_state['values']['confirm']) {
        $ta = $form_state['values']['_ta'];
        drupal_set_message(t('TA ' . $ta . ' will get deleted.'));

        $result = db_query("DELETE FROM {product_therapeutic_area} where therapeutic_area='{$ta}'");
        drupal_set_message(t('TA has been deleted successfully.'));
    }
    drupal_goto($destination);
}

/**
 * Post import actions
 */
function learninglab_post_import() {

    unset($_SESSION['pi']);
    unset($_SESSION['med']);
    watchdog("Session Destroy", "Session detroyed for PI and Medguide.");
}

/**
 * Sharepoint content transformation
 * @param type $node
 * @return type
 */
function sharepoint_content_transform($node) {
    //Placing product unique identifier in SP content pages
    $nodeObj = node_load($node->field_vv_product[LANGUAGE_NONE][0]['nid']);
    $node->field_product[LANGUAGE_NONE][0]['value'] = $nodeObj->title;

    //update Sharepoint ID using uuid value
    $node->field_sharepoint_id[LANGUAGE_NONE][0]['value'] = $node->uuid;

    //update Header using metatags values
    $updated_header = '<meta name="DC.Title" content="' . $node->title . '" />
<meta name="abstract" content="' . $node->metatags['en']['abstract']['value'] . '" />
<meta name="description" content="' . $node->metatags['en']['description']['value'] . '" />
<meta name="DC.subject" content="' . $node->field_vv_header_subject_terms[LANGUAGE_NONE][0]['value'] . '" />
<meta name="keywords" content="' . $node->metatags['en']['keywords']['value'] . '" />
<meta name="DC.Identifier" content="' . $node->uuid . '" />
<title>' . $node->title . '</title>';

    $node->field_header[LANGUAGE_NONE][0]['value'] = $updated_header;

    // update Dita content type using Page Type value
    $node->field_dita_content_type[LANGUAGE_NONE][0]['tid'] = $node->field_page_type[LANGUAGE_NONE][0]['value'];

    // update Searchable using VV Search Exclude value
    $searchable = $node->field_vv_search_exclude[LANGUAGE_NONE][0]['value'];
    #$solr_search_exclude = 0;
    if (isset($searchable) && $searchable == 1) {
        $node->field_searchable[LANGUAGE_NONE][0]['tid'] = 3; /* 3=No */
        $node->apachesolr_exclude_node_enabled = 1;
        #$solr_search_exclude = 1;
    }
    else {
        $node->field_searchable[LANGUAGE_NONE][0]['tid'] = 4; /* 4=Yes */
        $node->apachesolr_exclude_node_enabled = 0;
        #$solr_search_exclude = 0;
    }

    // update Browseable using Display Restriction values
    $browseable = $node->field_display_restriction[LANGUAGE_NONE][0]['value'];

    if (isset($browseable) && $browseable == 1) {
        $node->field_browseable[LANGUAGE_NONE][0]['tid'] = 1; # 1=No 
    }
    else {
        $node->field_browseable[LANGUAGE_NONE][0]['tid'] = 2; # 2=Yes 
    }

    // update title_slug using Canonical Url value
    $node->field_title_slug[LANGUAGE_NONE][0]['value'] = $node->field_canonical_url[LANGUAGE_NONE][0]['value'] . "|";

    // update Slide Deck using VV Slide Deck value
    $node->field_slide_deck[LANGUAGE_NONE][0]['value'] = $node->field_vv_slide_deck[LANGUAGE_NONE][0]['value'];

    // update Publish Status using Pulish State value
    $publish = strtolower($node->field_publish_state[LANGUAGE_NONE][0]['value']);

    /*     * ***************************************************************
      if(isset($publish) && ($publish == 'obsolete' || $publish == 'unpub')) {
      $node->apachesolr_exclude_node_enabled = 1;
      //apachesolr_remove_entity('acquia_search_server_1','node', $node->nid);
      watchdog("SOLR Delete",$node->nid." Status 1 ".$publish);
      }else{
      if(isset($searchable) && $searchable == 1) {
      $node->apachesolr_exclude_node_enabled = 1;
      watchdog("SOLR Delete",$node->nid." Status 2 ".$publish." : ".$searchable);
      }else{
      $node->apachesolr_exclude_node_enabled = 0;
      watchdog("SOLR Delete",$node->nid." Status 3".$publish." : ".$searchable);
      }
      } */
    #$node->apachesolr_exclude_node_enabled = 1;
    #watchdog("SOLR Delete",$node->nid." Status 4".$publish." : ".$searchable);
    /*     * *************************************************************** */
    if (!isset($publish) || empty($publish) || (isset($publish) && $publish == 'pub')) {
        db_query("UPDATE {node} SET `status` = '1' WHERE `nid` =:nid ;", array(':nid' => $node->nid));
        db_query("UPDATE {node_revision} SET `status` = '1' WHERE `nid` =:nid AND  `vid` =:vid;", array(':nid' => $node->nid, 'vid' => $node->vid));
    }
    else if (isset($publish) && ($publish == 'obsolete' || $publish == 'unpub')) {
        db_query("UPDATE {node} SET `status` = '0' WHERE `nid` =:nid ;", array(':nid' => $node->nid));
        db_query("UPDATE {node_revision} SET `status` = '0' WHERE `nid` =:nid AND  `vid` =:vid;", array(':nid' => $node->nid, 'vid' => $node->vid));
        #$solr_search_exclude = 1;
        #apachesolr_remove_entity('acquia_search_server_1','node', $node->nid);
        #apachesolr_index_mark_for_reindex('acquia_search_server_1');
        #apachesolr_entity_delete($node, 'node');
    }

    // Source Document file path

    if (isset($node->field_vv_source_document['und'][0]['fid']) && !empty($node->field_vv_source_document['und'][0]['fid'])) {

        $file = file_load($node->field_vv_source_document['und'][0]['fid']);
        $source_doc_filename = $file->filename;
        watchdog("JMD FILE", "BINARY FILE NAME FROM JCR :" . $source_doc_filename);

        if (file_exists(file_stream_wrapper_get_instance_by_uri('public://')->getDirectoryPath() . "/" . $source_doc_filename)) {
            watchdog("JMD FILE", "FILE PATH DEFAULT : " . file_stream_wrapper_get_instance_by_uri('public://')->getDirectoryPath());
            $resource_path = file_stream_wrapper_get_instance_by_uri('public://')->getDirectoryPath() . "/restrict/Files/";
            watchdog("JMD FILE", "Resource Path: " . $resource_path);

            if (!file_exists($resource_path)) {
                $made = mkdir($resource_path, 0777, TRUE);
                if (!$made) {
                    watchdog('JCR Publish', sprintf('Unable to create dir: %s', $resource_path));
                }
            }
            /* $source_doc_fid = $node->field_vv_source_document['und'][0]['fid'];
              $source_doc_filepath = $file->uri;
              $old_source_doc_filepath = file_stream_wrapper_get_instance_by_uri('public://')->getDirectoryPath()."/".str_replace("public://", "", $source_doc_filepath);
              $new_source_doc_filepath = file_stream_wrapper_get_instance_by_uri('public://')->getDirectoryPath()."/restrict/Files/".str_replace("public://", "", $source_doc_filepath);
              watchdog("JMD FILE", "BINARY New file path: ".$new_source_doc_filepath);
              watchdog("JMD FILE", "BINARY Old file path: ".$old_source_doc_filepath);
              if(file_unmanaged_move($old_source_doc_filepath, $new_source_doc_filepath, $replace = FILE_EXISTS_REPLACE)){
              db_query("UPDATE {file_managed} SET uri = 'public://restrict/Files/".$source_doc_filename."' WHERE fid= '".$source_doc_fid."'");

              watchdog("JMD FILE","Update file_managed with :"."/restrict/Files/".$source_doc_filename);
              } */
            $source_doc_fid = $node->field_vv_source_document['und'][0]['fid'];
            $source_doc_file = file_load($source_doc_fid);
            $source_doc_filepath = $file->uri;
            $new_source_doc_filepath = 'public://restrict/Files/' . str_replace("public://", "", $source_doc_filepath);
            file_move($source_doc_file, $new_source_doc_filepath, $replace = FILE_EXISTS_REPLACE);
        }
        //$node->field_binary_file_path[LANGUAGE_NONE][0]['value'] = $resource_path.$source_doc_filename;			
    }

    // binary file path		

    if (isset($node->field_vv_binary_file_path['und'][0]['fid']) && !empty($node->field_vv_binary_file_path['und'][0]['fid'])) {

        $file = file_load($node->field_vv_binary_file_path['und'][0]['fid']);
        $binary_filename = $file->filename;
        watchdog("JMD FILE", "BINARY FILE NAME FROM JCR :" . $binary_filename);

        if (file_exists(file_stream_wrapper_get_instance_by_uri('public://')->getDirectoryPath() . "/" . $binary_filename)) {
            watchdog("JMD FILE", "FILE PATH DEFAULT : " . file_stream_wrapper_get_instance_by_uri('public://')->getDirectoryPath());
            $resource_path = file_stream_wrapper_get_instance_by_uri('public://')->getDirectoryPath() . "/restrict/Files/";
            watchdog("JMD FILE", "Resource Path: " . $resource_path);

            if (!file_exists($resource_path)) {
                $made = mkdir($resource_path, 0777, TRUE);
                if (!$made) {
                    watchdog('JCR Publish', sprintf('Unable to create dir: %s', $resource_path));
                }
            }

            /* $binary_fid = $node->field_vv_binary_file_path['und'][0]['fid'];
              $binary_filepath = $file->uri;
              $old_binary_filepath = file_stream_wrapper_get_instance_by_uri('public://')->getDirectoryPath()."/".str_replace("public://", "", $binary_filepath);
              $new_binary_filepath = file_stream_wrapper_get_instance_by_uri('public://')->getDirectoryPath()."/restrict/Files/".str_replace("public://", "", $binary_filepath);
              watchdog("JMD FILE", "BINARY New file path: ".$new_binary_filepath);
              watchdog("JMD FILE", "BINARY Old file path: ".$old_binary_filepath);
              if(file_unmanaged_move($old_binary_filepath, $new_binary_filepath, $replace = FILE_EXISTS_REPLACE)){
              db_query("UPDATE {file_managed} SET uri = 'public://restrict/Files/".$binary_filename."' WHERE fid= '".$binary_fid."'");
              watchdog("JMD FILE","Update file_managed with :"."/restrict/Files/".$binary_filename);
              } */
            $binary_fid = $node->field_vv_binary_file_path['und'][0]['fid'];
            $binary_file = file_load($binary_fid);
            $binary_filepath = $file->uri;
            $new_binary_filepath = 'public://restrict/Files/' . str_replace("public://", "", $binary_filepath);
            file_move($binary_file, $new_binary_filepath, $replace = FILE_EXISTS_REPLACE);
        }
        $binary_file_path = file_stream_wrapper_get_instance_by_uri('public://')->getDirectoryPath() . "/restrict/Files/" . $binary_filename;
        watchdog("JMD FILE", "binary_file_path: " . $binary_file_path);
        $node->field_binary_file_path[LANGUAGE_NONE][0]['value'] = $binary_file_path;
    }
    watchdog("Article ModTime", "Date: " . str_replace(array(':', 'T'), array('-', '_'), substr($node->metatags['en']['article:modified_time']['value'], 0, -6)));
    //update published_time using MetaTag article:modified_time value
    $node->field_published_time[LANGUAGE_NONE][0]['value'] = str_replace(array(':', 'T'), array('-', '_'), substr($node->metatags['en']['article:modified_time']['value'], 0, -6));
    watchdog("Article ModTime", "Date: " . $node->field_published_time[LANGUAGE_NONE][0]['value']);
    /* SOLR search exclude */
    /* if(isset($solr_search_exclude) && $solr_search_exclude == 1){

      apachesolr_exclude_node_node_revision_delete($node);
      db_insert('apachesolr_exclude_node')
      ->fields(array(
      'nid' => $node->nid,
      'vid' => $node->vid,
      'exclude' => 1,
      ))
      ->execute();
      }else{
      db_delete('apachesolr_exclude_node')
      ->condition('nid', $node->nid)
      ->execute();
      } */


    // update fields values
    field_attach_update('node', $node);

    return $node;
}

function _nfr_url_dita_address($url, $sharepoint_id) {
    $already_has_url = db_query("SELECT url FROM {drupal_obsolete_url_map} WHERE url = '" . $url . "' AND sharepoint_id = '" . $sharepoint_id . "' ")->fetchField();

    watchdog('sharepoint_pages', 'already_has_url : ' . $already_has_url);

    if ($already_has_url && $already_has_url == $url) {
        watchdog('sharepoint_pages', 'In IF BLOCK already_has_url : ' . $already_has_url);
        return $already_has_url;
    }
    //print "SELECT new_url FROM {drupal_obsolete_url_map} WHERE url = '".$url."' "; //die();
    $lenght = strlen($url);
    //print "lenght".$lenght;
    //$is_first_use = db_query("SELECT new_url FROM {drupal_url_map_new} WHERE original_url = '".$url."' ")->fetchField();
    $is_first_use = db_query("SELECT url FROM {drupal_obsolete_url_map} WHERE url = '" . $url . "' ")->fetchField();
    if (!empty($is_first_use) && $is_first_use != $url) {
        $is_first_use = '';
    }
    watchdog('sharepoint_pages', 'is_first_use : ' . $is_first_use);
    //print "is_first_use".$is_first_use;//die();
    if ((!$is_first_use) && ($lenght <= 255)) {
        //print "is_first_use BLOCk";
        $new_url = _nfr_decide_url($url);
        watchdog('sharepoint_pages', 'new_url FROM is_first_use IF Block : ' . $new_url);
        //print $new_url;die();
    }
    else {
        if ($lenght <= 252) {
            $url_to_consult = $url;
            //print "SELECT COUNT(*) AS total FROM {drupal_url_map_new} WHERE original_url = '".$url_to_consult."' AND new_url REGEXP '[0-9]{2}$' ";print "<br/>";
            $count = db_query("SELECT COUNT(*) AS total FROM {drupal_obsolete_url_map} WHERE url LIKE '%" . $url_to_consult . "%%' ")->fetchField();
            //die('1');
        }
        else {
            //echo 'in last else';
            //$sql = 'SELECT COUNT(*) AS total FROM {drupal_url_map_new} WHERE new_url LIKE "%s%%" AND new_url REGEXP "%s"';
            $url_to_consult = substr($url, 0, 253);
            $count = db_query("SELECT COUNT(*) AS total FROM {drupal_obsolete_url_map} WHERE url LIKE '%" . $url_to_consult . "%%' ")->fetchField();
        }
        watchdog('sharepoint_pages', 'count Block : ' . $count);
        /* $result = db_query($sql, $url_to_consult, '[0-9]{2}$');
          $count = (db_fetch_object($result)->total + 1);
          $count = db_query($sql, $url_to_consult, '[0-9]{2}$')->fetchField(); */
        $new_url = _nfr_decide_url($url, $count);
        watchdog('sharepoint_pages', 'new_url FROM ELSE : ' . $new_url);
    }

    return $new_url;
}

function _nfr_decide_url($url, $count = FALSE) {
    $lenght = strlen($url);

    if ($count == FALSE) {
        $new_url = substr($url, 0, 255);
    }
    else {
        $count = str_pad($count, 2, '0', STR_PAD_LEFT);

        if ($lenght <= 253) {
            $new_url = $url . $count;
        }
        else {
            $new_url = substr($url, 0, 253) . $count;
        }
    }

    //print "<br/>new_url==>". $new_url;
    return $new_url;
}

/**
 * Purge files for Product Pages both from database and file system.
 */
function learninglab_jcr_jmdproduct_files_purge() {
    $print_if_cli = function($message) {
        if (drupal_is_cli()) {
            printf($message . "\n");
        }
    };

    $print_if_cli('Starting files purge...');

    $files_to_remove = array(
      'db' => array(), // Files that should be removed from {file_managed} database table.
      'fs' => array(), // Files that should be removed from file system.
    );

    $public_files_wrapper = new DrupalPublicStreamWrapper();
    $public_files_path = DRUPAL_ROOT . '/' . $public_files_wrapper->getDirectoryPath();

    // Collect files from database that are in {file_managed} table, but not exists in filesystem.
    $file_managed_files = db_select('file_managed', 'fm')
        ->fields('fm')
        ->execute()
        ->fetchAllAssoc('fid');
    foreach ($file_managed_files as $file) {
        $file_exists_in_fs = (drupal_realpath($file->uri) !== FALSE);
        if (!$file_exists_in_fs) {
            $files_to_remove['db'][$file->fid] = $file;
        }
    }
    // Remove all not existing files from database.
    file_delete_multiple(array_keys($files_to_remove['db']));
    //$print_if_cli("AFTER file_delete_multiple: $file->uri");
    foreach ($files_to_remove['db'] as $file) {
        //$print_if_cli("END File removed from database: $file->uri");
        watchdog('JCR File purge', 'File removed from database: !file', array('!file' => $file->uri));
    }

    // Collect all files from public file system.
    $all_files = file_scan_directory($public_files_path, '*.*');
    // Filter by product-info folders.
    $product_files = array_filter($all_files, function($file) {
        return strpos($file->uri, 'product-info') !== false;
    });
    foreach ($product_files as $file) {
        // Get all files from database by filename.
        $db_records = db_select('file_managed', 'fm')
            ->fields('fm')
            ->condition('fm.uri', "%product-info/$file->filename", 'LIKE')
            ->execute()
            ->fetchAllAssoc('fid');

        // If file not found in database.
        if (!count($db_records)) {
            $files_to_remove['fs'][] = $file;
        }
        else {
            foreach ($db_records as $file) {
                $file_exists_in_fs = drupal_realpath($file->uri) !== FALSE;
                if (!$file_exists_in_fs) {
                    $files_to_remove['db'][$file->fid] = $file;
                }
            }
        }
    }
    // Remove files from file system.
    foreach ($files_to_remove['fs'] as $file) {
        file_unmanaged_delete($file->uri);
        watchdog('JCR File purge', 'File removed from filesystem: !file_path', array('!file_path' => $file->uri));
        //$print_if_cli("File removed from filesystem: $file->uri");
    }

    $print_if_cli('Files purging finished.');
}

/* * *****************************************************************
 * Implements hook_jcr_client_pre_import().
 * **************************************************************** */

function learninglab_jcr_client_pre_import() {
    learninglab_jcr_jmdproduct_files_purge();
}

/* * **************************************************************** 
 * Returns vv_last_updated_date & vv_doc_no(package_info) 
 * **************************************************************** */

function get_vv_info($canonical_url = "", $revision_no = "") {
    $vv_info = array(
      'sp_id' => 'NA',
      'version' => 'NA',
      'source' => 'Web CMS',
    );

    if (!empty($canonical_url)) {
        $canonical_url_arr = explode("?", $canonical_url);
        $canonical_url = $canonical_url_arr[0];
        if (!empty($revision_no)) { //specific revision based on date
            $qry = "select t2.field_package_info_value, t3.field_published_time_value, t4.field_sharepoint_id_value, t5.field_jcr_managed_value, t6.field_vv_last_updated_date_value from ( select entity_id, revision_id from field_revision_field_canonical_url where field_canonical_url_value = '" . $canonical_url . "' and revision_id='" . $revision_no . "') as t1 
left join ( SELECT field_package_info_value, entity_id, revision_id from field_revision_field_package_info) as t2 on t1.entity_id = t2.entity_id AND t1.revision_id = t2.revision_id
left join ( SELECT field_published_time_value, entity_id, revision_id from field_revision_field_published_time) as t3 on t1.entity_id = t3.entity_id AND t1.revision_id = t3.revision_id
left join ( SELECT field_sharepoint_id_value, entity_id, revision_id from field_revision_field_sharepoint_id ) as t4 on t1.entity_id = t4.entity_id AND t1.revision_id = t4.revision_id
left join ( SELECT field_jcr_managed_value, entity_id, revision_id from field_revision_field_jcr_managed) as t5 on t1.entity_id = t5.entity_id AND t1.revision_id = t5.revision_id
left join ( SELECT field_vv_last_updated_date_value, entity_id, revision_id from field_revision_field_vv_last_updated_date) as t6 on t1.entity_id = t6.entity_id AND t1.revision_id = t6.revision_id";
        }
        else { //Latest revision information
            $qry = "select t2.field_package_info_value, t3.field_published_time_value, t4.field_sharepoint_id_value, t5.field_jcr_managed_value, t6.field_vv_last_updated_date_value from ( SELECT entity_id, revision_id from field_data_field_canonical_url where field_canonical_url_value = '" . $canonical_url . "' order by revision_id DESC limit 0,1) as t1 
left join ( SELECT field_package_info_value, entity_id, revision_id from field_data_field_package_info) as t2 on t1.entity_id = t2.entity_id AND t1.revision_id = t2.revision_id
left join ( SELECT field_published_time_value, entity_id, revision_id from field_data_field_published_time) as t3 on t1.entity_id = t3.entity_id AND t1.revision_id = t3.revision_id
left join ( SELECT field_sharepoint_id_value, entity_id, revision_id from field_data_field_sharepoint_id ) as t4 on t1.entity_id = t4.entity_id AND t1.revision_id = t4.revision_id
left join ( SELECT field_jcr_managed_value, entity_id, revision_id from field_data_field_jcr_managed) as t5 on t1.entity_id = t5.entity_id AND t1.revision_id = t5.revision_id
left join ( SELECT field_vv_last_updated_date_value, entity_id, revision_id from field_data_field_vv_last_updated_date) as t6 on t1.entity_id = t6.entity_id AND t1.revision_id = t6.revision_id";
        }
        watchdog("SQL", "Qry: " . $qry);
        $res = db_query($qry);
        if ($row = $res->fetchObject()) {
            $package_info = trim($row->field_package_info_value);
            $published_time = trim($row->field_published_time_value);
            $sharepoint_id = trim($row->field_sharepoint_id_value);
            $jcr_managed = trim($row->field_jcr_managed_value);
            $vv_lud = trim($row->field_vv_last_updated_date_value);

            if ($jcr_managed) { /* Digital Content */
                if ($package_info == NULL || empty($package_info)) { /* Webonly Materials */
                    $sp_id = $sharepoint_id;
                    $version = $published_time;
                }
                else { /* JCR Prep made JCR Content */
                    $sp_id = $package_info;
                    $version = date("Y-m-d_H-i-s", strtotime($vv_lud));
                }
                $source = "JCR";
            }
            else { /* Non Digital Content */
                $package_info_arr = json_decode($package_info, TRUE);
                $sp_id = $package_info_arr['vault id'];
                $version = date("Y-m-d_H-i-s", strtotime($package_info_arr['version creation date']));
                $source = "JCR Prep";
            }

            $vv_info['sp_id'] = (empty($sp_id) ? "NA" : $sp_id);
            $vv_info['version'] = (empty($version) ? "NA" : $version);
            $vv_info['source'] = (empty($source) ? "NA" : $source);
        }
        else { /* No_CANONICAL_URL : PI/MG check */
            if (substr($canonical_url, 0, 4) == "pdf/" && substr($canonical_url, -4) == ".pdf") {
                $vv_info['source'] = "JCR";
            }
        }
    }
    return $vv_info;
}

/* * *****************************************************************
 * Implements hook_jcr_client_post_import().
 * **************************************************************** */

function learninglab_jcr_client_post_import() {
    // Retrieve registered updated file resources.
    $updated_files = JCRJMDProductCustom::updatedFileResources();
    // Create source migration.
    $section_migration = JCRMigration::getNewInstance('FileResource');
    $file_source_item = $section_migration->createSourceItem();

    foreach ($updated_files as $file_resource_nid => $product_page_nid) {
        $product_page = NULL;
        if ($product_page_nid) {
            $product_page = node_load($product_page_nid);
        }
        // If file resource has been updated, but product has not.
        if (!$product_page) {
            // Try to load product by file resource node id.
            $product_page = JCRJMDProductCustom::loadProductByFileResource($file_resource_nid);
            // If not - skip.
            if (!$product_page) {
                continue;
            }
        }

        $file_resource = node_load($file_resource_nid);
        if ($product_page && $file_resource) {
            $file = file_load($file_resource->field_resource_file['und'][0]['fid']);
            if (!$file) {
                continue;
            }

            // Create destination directory.
            $resource_path = "public://{$product_page->title}/product-info";
            if (!file_exists($resource_path)) {
                if (!mkdir($resource_path, 0777, TRUE)) {
                    watchdog('JCR Publish', sprintf('Unable to create dir: %s', $resource_path));
                    continue;
                }
            }

            // Fetch raw file resource information to get destination filename.
            $file_resource_raw = $file_source_item->getItem($file_resource->uuid);
            if (!empty($file_resource_raw)) {
                $file->filename = $file_resource_raw->filename;
                $new_pi_uri = "{$resource_path}/{$file->filename}";
                // If file exists and has different name/location - move.
                if (file_exists($file->uri) && $file->uri != $new_pi_uri) {
                    file_move($file, $new_pi_uri, FILE_EXISTS_REPLACE);
                }
            }
        }
    }
}

/**
 * Solr search implementation
 * @param type $product
 * @param type $keyword
 * @param type $limit
 * @return type
 */
function jmdsolr_search_page($product = '', $keyword = '', $limit = '') {
    $product = trim($product);
    $keyword = trim(strtolower(_learninglab_drupal_urldecode($keyword)));
    $old_keyword = $keyword;
    $synonym = get_search_synonym_by_keyword($keyword);
    if (!empty($synonym))
        $keyword = trim($synonym);
    else
        $keyword = str_ireplace("-", " ", $keyword);

    $result = array();
    $pi_med_result = array();
    $sp_result = array();
    $keyword = '"' . $old_keyword . '" OR ' . $keyword;
    watchdog("Keyword", $keyword);
    $pi_med_result = get_pi_med_result($product, $keyword, $limit);
    if (sizeof($pi_med_result) > 0)
        $limit = $limit - sizeof($pi_med_result);
    $sp_result = get_sp_result($product, $keyword, $limit);

    $result = array_merge($pi_med_result, $sp_result);

    return $result;
}

/**
 * Get Solr Search results
 * @param type $product
 * @param type $keyword
 * @param type $limit
 * @return type
 */
function get_sp_result($product = '', $keyword = '', $limit = '') {
    watchdog('solr fix', "SP:: P: " . $product . " K : " . $keyword . " L :" . $limit);
    $offset = 0;
    // Get instance
    $solr = apachesolr_get_solr();

    // Create basic query
    $query = apachesolr_drupal_query("custom", array('q' => $keyword));
    $query->addParam('qf', 'content label path_alias ts_metatags');
    // Add offset and limits
    $query->addParam('start', $offset);
    $query->addParam('rows', $limit);
    $query->addParam('hl', TRUE);
    $query->addParam('hl.fragsize', 300);
    #$query->addParam('hl.multiValuedSeparatorChar', ' ');
    $query->addParam('fq', "bundle:(sharepoint_pages OR announcement)");

    $sub_q = new SolrFilterSubQuery();
    $sub_q->addFilter('sm_field_product', $product);
    $sub_q->addFilter('im_field_announc_product', get_nid_by_product($product));
    $query->addFilterSubQuery($sub_q);

    $resp = $query->search();
    $result = $resp->response;

    $solr_res_sp = array();
    $i = 0;
    foreach ($result->docs as $val) {
        $solr_res_sp[$i]['id'] = $val->id;
        $id = $solr_res_sp[$i]['id'];
        $solr_res_sp[$i]['product'] = $product;

        $solr_res_sp[$i]['title'] = $val->label;
        $solr_res_sp[$i]['content'] = $val->content;

        $highlight_content = $resp->highlighting->$id->content[0];
        if (empty($highlight_content)) {
            $highlight_content = search_excerpt($keyword, $solr_res_sp[$i]['content']);
        }
        else {
            $highlight_content = "... " . $highlight_content . " ...";
        }
        $highlight_content = str_ireplace(array('@last_reviewed@', '@share@', '@printer_friendly@', 'ï·', 'ï°', 'ï'), '', $highlight_content);

        $solr_res_sp[$i]['snippet'] = $highlight_content;

        if (strtolower($val->sm_field_component_type[0]) == 'pdf') {
            $solr_res_sp[$i]['format-type'] = 'pdf';
            $solr_res_sp[$i]['component-type'] = 'pdf';
        }
        else {
            //$solr_res_sp[$i]['format-type'] = 'text'; 
            //$solr_res_sp[$i]['component-type'] = 'text'; 
        }

        $solr_res_sp[$i]['num-references'] = isset($val->its_field_total_references) && !empty($val->its_field_total_references) ? $val->its_field_total_references : 0;
        $nid_arr = array();

        if (!empty($solr_res_sp[$i]['id'])) {
            $nid_arr = explode('/', $solr_res_sp[$i]['id']);
            $nid = $nid_arr[2];
        }

        if ($val->bundle == 'announcement') {
            //echo $solr_res_sp[$i]['link'] = url(drupal_get_path_alias('node/' . $node->nid)); exit;
            $solr_res_sp[$i]['link'] = drupal_get_path_alias('node/' . $nid);
            $solr_res_sp[$i]['format-type'] = 'Announcement';
            $solr_res_sp[$i]['component-type'] = 'Announcement';
        }
        else {
            $solr_res_sp[$i]['link'] = $val->sm_field_canonical_url[0];
        }


        if (!empty($nid) && $solr_res_sp[$i]['num-references'] > 0) {
            $solr_res_sp[$i]['nid'] = _learninglab_encrypt($nid);
        }

        if (!empty($nid)) {
            $nload = node_load($nid);
            if (!empty($nload->field_html_content[LANGUAGE_NONE][0]['value'])) {
                $html_content = $nload->field_html_content[LANGUAGE_NONE][0]['value'];
                if (preg_match('|<div class="brightcove-video-wrapper">|', $html_content) || preg_match('|<jmdvideo videoid=(.*)>|', strtolower($html_content))) {
                    $solr_res_sp[$i]['is-media'] = 1;
                }
            }
        }
        /* Last Updated Date */
        if ($val->bundle == 'announcement') {
            $changed_date_time = str_ireplace(array("T", "z"), " ", $val->ds_changed);
            $solr_res_sp[$i]['last-modified'] = date("n/j/Y", strtotime($changed_date_time));
        }
        else {
            $changed_timestamp = $val->sm_field_last_reviewed[0];
            $solr_res_sp[$i]['last-modified'] = date("n/j/Y", $changed_timestamp);
        }

        $i++;
    }
    return $solr_res_sp;
}

/**
 * Get PI and Med Results
 * @param type $product
 * @param type $keyword
 * @param int $limit
 * @return type
 */
function get_pi_med_result($product = '', $keyword = '', $limit = '') {
    watchdog('solr fix', "MG:: P: " . $product . " K : " . $keyword . " L :" . $limit);
    $offset = 0;
    $limit = 100;

    // Get instance
    $solr = apachesolr_get_solr();

    // Create basic query
    //$query = apachesolr_drupal_query("custom", array('q' => $keyword, 'qf' => array('content', 'label', 'path_alias')));
    $query = apachesolr_drupal_query("custom", array('q' => $keyword));
    $query->addParam('qf', 'content label path_alias ts_metatags');


    // Add offset and limits
    $query->addParam('start', $offset);
    $query->addParam('rows', $limit);
    $query->addParam('hl', TRUE);
    $query->addParam('hl.fragsize', 300);
    $query->addParam('fq', "bundle:(file_resource)");

    $resp = $query->search();
    $result = $resp->response;

    $solr_res_pi_med = array();
    $i = 0;
    foreach ($result->docs as $val) {
        preg_match('|https?[^\s]+\s|is', $val->teaser, $pdf_url);
        $arr_url = explode('/', $pdf_url[0]);
        $fname = $arr_url[8];
        if ($arr_url[6] == $product) {
            $id_arr = explode('/', $val->id);
            $entity_id = $id_arr[2];
            $link = get_url_alias_for_pi_med($entity_id);
            if (isset($link) && !empty($link)) {
                $solr_res_pi_med[$i]['id'] = $val->id;
                $id = $solr_res_pi_med[$i]['id'];
                $solr_res_pi_med[$i]['product'] = $product;
                $solr_res_pi_med[$i]['link'] = $link;
                $solr_res_pi_med[$i]['title'] = $val->label;
                $solr_res_pi_med[$i]['content'] = $val->content;

                $highlight_content = $resp->highlighting->$id->content[0];
                if (empty($highlight_content)) {
                    $highlight_content = search_excerpt($keyword, $solr_res_pi_med[$i]['content']);
                }
                else {
                    $highlight_content = "... " . $highlight_content . " ...";
                }

                $highlight_content = str_ireplace(array('ï·', 'ï°', 'ï'), '', $highlight_content);
                $solr_res_pi_med[$i]['snippet'] = $highlight_content;

                //$solr_res_pi_med[$i]['format-type'] = 'pdf'; 
                $solr_res_pi_med[$i]['component-type'] = 'pdf';
                $solr_res_pi_med[$i]['num-references'] = 0;

                $changed_timestamp = db_query("select changed from node where title='" . $product . "'")->fetchField();
                $solr_res_pi_med[$i]['last-modified'] = date("n/j/Y", $changed_timestamp);
            }
            $i++;
        }
    }
    return $solr_res_pi_med;
}

/**
 * Get URl alias for PI and Med guide
 * @param type $entity_id
 * @return type
 */
function get_url_alias_for_pi_med($entity_id = '') {
    $pi_med_link = '';
    $result = db_query("select x1.pi_med_link from (select t2.field_prescribing_link_value as pi_med_link from field_data_field_pi_pdf as t1
inner join field_data_field_prescribing_link as t2 on t1.entity_id = t2.entity_id and t1.field_pi_pdf_nid = " . $entity_id . ") as x1
		UNION
		select x2.pi_med_link from (select t2.field_medication_guide_value as pi_med_link from field_data_field_medication_guide_pdf as t1
inner join field_data_field_medication_guide as t2 on t1.entity_id = t2.entity_id and t1.field_medication_guide_pdf_nid =  " . $entity_id . ") as x2")->fetchObject();

    if (!empty($result->pi_med_link))
        $pi_med_link = $result->pi_med_link;

    return $pi_med_link;
}

/**
 * Get URL alias for non-digital content
 * @param type $nid
 * @param type $product
 * @return type
 */
function get_url_alias_for_non_digital($nid = '', $product = '') {
    $binary_file_path = '';

    $result = db_query("select t2.field_canonical_url_value from field_data_field_product as t1
inner join field_data_field_canonical_url as t2 on t1.entity_id = t2.entity_id
where t1.entity_id = " . $nid . " and field_product_value = '" . $product . "'")->fetchObject();

    if (!empty($result->field_canonical_url_value))
        $binary_file_path = $result->field_canonical_url_value;
    return $binary_file_path;
}

/**
 * Get node ID from product
 * @param type $product
 * @return type
 */
function get_nid_by_product($product = '') {
    $result = db_select('node', 'n')
        ->fields('n', array('nid'))
        ->condition('type', 'product_page')
        ->condition('title', $product)
        ->execute()
        ->fetchAssoc();
    return $result['nid'];
}

/**
 * Get search suggestions from SOLR
 * @param type $keyword
 * @return type
 */
function get_solr_search_suggestion($keyword) {
    $offset = 0;
    $limit = 10;
    $keyword = trim(strtolower(_learninglab_drupal_urldecode($keyword)));
    // Get instance
    $solr = apachesolr_get_solr();

    // Create basic query
    $query = apachesolr_drupal_query("custom", array('q' => $keyword));
    // $query = apachesolr_drupal_query("custom"); 
    // Add offset and limits
    //   $query->addParam('start', $offset);
    //   $query->addParam('rows', $limit);
    $query->addParam('hl', TRUE);
    //   $query->addParam('fq', "bundle:(sharepoint_pages OR announcement)");	

    $query->addParam('spellcheck', true);
    $query->addParam('spellcheck.build', true);

    list($final_query, $result) = apachesolr_do_query($query);
    $env_id = $query->solr('getId');
    #apachesolr_has_searched($env_id, TRUE);
    $search_suggestion = '';
    $suggestions_output = array();


    $query = apachesolr_current_query($env_id);

    $keyword = $query->getParam('q');
    $searcher = $query->getSearcher();
    $response = apachesolr_static_response_cache($searcher);

    if (!empty($response->spellcheck->suggestions)) {
        $suggestions = get_object_vars($response->spellcheck->suggestions);
        // allow the suggestions to be altered before processing
        drupal_alter('apachesolr_suggestions', $suggestions, $env_id);

        if ($suggestions) {
            $replacements = array();
            // Get the original query and retrieve all words with suggestions.
            foreach ($suggestions as $word => $value) {
                $suggestion = $value->suggestion;
                // We need to check if it's an object as setting the spellcheck.extendedResults query parameter to true makes words
                // objects instead of strings.
                $replacements[$word] = is_object($suggestion[0]) ? $suggestion[0]->word : $suggestion[0];
            }
            // Replace the keyword with the suggested keyword.
            $suggested_keyword = strtr($keyword, $replacements);

            // Show only if suggestion is different than current query.
            if ($keyword != $suggested_keyword) {
                $suggestions_output[] = $suggested_keyword;
            }
        }
    }

    if (!empty($suggestions_output))
        $search_suggestion = $suggestions_output[0];

    return $search_suggestion;
}

/* * ***********************************************************************
 * Generate XML structure of the total search outcome from SOLR 
 * *********************************************************************** */

function _learninglab_generate_solr_search_cache($results, $keyword) {
    global $base_url;
    global $base_path;

    if (!empty($results)) {
        $result_count = count($results);
        $xml_template = '<GSP>
		<Q>' . $keyword . '</Q>
		<PARAM name="site" value="learning_lab_web" original_value="learning_lab_web"/>
		<PARAM name="q" value="' . $keyword . '" original_value="' . $keyword . '"/>
		<RES SN="1" EN="' . $result_count . '">
		<M>' . $result_count . '</M>';

        $record_no = 1;
        foreach ($results as $result) {
            $link = $base_url . $base_path . $result['link'];
            $xml_template .= '<R N="' . $record_no++ . '" MIME="' . ($result['format-type'] == 'pdf' ? 'application/pdf' : 'text/html') . '">
				<U>' . $link . '</U>
				<UE>' . $link . '</UE>
				<T>' . unwanted_char_remove_xml($result['title']) . '</T>
				<MT N="search-type" V="text"/>
				<MT N="num-references" V="' . $result['num-references'] . '"/>
				<MT N="product" V="' . $result['product'] . '"/>
				<MT N="component-type" V="PDF"/>
				<MT N="last-modified" V="' . $result['last-modified'] . '"/>
				<MT N="browseable" V="yes"/>
				<MT N="format-type" V="' . $result['format-type'] . '"/>
				<MT N="Title" V="' . unwanted_char_remove_xml($result['title']) . '"/>
				<S>' . unwanted_char_remove_xml($result['snippet']) . '</S>
				<LANG>en</LANG>
			</R>';
        }
        $xml_template .= '</RES></GSP>';
        return $xml_template;
    }
    else {
        return;
    }
}

/**
 * Special char removal
 * @param type $data
 * @return type
 */
function unwanted_char_remove_xml($data) {
    $data = strip_tags($data);
    $data = html_entity_decode($result['title']);
    $data = str_ireplace(array('"', "'", '<', '>', '&'), array('&quot;', '&apos;', '&lt;', '&gt;', '&amp;'), $data);
    $data = utf8_encode($data);
    return $data;
}

/**
 * Synonym setting form
 * @param type $form
 * @param type $form_state
 * @return string
 */
function _synonym_settings_form($form, &$form_state) {
    $id = arg(4);
    if (!empty($id)) {
        $synonyms_val = db_query("SELECT synonyms from {synonyms} WHERE id = :id", array(":id" => $id))->fetchField();
    }

    $form['synonyms'] = array(
      '#type' => 'textarea',
      '#title' => t('Enter Synonyms'),
      '#default_value' => $synonyms_val,
      '#description' => t('Enter text in format {~KEYWORD_1~,~SYNONYM_1~,~SYNONYM_2~}'),
    );
    $form['submit'] = array(
      '#type' => 'submit',
      '#value' => t('Submit'),
    );
    return $form;
}

/**
 * Synonym Form submission
 * @param type $form
 * @param type $form_state
 */
function _synonym_settings_form_submit($form, $form_state) {
    $id = arg(4);
    $synonyms = trim($form_state['values']['synonyms']);
    $synonyms = str_replace("{", "", $synonyms);
    $synonyms = str_replace("}", "", $synonyms);
    $synonyms = str_replace("~", "", $synonyms);
    $synonyms = explode(",", $synonyms);
    foreach ($synonyms as $val) {
        $synonymsar[] = "~" . trim($val) . "~";
    }
    $synonyms_val = implode(",", $synonymsar);
    $synonyms_val = "{" . $synonyms_val . "}";
    if (!empty($id)) {
        $update_id = db_update('synonyms')
            ->fields(array('synonyms' => $synonyms_val,))
            ->condition('id', $id, '=')
            ->execute();
    }
    else {
        $update_id = db_insert('synonyms')
            ->fields(array(
              'synonyms' => $synonyms_val,
            ))
            ->execute();
    }
    if (isset($update_id)) {
        drupal_set_message("Successfully Inserted");
        drupal_goto("admin_menu/settings/Projmd/synonym-list");
    }
    //die();  
}

/**
 * Get Synonym list
 * @return string HTML content
 */
function _get_synonym_list() {
    $header = array('Serial No', 'Synonyms', 'Action');
    # set the database table
    $query = db_select('synonyms', 'p')->extend('PagerDefault');
    # get the desired fields from the database
    $query->fields('p', array('id', 'synonyms'))
        ->orderBy('id', 'ASC')
        ->limit(20);
    # execute the query
    $results = $query->execute();
    # build the table fields
    $rows = array();
    $i = 1;
    foreach ($results as $row) {
        $rows[] = array($i++, $row->synonyms, "<a href=\"/admin_menu/settings/Projmd/synonym-settings/" . $row->id . "\">EDIT</a>");
    }
    $output .= '<a href="/admin_menu/settings/Projmd/synonym-settings/">Add New Synonyms</a><br/>';
    $output .= theme('table', array('header' => $header, 'rows' => $rows));
    # add the pager
    $output .= theme('pager');
    return $output;
}

/**
 * Function to implement to get search synonym by keywords 
 * @param type $keyword
 * @return string
 */
function get_search_synonym_by_keyword($keyword = '') {
    $synonyms = str_ireplace("-", " ", $keyword);
    $original_query_term = "~" . $keyword . "~";
    $synonyms_val = db_query("SELECT synonyms from {synonyms} WHERE synonyms LIKE '%" . $original_query_term . "%' ")->fetchField();

    if (!empty($synonyms_val)) {
        $synonyms_val = trim($synonyms_val);
        $synonyms_val = str_ireplace(array("{~", "~}"), "", $synonyms_val);
        $synonyms_arr = explode("~,~", $synonyms_val);

        foreach ($synonyms_arr as $synonym) {
            if ($synonym != $keyword) {
                $synonyms .= ' OR "' . $synonym . '"';
            }
        }
    }
    watchdog('solr-synonym', 'synonym before split =' . $synonyms);
    /* Finding Synonym for words inside the keyword text */
    $keyword_words = preg_split("/[^\w]*([\s]+[^\w]*|$)/", $keyword, -1, PREG_SPLIT_NO_EMPTY);
    if (count($keyword_words) > 1) {
        foreach ($keyword_words as $each_word) {
            $synonyms_val_extra = db_query("SELECT synonyms from {synonyms} WHERE synonyms LIKE '%~" . $each_word . "~%' ")->fetchField();
            if (!empty($synonyms_val_extra)) {
                $synonyms_val_extra = trim($synonyms_val_extra);
                $synonyms_val_extra = str_ireplace(array("{~", "~}"), "", $synonyms_val_extra);
                $synonyms_arr = explode("~,~", $synonyms_val_extra);

                foreach ($synonyms_arr as $synonym) {
                    if ($synonym != $each_word) {
                        $synonyms .= ' OR "' . $synonym . '"';
                    }
                }
            }
        }
    }
    watchdog('solr-synonym', 'synonym final =' . $synonyms);
    return $synonyms;
}

/**
 * Check search keyword against projects
 * @param type $original_query_term
 * @return boolean
 */
function keyword_is_product($original_query_term = '') {
    if (!empty($original_query_term)) {
        $query = new EntityFieldQuery();

        $entities = $query->entityCondition('entity_type', 'node')
            ->propertyCondition('type', 'product_page')
            ->propertyCondition('title', $original_query_term)
            ->propertyCondition('status', 1)
            ->range(0, 1)
            ->execute();

        if (!empty($entities['node'])) {
            return TRUE;
        }
        else {
            return FALSE;
        }
    }
    return FALSE;
}

/**
 * Replace the Reference anchor links with valid links
 * @param type $html
 * @return type
 */
function _learninglab_replace_reference_anchor_links($html) {
    $anchors = replaceHref($html);
    foreach ($anchors as $val) {
        $decodededdval = urldecode($val);
        $html = str_replace($val, $decodededdval, $html);
    }
    return $html;
}

/**
 * Honeypot zero value validation
 * @param type $form
 * @param type $form_state
 */
function _honeypot_zero_value_validate($form, &$form_state) {
    // Get the honeypot field value.
    $honeypot_value = trim($form_state['values']['url']);
    if (isset($honeypot_value) && $honeypot_value == '0') {
        //_honeypot_log($form_state['values']['form_id'], 'honeypot');
        form_set_error('', t('There was a problem with your form submission. Please refresh the page and try again.'));
    }
}

/**
 * Implements hook_form_validation for Tool form to validate conditional fields
 */
function custom_tool_form_validate($form, &$form_state) {

    if (isset($form_state['values']['field_tool_type'][LANGUAGE_NONE][0]['value']) && $form_state['values']['field_tool_type'][LANGUAGE_NONE][0]['value'] == 0) {
        if (empty($form_state['values']['field_external_link_label'][LANGUAGE_NONE][0]['value'])) {
            form_set_error('field_external_link_label', t('@field_name field is required.', array('@field_name' => $form['field_external_link_label'][LANGUAGE_NONE][0]['#title'])));
        }
        if (empty($form_state['values']['field_external_link_url'][LANGUAGE_NONE][0]['value'])) {
            form_set_error('field_external_link_url', t('@field_name field is required.', array('@field_name' => $form['field_external_link_url'][LANGUAGE_NONE][0]['#title'])));
        }
        if (!preg_match("/\b(?:(?:https?|ftp):\/\/|www\.)[-a-z0-9+&@#\/%?=~_|!:,.;]*[-a-z0-9+&@#\/%=~_|]/i", $form_state['values']['field_external_link_url'][LANGUAGE_NONE][0]['value'])) {
            form_set_error('field_external_link_url', t('@field_name is not valid.', array('@field_name' => $form['field_external_link_url'][LANGUAGE_NONE][0]['#title'])));
        }
    }

    if (isset($form_state['values']['field_tool_type'][LANGUAGE_NONE][0]['value']) && $form_state['values']['field_tool_type'][LANGUAGE_NONE][0]['value'] == 1) {
        if (empty($form_state['values']['field_html_link_label'][LANGUAGE_NONE][0]['value'])) {
            form_set_error('field_html_link_label', t('@field_name field is required.', array('@field_name' => $form['field_html_link_label'][LANGUAGE_NONE][0]['#title'])));
        }
        if (in_array('field_file_package_und_0', array_keys($_FILES['files']['name'])) && empty($_FILES['files']['name']['field_file_package_und_0'])) {
            form_set_error('field_file_package', t('@field_name field is required.', array('@field_name' => $form['field_file_package'][LANGUAGE_NONE][0]['#title'])));
        }
    }

    if (isset($form_state['values']['field_tool_type'][LANGUAGE_NONE][0]['value']) && $form_state['values']['field_tool_type'][LANGUAGE_NONE][0]['value'] == 2) {
        if (empty($form_state['values']['field_tool_link_text'][LANGUAGE_NONE][0]['value'])) {
            form_set_error('field_tool_link_text', t('@field_name field is required.', array('@field_name' => $form['field_tool_link_text'][LANGUAGE_NONE][0]['#title'])));
        }

        if (in_array('field_tool_executable_und_0', array_keys($_FILES['files']['name'])) && empty($_FILES['files']['name']['field_tool_executable_und_0'])) {
            form_set_error('field_tool_executable', t('@field_name field is required.', array('@field_name' => $form['field_tool_executable'][LANGUAGE_NONE][0]['#title'])));
        }
    }
    if (isset($form_state['values']['field_tool_category'][LANGUAGE_NONE][0]['value']) && $form_state['values']['field_tool_category'][LANGUAGE_NONE][0]['value'] == 'product-tools') {
        if (empty($form_state['values']['field_external_link_label'][LANGUAGE_NONE][0]['value'])) {
            form_set_error('field_external_link_label', t('@field_name field is required.', array('@field_name' => $form['field_external_link_label'][LANGUAGE_NONE][0]['#title'])));
        }
        if (empty($form_state['values']['field_external_link_url'][LANGUAGE_NONE][0]['value'])) {
            form_set_error('field_external_link_url', t('@field_name field is required.', array('@field_name' => $form['field_external_link_url'][LANGUAGE_NONE][0]['#title'])));
        }
        if (!preg_match("/\b(?:(?:https?|ftp):\/\/|www\.)[-a-z0-9+&@#\/%?=~_|!:,.;]*[-a-z0-9+&@#\/%=~_|]/i", $form_state['values']['field_external_link_url'][LANGUAGE_NONE][0]['value'])) {
            form_set_error('field_external_link_url', t('@field_name is not valid.', array('@field_name' => $form['field_external_link_url'][LANGUAGE_NONE][0]['#title'])));
        }
    }
}

/**
 * This function implements to check a product is digital or non-digital
 *
 */
function is_auto_digital($product_name = '') {
    $query_is_auto_digital = db_select('node', 'n1');
    $query_is_auto_digital->fields('n2', array('field_digital_product_value'));
    $query_is_auto_digital->join('field_data_field_digital_product', 'n2', 'n2.entity_id = n1.nid');
    $query_is_auto_digital->condition('n1.type', 'product_page');
    $query_is_auto_digital->condition('n1.title', $product_name);
    $result_is_auto_digital = $query_is_auto_digital->execute();
    $product_type_info = $result_is_auto_digital->fetchObject();

    if ($product_type_info->field_digital_product_value == 1 || $product_type_info->field_digital_product_value == 3) {
        return TRUE;
    }
    else {
        return FALSE;
    }
}

/**
 * Function to find non-JCR managed contents
 * @param type $nid
 * @return boolean
 */
function not_jcr_managed($nid = 0) {
    $query_is_jcr_managed = db_select('node', 'n3');
    $query_is_jcr_managed->fields('n4', array('field_jcr_managed_value'));
    $query_is_jcr_managed->fields('n5', array('field_product_value'));
    $query_is_jcr_managed->join('field_data_field_jcr_managed', 'n4', 'n4.entity_id = n3.nid');
    $query_is_jcr_managed->join('field_data_field_product', 'n5', 'n5.entity_id = n3.nid');
    $query_is_jcr_managed->condition('n3.type', 'sharepoint_pages');
    $query_is_jcr_managed->condition('n3.nid', $nid);
    $result_is_jcr_managed = $query_is_jcr_managed->execute();
    $jcr_managed_info = $result_is_jcr_managed->fetchObject();
    if ($jcr_managed_info->field_jcr_managed_value == 0) {
        //return TRUE;
        return $jcr_managed_info->field_product_value;
    }
    else {
        return FALSE;
    }
}
